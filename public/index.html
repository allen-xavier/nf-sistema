<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>NF Sistema - Painel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js (local para evitar falhas de CDN em ambiente isolado) -->
    <script src="/chart.umd.min.js"></script>

    <style>
      :root {
        --bg: #f5f5f7;
        --bg-elevated: #ffffff;
        --bg-sidebar: #111827;
        --bg-sidebar-hover: #1f2937;
        --bg-input: #f9fafb;

        --text: #111827;
        --text-muted: #6b7280;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.08);
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #16a34a;
        --warning: #f59e0b;

        --radius: 12px;
        --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      body[data-theme="dark"] {
        --bg: #020617;
        --bg-elevated: #020617;
        --bg-sidebar: #020617;
        --bg-sidebar-hover: #0f172a;
        --bg-input: #020617;

        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --primary: #3b82f6;
        --primary-soft: rgba(59, 130, 246, 0.16);
        --border: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button {
        cursor: pointer;
      }

      .app-shell {
        display: flex;
        min-height: 100vh;
      }

      /* SIDEBAR */

      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        color: #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 16px 12px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
        padding: 8px 10px;
      }

      .sidebar-logo {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }

      .sidebar-title {
        display: flex;
        flex-direction: column;
      }

      .sidebar-title span:first-child {
        font-size: 14px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .sidebar-title span:last-child {
        font-weight: 600;
      }

      .sidebar-nav {
        flex: 1;
      }

      .sidebar-section-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #4b5563;
        padding: 0 10px;
        margin: 12px 0 6px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 10px;
        border-radius: 10px;
        margin: 2px 0;
        color: #9ca3af;
        font-size: 14px;
        transition: background 0.15s ease, color 0.15s ease, transform 0.1s;
      }

      .nav-item span.icon {
        font-size: 16px;
      }

      .nav-item.active {
        background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        color: #f9fafb;
        transform: translateY(-1px);
      }

      .nav-item:hover {
        background: var(--bg-sidebar-hover);
        color: #e5e7eb;
      }

      .sidebar-footer {
        padding: 12px 10px 4px;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
        color: #6b7280;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(15, 23, 42, 0.8);
        padding: 8px 11px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .theme-toggle button {
        border: none;
        background: transparent;
        color: #e5e7eb;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .user-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .user-tag {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #6b7280;
      }

      .btn-logout {
        border-radius: 999px;
        border: 1px solid rgba(239, 68, 68, 0.5);
        background: rgba(127, 29, 29, 0.3);
        padding: 4px 9px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #fecaca;
      }

      /* TOPBAR & MAIN */

      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 100%;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(10px);
        background: color-mix(in srgb, var(--bg) 80%, transparent 20%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 18px;
        border-bottom: 1px solid var(--border);
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mobile-menu-btn {
        display: none;
        border: none;
        background: var(--bg-elevated);
        border-radius: 999px;
        padding: 6px 9px;
        box-shadow: var(--shadow-soft);
      }

      .topbar-title {
        font-weight: 600;
        font-size: 15px;
      }

      .topbar-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chip {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--primary-soft);
        color: var(--primary);
        font-size: 11px;
        border: 1px solid rgba(37, 99, 235, 0.24);
      }

      .content {
        padding: 16px 18px 24px;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      /* CARDS & PANELS */

      .card {
        background: var(--bg-elevated);
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        padding: 16px;
        border: 1px solid var(--border);
      }

      .card + .card {
        margin-top: 12px;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .card-title {
        font-weight: 600;
        font-size: 15px;
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .badge {
        border-radius: 999px;
        padding: 3px 7px;
        font-size: 11px;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }

      .grid {
        display: grid;
        gap: 12px;
      }

      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      /* Para quando mostrar um √∫nico bloco POS ocupar largura total */
      .pos-single {
        grid-column: 1 / -1;
      }

      @media (max-width: 900px) {
        .grid-3,
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .metric-card {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, var(--primary-soft), transparent 55%);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .metric-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-value {
        font-size: 20px;
        font-weight: 600;
      }

      .metric-detail {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* FORMS & INPUTS */

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 140px;
      }

      label {
        font-size: 11px;
        margin-bottom: 4px;
        color: var(--text-muted);
      }

      input,
      select {
        padding: 7px 9px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-input);
        color: var(--text);
        font-size: 13px;
      }

      input:focus,
      select:focus {
        outline: 2px solid var(--primary-soft);
        border-color: var(--primary);
      }

      .btn-primary {
        border-radius: 8px;
        border: none;
        background: var(--primary);
        color: white;
        padding: 8px 14px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-secondary {
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        padding: 7px 12px;
        font-size: 13px;
      }

      .btn-danger {
        border-radius: 8px;
        border: none;
        background: var(--danger);
        color: white;
        padding: 6px 10px;
        font-size: 12px;
      }

      .btn-ghost {
        border-radius: 8px;
        border: none;
        background: transparent;
        padding: 6px 8px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .toolbar-left,
      .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chip-filter {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        cursor: pointer;
      }

      .chip-filter.active {
        background: var(--primary-soft);
        color: var(--primary);
        border-color: rgba(37, 99, 235, 0.5);
      }

      /* TABLES */

      .table-wrapper {
        margin-top: 8px;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: auto;
        max-height: 480px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: color-mix(in srgb, var(--bg-elevated) 80%, var(--border) 20%);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }

      tbody tr:hover {
        background: color-mix(in srgb, var(--bg-elevated) 80%, var(--primary-soft) 20%);
      }

      .status-pill {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .status-emitida {
        background: rgba(59, 130, 246, 0.08);
        color: #1d4ed8;
      }

      .status-paga {
        background: rgba(22, 163, 74, 0.09);
        color: #15803d;
      }

      .status-cancelada {
        background: rgba(239, 68, 68, 0.09);
        color: #b91c1c;
      }

      .tag {
        font-size: 11px;
        padding: 3px 7px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }

      .tag-success {
        background: rgba(22, 163, 74, 0.08);
        color: #16a34a;
        border-color: rgba(22, 163, 74, 0.5);
      }

      .tag-muted {
        color: var(--text-muted);
      }

      /* INFINITE SCROLL STATE */

      .loader-row {
        text-align: center;
        padding: 10px;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* LOGIN OVERLAY */

      .overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.2), transparent 50%),
          radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.18), transparent 50%),
          var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .login-card {
        width: 100%;
        max-width: 380px;
        background: var(--bg-elevated);
        border-radius: 18px;
        padding: 20px 18px 18px;
        box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
        border: 1px solid var(--border);
      }

      .login-title {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 4px;
      }

      .login-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 14px;
      }

      .login-footer {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: var(--text-muted);
      }

      .link {
        color: var(--primary);
        cursor: pointer;
      }

      .error-text {
        font-size: 12px;
        color: var(--danger);
        margin-top: 6px;
      }

      .success-text {
        font-size: 12px;
        color: var(--success);
        margin-top: 6px;
      }

      /* SECTIONS VISIBILITY */

      .page-section {
        display: none;
      }

      .page-section.active {
        display: block;
      }

      /* RELAT√ìRIOS TABS */

      .tabs {
        display: inline-flex;
        border-radius: 999px;
        padding: 3px;
        background: color-mix(in srgb, var(--bg-elevated) 70%, var(--border) 30%);
        border: 1px solid var(--border);
        gap: 3px;
      }

      .tab-button {
        border: none;
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 12px;
        background: transparent;
        color: var(--text-muted);
      }

      .tab-button.active {
        background: var(--bg-elevated);
        color: var(--primary);
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      }

      .rel-subsection {
        margin-top: 14px;
      }

      .rel-subsection.hidden {
        display: none;
      }

      /* MOBILE SIDEBAR */

      @media (max-width: 900px) {
        .sidebar {
          position: fixed;
          inset: 0 auto 0 0;
          transform: translateX(-100%);
          transition: transform 0.2s ease;
          z-index: 50;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .sidebar-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(4px);
          z-index: 40;
          display: none;
        }

        .sidebar-backdrop.show {
          display: block;
        }

        .mobile-menu-btn {
          display: inline-flex;
        }
      }
    </style>
  </head>
  <body data-theme="light">
    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="overlay">
      <div class="login-card">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px">
          <div
            style="
              width: 32px;
              height: 32px;
              border-radius: 999px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: linear-gradient(135deg, #2563eb, #6366f1);
              color: white;
              font-weight: 700;
            "
          >
            NF
          </div>
          <div>
            <div class="login-title">NF Sistema</div>
            <div class="login-subtitle">Acesso ao painel administrativo</div>
          </div>
        </div>

        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="loginEmail" placeholder="admin@exemplo.com" />
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" id="loginPassword" placeholder="Sua senha" />
        </div>
        <div id="loginError" class="error-text" style="display: none"></div>

        <button id="btnLogin" class="btn-primary" style="width: 100%; margin-top: 10px">
          Entrar
        </button>

        <div class="login-footer">
          <span class="link" id="forgotPasswordLink">Esqueci minha senha</span>
          <span>¬© NF Sistema</span>
        </div>

        <div id="forgotInfo" class="success-text" style="display: none"></div>
      </div>
    </div>

    <!-- APP SHELL -->
    <div class="app-shell" id="appShell" style="display: none">
      <!-- SIDEBAR -->
      <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">NF</div>
          <div class="sidebar-title">
            <span>Painel</span>
            <span>NF Sistema</span>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="sidebar-section-label">Visao Geral</div>
          <div class="nav-item" data-page="dashboard">
            <span class="icon">‚Ä¢</span>
            <span>Dashboard</span>
          </div>

          <div class="sidebar-section-label">Nota Fiscal</div>
          <div class="nav-item" data-page="clientes">
            <span class="icon">‚Ä¢</span>
            <span>Clientes</span>
          </div>
          <div class="nav-item" data-page="empresas">
            <span class="icon">‚Ä¢</span>
            <span>Empresas</span>
          </div>
          <div class="nav-item" data-page="notas">
            <span class="icon">‚Ä¢</span>
            <span>Notas Fiscais</span>
          </div>
          <div class="nav-item" data-page="relatorios">
            <span class="icon">‚Ä¢</span>
            <span>Relatorios</span>
          </div>

          <div class="sidebar-section-label">Maquininhas</div>
          <div class="nav-item" data-page="pos-empresas">
            <span class="icon">‚Ä¢</span>
            <span>Empresas POS</span>
          </div>
          <div class="nav-item" data-page="pos-terminais">
            <span class="icon">‚Ä¢</span>
            <span>Terminais</span>
          </div>
          <div class="nav-item" data-page="pos-clientes">
            <span class="icon">‚Ä¢</span>
            <span>Clientes POS</span>
          </div>
          <div class="nav-item" data-page="pos-vendas">
            <span class="icon">‚Ä¢</span>
            <span>Vendas</span>
          </div>
          <div class="nav-item" data-page="pos-resumo">
            <span class="icon">‚Ä¢</span>
            <span>Resumo POS</span>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="theme-toggle">
            <div style="display: flex; flex-direction: column; gap: 2px">
              <span style="font-size: 11px; color: #9ca3af">Tema</span>
              <span style="font-size: 12px">Claro / Escuro</span>
            </div>
            <button id="btnThemeToggle">üåì</button>
          </div>

          <div class="user-info">
            <div>
              <div class="user-tag">Usu√°rio logado</div>
              <div id="currentUserEmail" style="font-size: 12px">‚Äî</div>
            </div>
            <button class="btn-logout" id="btnLogout">Sair</button>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main" id="main">
        <header class="topbar">
          <div class="topbar-left">
            <button class="mobile-menu-btn" id="btnMobileMenu">‚ò∞</button>
            <div>
              <div class="topbar-title" id="topbarTitle">Dashboard</div>
              <div class="topbar-subtitle" id="topbarSubtitle">
                Vis√£o geral das notas fiscais, clientes e empresas
              </div>
            </div>
          </div>
          <div class="topbar-right">
            <div class="chip">Produ√ß√£o</div>
          </div>
        </header>

        <section class="content">
          <!-- DASHBOARD -->
          <section id="page-dashboard" class="page-section active">
            <div class="grid grid-3">
              <div class="card metric-card">
                <div class="metric-label">Total de notas</div>
                <div class="metric-value" id="dashTotalNotas">‚Äî</div>
                <div class="metric-detail">
                  Soma de todas as notas emitidas no per√≠odo selecionado
                </div>
              </div>
              <div class="card metric-card">
                <div class="metric-label">Valor total</div>
                <div class="metric-value" id="dashValorTotal">‚Äî</div>
                <div class="metric-detail">
                  Considerando notas emitidas (EMITIDA + PAGA)
                </div>
              </div>
              <div class="card metric-card">
                <div class="metric-label">Total taxas</div>
                <div class="metric-value" id="dashTaxas">‚Äî</div>
                <div class="metric-detail">Com base na comiss√£o configurada dos clientes</div>
              </div>
            </div>

            <div class="grid grid-2" style="margin-top: 14px">
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Notas por dia (√∫ltimos 30 dias)</div>
                    <div class="card-subtitle">Volume di√°rio de emiss√µes</div>
                  </div>
                  <span class="badge">Linhas</span>
                </div>
                <canvas id="chartNotasDia"></canvas>
              </div>

              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Status das notas</div>
                    <div class="card-subtitle">Distribui√ß√£o por status atual</div>
                  </div>
                  <span class="badge">Pizza</span>
                </div>
                <canvas id="chartStatus"></canvas>
              </div>
            </div>
          </section>

          <!-- CLIENTES -->
          <section id="page-clientes" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Clientes</div>
                  <div class="card-subtitle">
                    Cadastro de clientes identificados por WhatsApp e taxa de comiss√£o
                  </div>
                </div>
                <button id="btnAddCliente" class="btn-primary">+ Adicionar cliente</button>
              </div>

              <div class="toolbar">
                <div class="toolbar-left">
                  <div class="form-group" style="min-width: 180px">
                    <label>Buscar por nome ou WhatsApp</label>
                    <input
                      type="text"
                      id="clienteSearch"
                      placeholder="Digite para filtrar..."
                    />
                  </div>
                  <div class="form-group" style="max-width: 140px">
                    <label>Comiss√£o m√≠nima (%)</label>
                    <input type="number" id="clienteFeeMin" step="0.01" />
                  </div>
                  <div class="form-group" style="max-width: 140px">
                    <label>Comiss√£o m√°xima (%)</label>
                    <input type="number" id="clienteFeeMax" step="0.01" />
                  </div>
                </div>
                <div class="toolbar-right">
                  <span class="chip-filter active" data-cliente-ativo="all">Todos</span>
                  <span class="chip-filter" data-cliente-ativo="true">Ativos</span>
                  <span class="chip-filter" data-cliente-ativo="false">Inativos</span>
                </div>
              </div>

              <!-- FORM CLIENTE -->
              <div id="clienteFormWrapper" style="display: none; margin-bottom: 10px">
                <div
                  style="
                    padding: 10px;
                    border-radius: 12px;
                    border: 1px dashed var(--border);
                    background: color-mix(
                      in srgb,
                      var(--primary-soft) 25%,
                      var(--bg-elevated) 75%
                    );
                  "
                >
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nome do cliente</label>
                      <input type="text" id="clienteNome" />
                    </div>
                    <div class="form-group">
                      <label>WhatsApp</label>
                      <input type="text" id="clienteWhats" placeholder="+55..." />
                    </div>
                    <div class="form-group" style="max-width: 140px">
                      <label>Taxa (%)</label>
                      <input type="number" id="clienteTaxa" step="0.01" />
                    </div>
                    <div class="form-group" style="max-width: 120px">
                      <label>Status</label>
                      <select id="clienteAtivo">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group checkbox">
                      <label><input type="checkbox" id="clienteUsaNF" checked /> Ativo para Nota Fiscal</label>
                    </div>
                    <div class="form-group checkbox">
                      <label><input type="checkbox" id="clienteUsaPOS" /> Ativo no POS</label>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: flex-end; gap: 8px">
                    <button id="btnCancelCliente" class="btn-secondary">Cancelar</button>
                    <button id="btnSaveCliente" class="btn-primary">Salvar</button>
                  </div>
                  <div id="clienteFormError" class="error-text" style="display: none"></div>
                </div>
              </div>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome</th>
                      <th>WhatsApp</th>
                      <th>Taxa (%)</th>
                      <th>Status</th>
                      <th>Criado em</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="clientesTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- EMPRESAS -->
          <section id="page-empresas" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Empresas emissoras</div>
                  <div class="card-subtitle">
                    Cadastro das empresas autorizadas a emitir notas fiscais
                  </div>
                </div>
                <button id="btnAddEmpresa" class="btn-primary">+ Adicionar empresa</button>
              </div>

              <div class="toolbar">
                <div class="toolbar-left">
                  <div class="form-group" style="min-width: 180px">
                    <label>Nome / CNPJ</label>
                    <input
                      type="text"
                      id="empresaSearch"
                      placeholder="Digite parte do nome ou CNPJ..."
                    />
                  </div>
                </div>
                <div class="toolbar-right">
                  <span class="chip-filter active" data-empresa-ativo="all">Todas</span>
                  <span class="chip-filter" data-empresa-ativo="true">Ativas</span>
                  <span class="chip-filter" data-empresa-ativo="false">Inativas</span>
                </div>
              </div>

              <!-- FORM EMPRESA -->
              <div id="empresaFormWrapper" style="display: none; margin-bottom: 10px">
                <div
                  style="
                    padding: 10px;
                    border-radius: 12px;
                    border: 1px dashed var(--border);
                    background: color-mix(
                      in srgb,
                      var(--primary-soft) 25%,
                      var(--bg-elevated) 75%
                    );
                  "
                >
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nome da empresa</label>
                      <input type="text" id="empresaNome" />
                    </div>
                    <div class="form-group">
                      <label>CNPJ</label>
                      <input type="text" id="empresaCnpj" />
                    </div>
                    <div class="form-group">
                      <label>Chave de acesso</label>
                      <input type="text" id="empresaChave" />
                    </div>
                    <div class="form-group" style="max-width: 120px">
                      <label>Status</label>
                      <select id="empresaAtiva">
                        <option value="true">Ativa</option>
                        <option value="false">Inativa</option>
                      </select>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: flex-end; gap: 8px">
                    <button id="btnCancelEmpresa" class="btn-secondary">Cancelar</button>
                    <button id="btnSaveEmpresa" class="btn-primary">Salvar</button>
                  </div>
                  <div id="empresaFormError" class="error-text" style="display: none"></div>
                </div>
              </div>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome</th>
                      <th>CNPJ</th>
                      <th>Status</th>
                      <th>Criada em</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="empresasTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- NOTAS -->
          <section id="page-notas" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Notas fiscais</div>
                  <div class="card-subtitle">
                    Listagem com carregamento autom√°tico (scroll infinito)
                  </div>
                </div>
              </div>

              <div class="toolbar">
                <div class="toolbar-left">
                  <div class="form-group">
                    <label>Buscar por cliente / empresa / comprador / CPF</label>
                    <input
                      type="text"
                      id="notasSearch"
                      placeholder="Nome, empresa ou CPF do comprador"
                    />
                  </div>
                  <div class="form-group" style="max-width: 160px">
                    <label>Status</label>
                    <select id="notasStatusFilter">
                      <option value="all">Todos</option>
                      <option value="EMITIDA">Emitida</option>
                      <option value="PAGA">Paga</option>
                      <option value="CANCELADA">Cancelada</option>
                    </select>
                  </div>
                  <div class="form-group" style="max-width: 160px">
                    <label>Origem</label>
                    <select id="notasOrigemFilter">
                      <option value="all">Todas</option>
                      <option value="terminal">Maquininha</option>
                      <option value="manual">Manual</option>
                    </select>
                  </div>
                </div>

                <div class="toolbar-right">
                  <div class="form-group" style="max-width: 140px">
                    <label>Data inicial</label>
                    <input type="date" id="notasDataIni" />
                  </div>
                  <div class="form-group" style="max-width: 140px">
                    <label>Data final</label>
                    <input type="date" id="notasDataFim" />
                  </div>
                  <button id="notasApplyFilters" class="btn-secondary">Aplicar filtros</button>
                  <button id="notasClearFilters" class="btn-secondary">Limpar filtros</button>
                </div>
              </div>

              <div class="table-wrapper" id="notasTableWrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Data emiss√£o</th>
                      <th>Cliente</th>
                      <th>Empresa</th>
                      <th>Comprador</th>
                      <th>CPF comprador</th>
                      <th>Valor total</th>
                      <th>Valor pago</th>
                      <th>Taxa (%)</th>
                      <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal</th>
                      <th>NSU</th>
                      <th>NF-e</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="notasTableBody"></tbody>
                </table>
                <div id="notasLoaderRow" class="loader-row">
                  <span id="notasLoaderText">Rolando para carregar mais‚Ä¶</span>
                </div>
              </div>
            </div>
          </section>          <!-- MAQUININHAS -->
          <section id="page-pos-empresas" class="page-section">
            <div class="card pos-block">
              <div class="card-header">
                <div>
                  <div class="card-title">Empresas POS</div>
                  <div class="card-subtitle">Adquirentes da maquininha</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Nome</label><input id="posCompanyName" /></div>
                <div class="form-group"><label>CNPJ</label><input id="posCompanyCnpj" /></div>
                <div class="form-group" style="max-width:140px"><label>Status</label><select id="posCompanyAtiva"><option value="true">Ativa</option><option value="false">Inativa</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Buscar (nome/CNPJ)</label><input id="posCompanySearch" placeholder="Filtrar" /></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparCompany" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosAddCompany">Salvar empresa</button>
              <div class="table-wrapper" style="max-height:200px; margin-top:10px">
                <table><thead><tr><th>ID</th><th>Nome</th><th>CNPJ</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="posCompaniesTableBody"></tbody></table>
              </div>
            </div>
          </section>

          <section id="page-pos-terminais" class="page-section">
            <div class="card pos-block">
              <div class="card-header">
                <div>
                  <div class="card-title">Terminais</div>
                  <div class="card-subtitle">Vincule empresa e cliente</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Empresa</label><select id="posTerminalEmpresa"></select></div>
                <div class="form-group"><label>Cliente</label><select id="posTerminalCliente"></select></div>
                <div class="form-group"><label>Codigo</label><input id="posTerminalCode" /></div>
                <div class="form-group" style="max-width:140px"><label>Status</label><select id="posTerminalAtivo"><option value="true">Ativo</option><option value="false">Inativo</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Buscar terminal / empresa / cliente</label><input id="posTerminalSearch" placeholder="Filtrar" /></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparTerminal" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosAddTerminal">Salvar terminal</button>
              <div class="table-wrapper" style="max-height:200px; margin-top:10px">
                <table><thead><tr><th>ID</th><th>Terminal</th><th>Empresa</th><th>Cliente</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="posTerminalsTableBody"></tbody></table>
              </div>
            </div>
          </section>

          <section id="page-pos-clientes" class="page-section">
            <div class="card pos-block">
              <div class="card-header"><div><div class="card-title">Clientes POS</div><div class="card-subtitle">Cadastro rapido com taxas e PIX</div></div></div>
              <div class="form-row">
                <div class="form-group"><label>Busca cliente (nome/Whats)</label><input id="posCliSearch" placeholder="Buscar" /></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosNovoCliente" style="width:100%">Novo / limpar</button></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Nome</label><input id="posCliNome" /></div>
                <div class="form-group"><label>WhatsApp (unico)</label><input id="posCliWhats" /></div>
                <div class="form-group"><label>PIX</label><input id="posCliPix" /></div>
              </div>
              <div class="form-row">
                <div class="form-group checkbox"><label><input type="checkbox" id="posCliAtivo" checked /> Ativo no POS</label></div>
                <div class="form-group checkbox"><label><input type="checkbox" id="posCliUsaNF" /> Ativo para Nota Fiscal</label></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Debito (%)</label><input id="posCliDeb" type="number" step="0.01" /></div>
                <div class="form-group"><label>Credito a vista (%)</label><input id="posCliCredAv" type="number" step="0.01" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Credito 2 a 6x (%)</label><input id="posCliCred2a6" type="number" step="0.01" /></div>
                <div class="form-group"><label>Credito 7 a 12x (%)</label><input id="posCliCred7a12" type="number" step="0.01" /></div>
              </div>
              <button class="btn-primary" id="btnPosSalvarCliente">Salvar cliente</button>
              <div class="table-wrapper" style="max-height: 220px; margin-top:10px">
                <table>
                  <thead>
                    <tr><th>ID</th><th>Nome</th><th>Whats</th><th>POS</th><th>NF</th><th>Deb</th><th>Cred av</th><th>2-6x</th><th>7-12x</th><th>PIX</th></tr>
                  </thead>
                  <tbody id="posClientesTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="page-pos-vendas" class="page-section">
              <div class="card pos-block">
              <div class="card-header"><div><div class="card-title">Registrar venda</div><div class="card-subtitle">Terminal, data/hora, valor, forma, NSU</div></div></div>
              <div class="form-row">
                <div class="form-group"><label>Buscar terminal/cliente</label><input id="posVendaTerminalSearch" placeholder="Filtrar" /></div>
                <div class="form-group"><label>Terminal</label><select id="posVendaTerminal"></select></div>
                <div class="form-group"><label>Data/hora</label><input id="posVendaData" type="datetime-local" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Valor</label><input id="posVendaValor" type="number" step="0.01" /></div>
                <div class="form-group"><label>Forma</label><select id="posVendaForma"><option value="DEBITO">Debito</option><option value="CREDITO_AVISTA">Credito a vista</option><option value="CREDITO_2A6">Credito 2 a 6x</option><option value="CREDITO_7A12">Credito 7 a 12x</option><option value="PIX">PIX</option></select></div>
                <div class="form-group"><label>NSU</label><input id="posVendaNsu" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparVenda" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosRegistrarVenda">Salvar venda</button>
              <div id="posVendaMsg" class="success-text" style="display:none; margin-top:8px"></div>
            </div>
            <div class="card pos-block" style="margin-top: 12px">
              <div class="card-header"><div><div class="card-title">Vendas recentes</div><div class="card-subtitle">Ultimas 50 vendas</div></div></div>
              <div class="table-wrapper" style="max-height: 220px">
                <table>
                  <thead><tr><th>Data</th><th>Cliente</th><th>Terminal</th><th>Forma</th><th>Bruto</th><th>Taxa</th><th>Liquido</th><th>Acoes</th></tr></thead>
                  <tbody id="posVendasTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="page-pos-resumo" class="page-section">
            <div class="card pos-block">
              <div class="card-header"><div><div class="card-title">Resumo POS</div><div class="card-subtitle">Bruto, liquido, taxas</div></div><button class="btn-secondary" id="btnPosCarregarResumo">Atualizar</button></div>
              <div class="form-row" style="margin-bottom:8px">
                <div class="form-group"><label>Data inicial</label><input id="posResumoIni" type="date" /></div>
                <div class="form-group"><label>Data final</label><input id="posResumoFim" type="date" /></div>
              </div>
              <div class="grid grid-2">
                <div class="metric-card"><div class="metric-label">Bruto</div><div class="metric-value" id="posResumoBruto">?</div></div>
                <div class="metric-card"><div class="metric-label">Liquido</div><div class="metric-value" id="posResumoLiquido">?</div></div>
              </div>
              <div class="metric-card" style="margin-top:10px"><div class="metric-label">Taxas</div><div class="metric-value" id="posResumoTaxas">?</div></div>
              <div style="margin-top:10px; font-size:13px; display:flex; flex-direction:column; gap:6px">
                <div><strong>Top cliente periodo:</strong> <span id="posResumoTopCliente">?</span></div>
                <div><strong>Top cliente hoje:</strong> <span id="posResumoTopDia">?</span></div>
                <div><strong>Maior venda:</strong> <span id="posResumoMaiorVenda">?</span></div>
              </div>
            </div>
          </section>

          <section id="page-relatorios" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Relat√≥rios</div>
                  <div class="card-subtitle">
                    Vis√£o consolidada por per√≠odo, cliente e empresa
                  </div>
                </div>
                <div class="tabs">
                  <button
                    class="tab-button active"
                    data-rel-tab="geral"
                    id="tabRelGeral"
                  >
                    Vis√£o geral
                  </button>
                  <button class="tab-button" data-rel-tab="cliente" id="tabRelCliente">
                    Por cliente
                  </button>
                  <button class="tab-button" data-rel-tab="empresa" id="tabRelEmpresa">
                    Por empresa
                  </button>
                </div>
              </div>

              <!-- VIS√ÉO GERAL -->
              <div
                class="rel-subsection"
                id="relGeralSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relDataFim" />
                    </div>
                    <div class="form-group">
                      <label>Agrupar por</label>
                      <select id="relGroupBy">
                        <option value="day">Dia</option>
                        <option value="month">M√™s</option>
                      </select>
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnReloadReports" class="btn-secondary">
                      Atualizar relat√≥rios
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Notas no per√≠odo</div>
                    <div class="metric-value" id="relTotalNotas">‚Äî</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Valor total (R$)</div>
                    <div class="metric-value" id="relValorTotal">‚Äî</div>
                    <div class="metric-detail">Soma do valor total das notas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Taxas totais (R$)</div>
                    <div class="metric-value" id="relTaxasTotal">‚Äî</div>
                    <div class="metric-detail">
                      Somat√≥rio das taxas cobradas dos clientes
                    </div>
                  </div>
                </div>

                <div class="grid grid-2" style="margin-top: 14px">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas por per√≠odo</div>
                        <div class="card-subtitle">Agrupado por dia ou m√™s</div>
                      </div>
                    </div>
                    <canvas id="chartRelPeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Top cliente / empresa</div>
                        <div class="card-subtitle">
                          Maior n√∫mero de notas e maior volume financeiro
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px">
                      <div>
                        <span class="tag tag-muted">Cliente com mais notas</span>
                        <div id="relTopCliente" style="margin-top: 4px">‚Äî</div>
                      </div>
                      <div>
                        <span class="tag tag-muted">Empresa com maior volume</span>
                        <div id="relTopEmpresa" style="margin-top: 4px">‚Äî</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- POR CLIENTE -->
              <div
                class="rel-subsection hidden"
                id="relClienteSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Buscar cliente</label>
                      <input
                        type="text"
                        id="relClienteSearch"
                        placeholder="Nome ou WhatsApp"
                      />
                    </div>
                    <div class="form-group">
                      <label>Cliente</label>
                      <select id="relClienteSelect">
                        <option value="">Selecione um cliente</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relClienteDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relClienteDataFim" />
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnRelClienteGerar" class="btn-secondary">
                      Gerar relat√≥rio por cliente
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Cliente</div>
                    <div class="metric-value" id="relClienteNome">‚Äî</div>
                    <div class="metric-detail" id="relClienteWhats">WhatsApp: ‚Äî</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Notas no per√≠odo</div>
                    <div class="metric-value" id="relClienteTotalNotas">‚Äî</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Total faturado / Taxas</div>
                    <div class="metric-detail">
                      Faturamento: <span id="relClienteValorTotal">‚Äî</span>
                    </div>
                    <div class="metric-detail">
                      Taxas: <span id="relClienteTaxasTotal">‚Äî</span>
                    </div>
                  </div>
                </div>

                <div class="grid grid-2 rel-subsection">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas do cliente por per√≠odo</div>
                        <div class="card-subtitle">Volume di√°rio/mensal</div>
                      </div>
                    </div>
                    <canvas id="chartRelClientePeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas por empresa</div>
                        <div class="card-subtitle">
                          Empresas que mais emitiram para este cliente
                        </div>
                      </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 260px">
                      <table>
                        <thead>
                          <tr>
                            <th>Empresa</th>
                            <th>Notas</th>
                            <th>Valor total</th>
                          </tr>
                        </thead>
                        <tbody id="relClienteEmpresasBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="card rel-subsection">
                  <div class="card-header">
                    <div>
                      <div class="card-title">Notas do cliente</div>
                      <div class="card-subtitle">
                        Lista completa das notas dentro do per√≠odo
                      </div>
                    </div>
                  </div>
                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Emiss√£o</th>
                          <th>Empresa</th>
                          <th>Valor total</th>
                          <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal / NSU</th>
                      <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="relClienteNotasBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- POR EMPRESA -->
              <div
                class="rel-subsection hidden"
                id="relEmpresaSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Buscar empresa</label>
                      <input
                        type="text"
                        id="relEmpresaSearch"
                        placeholder="Nome ou CNPJ"
                      />
                    </div>
                    <div class="form-group">
                      <label>Empresa</label>
                      <select id="relEmpresaSelect">
                        <option value="">Selecione uma empresa</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Status</label>
                      <select id="relEmpresaAtivo">
                        <option value="all">Todas</option>
                        <option value="true">Ativas</option>
                        <option value="false">Inativas</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relEmpresaDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relEmpresaDataFim" />
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnRelEmpresaGerar" class="btn-secondary">
                      Gerar relat√≥rio por empresa
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Empresa</div>
                    <div class="metric-value" id="relEmpresaNome">‚Äî</div>
                    <div class="metric-detail" id="relEmpresaCnpj">CNPJ: ‚Äî</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Notas no per√≠odo</div>
                    <div class="metric-value" id="relEmpresaTotalNotas">‚Äî</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Total faturado</div>
                    <div class="metric-value" id="relEmpresaValorTotal">‚Äî</div>
                    <div class="metric-detail">Somat√≥rio das notas da empresa</div>
                  </div>
                </div>

                <div class="grid grid-2 rel-subsection">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas da empresa por per√≠odo</div>
                        <div class="card-subtitle">Volume di√°rio/mensal</div>
                      </div>
                    </div>
                    <canvas id="chartRelEmpresaPeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Clientes desta empresa</div>
                        <div class="card-subtitle">
                          Clientes que mais emitiram por esta empresa
                        </div>
                      </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 260px">
                      <table>
                        <thead>
                          <tr>
                            <th>Cliente</th>
                            <th>Notas</th>
                            <th>Valor total</th>
                          </tr>
                        </thead>
                        <tbody id="relEmpresaClientesBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="card rel-subsection">
                  <div class="card-header">
                    <div>
                      <div class="card-title">Notas da empresa</div>
                      <div class="card-subtitle">
                        Lista completa das notas dentro do per√≠odo
                      </div>
                    </div>
                  </div>
                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Emiss√£o</th>
                          <th>Cliente</th>
                          <th>Valor total</th>
                          <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal / NSU</th>
                      <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="relEmpresaNotasBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </section>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
      // ==========================
      // THEME
      // ==========================
      function applyTheme(theme) {
        document.body.setAttribute("data-theme", theme);
        localStorage.setItem("nf_theme", theme);
      }

      const savedTheme = localStorage.getItem("nf_theme") || "light";
      applyTheme(savedTheme);

      // ==========================
      // AUTH / API
      // ==========================
      let authToken = localStorage.getItem("nf_token") || null;
      let currentUser = null;

      async function apiFetch(path, options = {}) {
        const headers = options.headers || {};
        headers["Content-Type"] = "application/json";
        if (authToken) {
          headers["Authorization"] = "Bearer " + authToken;
        }

        const res = await fetch(path, {
          ...options,
          headers,
        });

        if (res.status === 401) {
          showLogin();
          throw new Error("N√£o autorizado");
        }

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Erro na API");
        }

        return res.json();
      }

      function showLogin() {
        document.getElementById("loginOverlay").style.display = "flex";
        document.getElementById("appShell").style.display = "none";
      }

      function showApp() {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("appShell").style.display = "flex";
      }

      async function doLogin() {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const errorEl = document.getElementById("loginError");
        errorEl.style.display = "none";

        try {
          const data = await apiFetch("/api/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
            headers: { "Content-Type": "application/json" },
          });

          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem("nf_token", authToken);
          localStorage.setItem("nf_user_email", currentUser.email);

          document.getElementById("currentUserEmail").textContent = currentUser.email;

          showApp();
          selectPage("dashboard");
          loadDashboard();
          loadClientes();
          loadEmpresas();
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Credenciais inv√°lidas.";
          errorEl.style.display = "block";
        }

      function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem("nf_token");
        showLogin();
      }

      async function sendForgotPassword() {
        const email = document.getElementById("loginEmail").value.trim();
        const infoEl = document.getElementById("forgotInfo");
        const errorEl = document.getElementById("loginError");
        errorEl.style.display = "none";
        infoEl.style.display = "none";

        if (!email) {
          errorEl.textContent = "Informe seu e-mail para recuperar a senha.";
          errorEl.style.display = "block";
          return;
        }

        try {
          await fetch("/api/auth/forgot-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          infoEl.textContent =
            "Se o e-mail estiver cadastrado, um link de recupera√ß√£o foi enviado.";
          infoEl.style.display = "block";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Erro ao solicitar recupera√ß√£o de senha.";
          errorEl.style.display = "block";
        }
      }

      // ==========================
      // NAV / PAGES
      // ==========================

      document.querySelectorAll('.nav-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const page = item.getAttribute('data-page');
          if (page) selectPage(page);
        });
      });
      function selectPage(page, anchor) {
        // mostra apenas a se√ß√£o selecionada
        document.querySelectorAll(".page-section").forEach((sec) => sec.classList.remove("active"));
        const pageEl = document.getElementById("page-" + page);
        if (pageEl) pageEl.classList.add("active");

        // marca item ativo no menu
        document.querySelectorAll(".nav-item").forEach((item) => item.classList.remove("active"));
        document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add("active");

        // textos topbar
        const topbarTitle = document.getElementById("topbarTitle");
        const topbarSubtitle = document.getElementById("topbarSubtitle");

        if (page === "dashboard") {
          topbarTitle.textContent = "Dashboard";
          topbarSubtitle.textContent = "Visao geral das notas fiscais, clientes e empresas";
        } else if (page === "clientes") {
          topbarTitle.textContent = "Clientes";
          topbarSubtitle.textContent = "Gestao de clientes identificados por WhatsApp";
        } else if (page === "empresas") {
          topbarTitle.textContent = "Empresas emissoras";
          topbarSubtitle.textContent = "Configuracao das empresas que podem emitir notas";
        } else if (page === "notas") {
          topbarTitle.textContent = "Notas fiscais";
          topbarSubtitle.textContent = "Listagem das notas emitidas com carregamento automatico";
        } else if (page.startsWith("pos")) {
          topbarTitle.textContent = "Maquininhas";
          topbarSubtitle.textContent = "Empresas, terminais, taxas e vendas de POS";
        } else if (page === "relatorios") {
          topbarTitle.textContent = "Relatorios";
          topbarSubtitle.textContent = "Analises consolidadas por periodo, cliente e empresa";
          loadClientes().then(populateRelatorioSelects);
          loadEmpresas().then(populateRelatorioSelects);
          loadRelatorios?.();
        }

        // a??es ao entrar em p?ginas
        if (page === "notas") {
          resetNotasInfiniteScroll();
          loadNotasPage(true);
        }
        if (page === "clientes") {
          loadClientes();
        }
        if (page === "empresas") {
          loadEmpresas();
        }
        if (page === "relatorios") {
          loadClientes().then(populateRelatorioSelects);
          loadEmpresas().then(populateRelatorioSelects);
        }
        if (page.startsWith("pos")) {
          // p?ginas POS independentes
          loadPosClientes();
          loadPosCompanies();
          loadPosTerminals();
          loadPosVendasRecentes();
          loadPosResumo();
        }
      }

      // ==========================
      // DASHBOARD / REPORTS
      // ==========================
      let chartNotasDia = null;
      let chartStatus = null;
      let chartRelPeriodo = null;
      let chartRelClientePeriodo = null;
      let chartRelEmpresaPeriodo = null;

      function formatCurrencyBRL(value) {
        return Number(value || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL"
        });
      }

      // Converte valores que podem vir como string com v√≠rgula/ponto
      function toNumber(val) {
        if (!val) return 0;
        if (typeof val === "number") return val;
        return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
      }

      async function loadDashboard() {
        try {
          const data = await apiFetch("/api/reports/summary");

          const totals = data.totals || {};
          document.getElementById("dashTotalNotas").textContent =
            totals.total_notas || 0;
          document.getElementById("dashValorTotal").textContent =
            formatCurrencyBRL(totals.soma_valor_total || 0);
          document.getElementById("dashTaxas").textContent = formatCurrencyBRL(
            totals.soma_taxas || 0
          );

          const porPeriodo = data.porPeriodo || [];
          const labelsDia = porPeriodo.map((d) => d.label);
          const valoresDia = porPeriodo.map((d) => d.total_notas);


          if (chartNotasDia) chartNotasDia.destroy();
          const ctxDia = document.getElementById("chartNotasDia").getContext("2d");
          chartNotasDia = new Chart(ctxDia, {
            type: "line",
            data: {
              labels: labelsDia,
              datasets: [
                {
                  label: "Notas",
                  data: valoresDia,
                  borderWidth: 2,
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          const porStatus = data.porStatus || [];
          if (chartStatus) chartStatus.destroy();
          const ctxStatus = document.getElementById("chartStatus").getContext("2d");
          chartStatus = new Chart(ctxStatus, {
            type: "doughnut",
            data: {
              labels: porStatus.map((s) => s.status),
              datasets: [
                {
                  data: porStatus.map((s) => s.total_notas),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "bottom" },
              },
            },
          });
        } catch (err) {
          console.error("Erro ao carregar dashboard:", err);
        }
      }

      async function loadRelatorios() {
        try {
          const start = document.getElementById("relDataIni").value;
          const end = document.getElementById("relDataFim").value;
          const group_by = document.getElementById("relGroupBy").value;

          const params = new URLSearchParams();
          if (start) params.append("start", start);
          if (end) params.append("end", end);
          params.append("group_by", group_by);

          const data = await apiFetch("/api/reports/summary?" + params.toString());

          // ------ TOTAL GERAL ------
          const totals = data.totals || {};
          document.getElementById("relTotalNotas").textContent =
            totals.total_notas || 0;
          document.getElementById("relValorTotal").textContent =
            formatCurrencyBRL(toNumber(totals.soma_valor_total));
        document.getElementById("relTaxasTotal").textContent =
          formatCurrencyBRL(toNumber(totals.soma_taxas));

          // ------ GR√ÅFICO POR PER√çODO ------
          const porPeriodo = data.porPeriodo || [];
          if (chartRelPeriodo) chartRelPeriodo.destroy();
          const ctx = document.getElementById("chartRelPeriodo").getContext("2d");
          chartRelPeriodo = new Chart(ctx, {
            type: "bar",
            data: {
              labels: porPeriodo.map((p) => p.label),
              datasets: [
                {
                  label: "Notas",
                  data: porPeriodo.map((p) => Number(p.total_notas || 0)),
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          // ------ TOP CLIENTE ------
          const porCliente = data.porCliente || [];
          if (porCliente.length > 0) {
            const topCliente = [...porCliente].sort(
              (a, b) => Number(b.total_notas) - Number(a.total_notas)
            )[0];

            document.getElementById("relTopCliente").textContent =
              `${topCliente.name || "‚Äî"} ‚Äî ${topCliente.total_notas} notas, ${formatCurrencyBRL(toNumber(topCliente.soma_valor_total))}`;
          } else {
            document.getElementById("relTopCliente").textContent = "‚Äî";
          }

          // ------ TOP EMPRESA ------
          const porEmpresa = data.porEmpresa || [];
          if (porEmpresa.length > 0) {
            const topEmpresa = [...porEmpresa].sort(
              (a, b) => toNumber(b.soma_valor_total) - toNumber(a.soma_valor_total)
            )[0];

            document.getElementById("relTopEmpresa").textContent =
              `${topEmpresa.name || "‚Äî"} ‚Äî ${formatCurrencyBRL(toNumber(topEmpresa.soma_valor_total))} em notas`;
          } else {
            document.getElementById("relTopEmpresa").textContent = "‚Äî";
          }

        } catch (err) {
          console.error("Erro ao carregar relat√≥rios:", err);
        }
      }

      // Helpers para agrupar notas por data no front
      function groupByDateForChart(notas) {
        const map = new Map();
        notas.forEach((n) => {
          if (!n.issued_at) return;
          const d = new Date(n.issued_at);
          const key = d.toISOString().slice(0, 10); // YYYY-MM-DD
          const current = map.get(key) || { total: 0, count: 0 };
          current.total += Number(n.total_amount || 0);
          current.count += 1;
          map.set(key, current);
        });
        const entries = Array.from(map.entries()).sort((a, b) =>
          a[0] < b[0] ? -1 : 1
        );
        const labels = entries.map(([k]) => {
          const d = new Date(k + "T00:00:00");
          return d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit" });
        });
        const counts = entries.map(([, v]) => v.count);
        return { labels, counts };
      }

      // RELAT√ìRIO POR CLIENTE
      // RELAT√ìRIO POR CLIENTE
      async function loadRelatorioPorCliente() {
        const select = document.getElementById("relClienteSelect");
        const id = select.value;

        // Se n√£o tiver cliente selecionado, apenas sai silenciosamente
        if (!id) return;

        const start = document.getElementById("relClienteDataIni").value;
        const end = document.getElementById("relClienteDataFim").value;

        const params = new URLSearchParams();
        if (start) params.append("start", start);
        if (end) params.append("end", end);

        try {
          const data = await apiFetch(`/api/reports/cliente/${id}?` + params.toString());

          const cliente = data.cliente;
          const totais = data.totais || {};
          const notas = data.notas || [];

          document.getElementById("relClienteNome").textContent =
            cliente?.name || "‚Äî";
          document.getElementById("relClienteWhats").textContent =
            `WhatsApp: ${cliente?.whatsapp_number || "‚Äî"}`;
          document.getElementById("relClienteTotalNotas").textContent =
            totais.total_notas || 0;
          document.getElementById("relClienteValorTotal").textContent =
            formatCurrencyBRL(totais.soma_valor_total || 0);
          document.getElementById("relClienteTaxasTotal").textContent =
            formatCurrencyBRL(totais.soma_taxas || 0);

          // gr√°fico
          const { labels, counts } = groupByDateForChart(notas);
          if (chartRelClientePeriodo) chartRelClientePeriodo.destroy();
          const ctx = document.getElementById("chartRelClientePeriodo").getContext("2d");
          chartRelClientePeriodo = new Chart(ctx, {
            type: "line",
            data: { labels, datasets: [{ label: "Notas", data: counts, tension: 0.25 }] },
            options: { responsive: true, plugins: { legend: { display: false } } },
          });

          // tabela empresas
          const empMap = new Map();
          notas.forEach((n) => {
            const nome = n.Company?.name || "‚Äî";
            const obj =
              empMap.get(nome) || { empresa: nome, total_notas: 0, soma_valor_total: 0 };
            obj.total_notas += 1;
            obj.soma_valor_total += Number(n.total_amount || 0);
            empMap.set(nome, obj);
          });

          const empBody = document.getElementById("relClienteEmpresasBody");
          const empRows = Array.from(empMap.values())
            .sort((a, b) => b.soma_valor_total - a.soma_valor_total)
            .map(
              (e) => `
                <tr>
                  <td>${e.empresa}</td>
                  <td>${e.total_notas}</td>
                  <td>${formatCurrencyBRL(e.soma_valor_total)}</td>
                </tr>`
            )
            .join("");
          empBody.innerHTML = empRows;

          // tabela notas
          const notasBody = document.getElementById("relClienteNotasBody");
          const notasRows = notas
            .map(
              (n) => `
              <tr>
                <td>${n.id}</td>
                <td>${n.issued_at ? new Date(n.issued_at).toLocaleString("pt-BR") : "‚Äî"}</td>
                <td>${n.Company?.name || "‚Äî"}</td>
                <td>${formatCurrencyBRL(n.total_amount)}</td>
                <td>${formatCurrencyBRL(n.fee_value)}</td>
                <td>${n.status}</td>
              </tr>`
            )
            .join("");
          notasBody.innerHTML = notasRows;

        } catch (err) {
          console.error("Erro relat√≥rio por cliente:", err);
          // N√ÉO MOSTRA ALERTA ‚Äî s√≥ loga
        }
      }




      // RELAT√ìRIO POR EMPRESA
      // RELAT√ìRIO POR EMPRESA (vers√£o corrigida)
      async function loadRelatorioPorEmpresa() {
        const select = document.getElementById("relEmpresaSelect");
        const id = select.value;

        // Se nenhuma empresa foi selecionada, apenas sai
        if (!id) return;

        const start = document.getElementById("relEmpresaDataIni").value;
        const end = document.getElementById("relEmpresaDataFim").value;

        const params = new URLSearchParams();
        if (start) params.append("start", start);
        if (end) params.append("end", end);

        try {
          const data = await apiFetch(`/api/reports/empresa/${id}?` + params.toString());

          const empresa = data.empresa;
          const totais = data.totais || {};
          const notas = data.notas || [];

          document.getElementById("relEmpresaNome").textContent =
            empresa?.name || "‚Äî";
          document.getElementById("relEmpresaCnpj").textContent =
            `CNPJ: ${empresa?.cnpj || "‚Äî"}`;

          document.getElementById("relEmpresaTotalNotas").textContent =
            totais.total_notas || 0;
          document.getElementById("relEmpresaValorTotal").textContent =
            formatCurrencyBRL(totais.soma_valor_total || 0);

          // Gr√°fico da empresa
          const { labels, counts } = groupByDateForChart(notas);
          if (chartRelEmpresaPeriodo) chartRelEmpresaPeriodo.destroy();

          const ctx = document
            .getElementById("chartRelEmpresaPeriodo")
            .getContext("2d");

          chartRelEmpresaPeriodo = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Notas",
                  data: counts,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          // Tabela de clientes atendidos pela empresa
          const cliMap = new Map();
          notas.forEach((n) => {
            const nome = n.Customer?.name || "‚Äî";
            const obj = cliMap.get(nome) || {
              cliente: nome,
              total_notas: 0,
              soma_valor_total: 0,
            };
            obj.total_notas += 1;
            obj.soma_valor_total += Number(n.total_amount || 0);
            cliMap.set(nome, obj);
          });

          const cliBody = document.getElementById("relEmpresaClientesBody");
          const cliRows = Array.from(cliMap.values())
            .sort((a, b) => b.soma_valor_total - a.soma_valor_total)
            .map(
              (c) => `
                <tr>
                  <td>${c.cliente}</td>
                  <td>${c.total_notas}</td>
                  <td>${formatCurrencyBRL(c.soma_valor_total)}</td>
                </tr>
              `
            )
            .join("");
          cliBody.innerHTML = cliRows;

          // Tabela de notas da empresa
          const notasBody = document.getElementById("relEmpresaNotasBody");
          const notasRows = notas
            .map(
              (n) => `
              <tr>
                <td>${n.id}</td>
                <td>${n.issued_at ? new Date(n.issued_at).toLocaleString("pt-BR") : "‚Äî"}</td>
                <td>${n.Customer?.name || "‚Äî"}</td>
                <td>${formatCurrencyBRL(n.total_amount)}</td>
                <td>${formatCurrencyBRL(n.fee_value)}</td>
                <td>${n.status}</td>
              </tr>
            `
            )
            .join("");
          notasBody.innerHTML = notasRows;

        } catch (err) {
          console.error("Erro relat√≥rio por empresa:", err);
          // N√£o usamos alert(), para n√£o causar erro visual
        }
      }



      // ==========================
      // CLIENTES
      // ==========================
      let clientes = [];
      let editingClienteId = null;

      async function loadClientes() {
        try {
          clientes = await apiFetch("/api/customers");
          renderClientes();
          return clientes;
        } catch (err) {
          console.error("Erro ao carregar clientes:", err);
          return [];
        }
      }

      function renderClientes() {
        const tbody = document.getElementById("clientesTableBody");
        tbody.innerHTML = "";

        const search = document
          .getElementById("clienteSearch")
          .value.toLowerCase();
        const feeMin = parseFloat(
          document.getElementById("clienteFeeMin").value
        );
        const feeMax = parseFloat(
          document.getElementById("clienteFeeMax").value
        );
        const ativoChip = document.querySelector(
          '.chip-filter[data-cliente-ativo].active'
        );
        const ativoFilter = ativoChip ? ativoChip.dataset.clienteAtivo : "all";

        clientes
          .filter((c) => {
            if (
              search &&
              !(
                c.name.toLowerCase().includes(search) ||
                c.whatsapp_number.toLowerCase().includes(search)
              )
            )
              return false;

            if (!isNaN(feeMin) && parseFloat(c.fee_percent) < feeMin) return false;
            if (!isNaN(feeMax) && parseFloat(c.fee_percent) > feeMax) return false;

            if (ativoFilter === "true" && !c.is_active) return false;
            if (ativoFilter === "false" && c.is_active) return false;

            return true;
          })
          .forEach((c) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.whatsapp_number}</td>
              <td>${Number(c.fee_percent).toFixed(2)}%</td>
              <td>
                <span class="tag ${
                  c.is_active ? "tag-success" : "tag-muted"
                }">${c.is_active ? "Ativo" : "Inativo"}</span>
              </td>
              <td>${c.created_at ? new Date(c.created_at).toLocaleString("pt-BR") : "‚Äî"}</td>
              <td>
                <button class="btn-ghost" data-edit-cliente="${c.id}">Editar</button>
                <button class="btn-danger" data-del-cliente="${c.id}">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
      }

      function openClienteForm(cliente) {
        document.getElementById("clienteFormWrapper").style.display = "block";
        document.getElementById("clienteFormError").style.display = "none";

        if (cliente) {
          editingClienteId = cliente.id;
          document.getElementById("clienteNome").value = cliente.name;
          document.getElementById("clienteWhats").value =
            cliente.whatsapp_number;
          document.getElementById("clienteTaxa").value = cliente.fee_percent;
          document.getElementById("clienteAtivo").value = cliente.is_active
            ? "true"
            : "false";
          document.getElementById("clienteUsaNF").checked = cliente.uses_nf !== false;
          document.getElementById("clienteUsaPOS").checked = cliente.uses_pos === true;
        } else {
          editingClienteId = null;
          document.getElementById("clienteNome").value = "";
          document.getElementById("clienteWhats").value = "";
          document.getElementById("clienteTaxa").value = "";
          document.getElementById("clienteAtivo").value = "true";
          document.getElementById("clienteUsaNF").checked = true;
          document.getElementById("clienteUsaPOS").checked = false;
        }
      }

      function closeClienteForm() {
        document.getElementById("clienteFormWrapper").style.display = "none";
        editingClienteId = null;
      }

      async function saveCliente() {
        const nome = document.getElementById("clienteNome").value.trim();
        const whats = document.getElementById("clienteWhats").value.trim();
        const taxa = document.getElementById("clienteTaxa").value.trim();
        const ativo = document.getElementById("clienteAtivo").value === "true";
        const usaNF = document.getElementById("clienteUsaNF").checked;
        const usaPOS = document.getElementById("clienteUsaPOS").checked;
        const errEl = document.getElementById("clienteFormError");

        errEl.style.display = "none";

        if (!nome || !whats || taxa === "") {
          errEl.textContent = "Preencha todos os campos obrigat√≥rios.";
          errEl.style.display = "block";
          return;
        }

        const payload = {
          name: nome,
          whatsapp_number: whats,
          fee_percent: parseFloat(taxa),
          is_active: ativo,
          uses_nf: usaNF,
          uses_pos: usaPOS,
        };

        try {
          if (editingClienteId) {
            await apiFetch("/api/customers/" + editingClienteId, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/customers", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          closeClienteForm();
          const list = await loadClientes();
          populateRelatorioSelects(list, empresas);
        } catch (err) {
          console.error(err);
          errEl.textContent = "Erro ao salvar cliente.";
          if (String(err.message).includes("WhatsApp")) {
            errEl.textContent =
              "J√° existe um cliente com esse n√∫mero de WhatsApp.";
          }
          errEl.style.display = "block";
        }
      }

      async function deleteCliente(id) {
        if (!confirm("Deseja realmente excluir este cliente?")) return;
        try {
          await apiFetch("/api/customers/" + id, { method: "DELETE" });
          const list = await loadClientes();
          populateRelatorioSelects(list, empresas);
        } catch (err) {
          console.error(err);
          alert("Erro ao excluir cliente.");
        }
      }

      // ==========================
      // EMPRESAS
      // ==========================
      let empresas = [];
      let editingEmpresaId = null;

      async function loadEmpresas() {
        try {
          empresas = await apiFetch("/api/companies");
          renderEmpresas();
          return empresas;
        } catch (err) {
          console.error("Erro ao carregar empresas:", err);
          return [];
        }
      }

      function renderEmpresas() {
        const tbody = document.getElementById("empresasTableBody");
        tbody.innerHTML = "";

        const search = document.getElementById("empresaSearch").value.toLowerCase();
        const ativoChip = document.querySelector(
          '.chip-filter[data-empresa-ativo].active'
        );
        const ativoFilter = ativoChip ? ativoChip.dataset.empresaAtivo : "all";

        empresas
          .filter((e) => {
            if (
              search &&
              !(
                e.name.toLowerCase().includes(search) ||
                e.cnpj.toLowerCase().includes(search)
              )
            )
              return false;
            if (ativoFilter === "true" && !e.is_active) return false;
            if (ativoFilter === "false" && e.is_active) return false;
            return true;
          })
          .forEach((e) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${e.id}</td>
              <td>${e.name}</td>
              <td>${e.cnpj}</td>
              <td>
                <span class="tag ${
                  e.is_active ? "tag-success" : "tag-muted"
                }">${e.is_active ? "Ativa" : "Inativa"}</span>
              </td>
              <td>${e.created_at ? new Date(e.created_at).toLocaleString("pt-BR") : "‚Äî"}</td>
              <td>
                <button class="btn-ghost" data-edit-empresa="${e.id}">Editar</button>
                <button class="btn-danger" data-del-empresa="${e.id}">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
      }

      function openEmpresaForm(empresa) {
        document.getElementById("empresaFormWrapper").style.display = "block";
        document.getElementById("empresaFormError").style.display = "none";

        if (empresa) {
          editingEmpresaId = empresa.id;
          document.getElementById("empresaNome").value = empresa.name;
          document.getElementById("empresaCnpj").value = empresa.cnpj;
          document.getElementById("empresaChave").value = empresa.access_key;
          document.getElementById("empresaAtiva").value = empresa.is_active
            ? "true"
            : "false";
        } else {
          editingEmpresaId = null;
          document.getElementById("empresaNome").value = "";
          document.getElementById("empresaCnpj").value = "";
          document.getElementById("empresaChave").value = "";
          document.getElementById("empresaAtiva").value = "true";
        }
      }

      function closeEmpresaForm() {
        document.getElementById("empresaFormWrapper").style.display = "none";
        editingEmpresaId = null;
      }

      async function saveEmpresa() {
        const nome = document.getElementById("empresaNome").value.trim();
        const cnpj = document.getElementById("empresaCnpj").value.trim();
        const chave = document.getElementById("empresaChave").value.trim();
        const ativa = document.getElementById("empresaAtiva").value === "true";
        const errEl = document.getElementById("empresaFormError");

        errEl.style.display = "none";

        if (!nome || !cnpj || !chave) {
          errEl.textContent = "Preencha todos os campos obrigat√≥rios.";
          errEl.style.display = "block";
          return;
        }

        const payload = {
          name: nome,
          cnpj,
          access_key: chave,
          is_active: ativa,
        };

        try {
          if (editingEmpresaId) {
            await apiFetch("/api/companies/" + editingEmpresaId, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/companies", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          closeEmpresaForm();
          const list = await loadEmpresas();
          populateRelatorioSelects(clientes, list);
        } catch (err) {
          console.error(err);
          errEl.textContent = "Erro ao salvar empresa.";
          if (String(err.message).includes("CNPJ")) {
            errEl.textContent = "J√° existe uma empresa com esse CNPJ.";
          }
          errEl.style.display = "block";
        }
      }

      async function deleteEmpresa(id) {
        if (!confirm("Deseja realmente excluir esta empresa?")) return;
        try {
          await apiFetch("/api/companies/" + id, { method: "DELETE" });
          const list = await loadEmpresas();
          populateRelatorioSelects(clientes, list);
        } catch (err) {
          console.error(err);
          alert("Erro ao excluir empresa.");
        }
      }

      // ==========================
      // NOTAS - SCROLL INFINITO
      // ==========================
      const notasState = {
        page: 1,
        limit: 50,
        loading: false,
        hasMore: true,
        observer: null,
        lastFiltersKey: "",
        allLoaded: [],
      };

      function resetNotasInfiniteScroll() {
        notasState.page = 1;
        notasState.loading = false;
        notasState.hasMore = true;
        notasState.allLoaded = [];
        document.getElementById("notasTableBody").innerHTML = "";
        document.getElementById("notasLoaderText").textContent =
          "Rolando para carregar mais‚Ä¶";
      }

      function getNotasFiltersKey() {
        const search = document.getElementById("notasSearch").value.trim();
        const status = document.getElementById("notasStatusFilter").value;
        const origem = document.getElementById("notasOrigemFilter").value;
        const d1 = document.getElementById("notasDataIni").value;
        const d2 = document.getElementById("notasDataFim").value;
        return JSON.stringify({ search, status, origem, d1, d2 });
      }

      async function loadNotasPage(resetIfFiltersChanged) {
        if (notasState.loading || !notasState.hasMore) return;

        const currentKey = getNotasFiltersKey();
        if (resetIfFiltersChanged && notasState.lastFiltersKey !== currentKey) {
          resetNotasInfiniteScroll();
          notasState.lastFiltersKey = currentKey;
        }

        notasState.loading = true;
        document.getElementById("notasLoaderText").textContent =
          "Carregando notas...";

        try {
          const params = new URLSearchParams();
          params.append("page", notasState.page.toString());
          params.append("limit", notasState.limit.toString());

          const res = await apiFetch("/api/invoices?" + params.toString());
          const { data, pagination } = res;

          notasState.allLoaded = notasState.allLoaded.concat(data || []);
          renderNotas();

          notasState.page += 1;
          notasState.hasMore =
            pagination && notasState.page <= pagination.pages;

          if (!notasState.hasMore) {
            document.getElementById("notasLoaderText").textContent =
              "N√£o h√° mais notas para carregar.";
          } else {
            document.getElementById("notasLoaderText").textContent =
              "Rolando para carregar mais‚Ä¶";
          }
        } catch (err) {
          console.error("Erro ao carregar notas:", err);
          document.getElementById("notasLoaderText").textContent =
            "Erro ao carregar notas.";
        } finally {
          notasState.loading = false;
        }
      }

      function renderNotas() {
        const tbody = document.getElementById("notasTableBody");
        tbody.innerHTML = "";

        const searchRaw = document.getElementById("notasSearch").value;
        const search = searchRaw.toLowerCase();
        const searchDigits = searchRaw.replace(/\D/g, "");
        const statusFilter = document.getElementById("notasStatusFilter").value;
        const origemFilter = document.getElementById("notasOrigemFilter").value;
        const dIni = document.getElementById("notasDataIni").value;
        const dFim = document.getElementById("notasDataFim").value;

        notasState.allLoaded
          .filter((n) => {
            const cliente = n.Customer?.name?.toLowerCase() || "";
            const empresa = n.Company?.name?.toLowerCase() || "";
            const comprador = n.buyer_name?.toLowerCase() || "";
            const cpfComprador = n.buyer_cpf?.toLowerCase() || "";
            const cpfDigits = (n.buyer_cpf || "").replace(/\D/g, "");

            if (
              search &&
              !(
                cliente.includes(search) ||
                empresa.includes(search) ||
                comprador.includes(search) ||
                cpfComprador.includes(search) ||
                (searchDigits && cpfDigits.includes(searchDigits))
              )
            )
              return false;

            if (statusFilter !== "all" && n.status !== statusFilter)
              return false;

            if (origemFilter === "terminal" && !n.is_terminal_sale) return false;
            if (origemFilter === "manual" && n.is_terminal_sale) return false;

            if (dIni) {
              if (
                !n.issued_at ||
                new Date(n.issued_at) < new Date(dIni + "T00:00:00")
              )
                return false;
            }

            if (dFim) {
              if (
                !n.issued_at ||
                new Date(n.issued_at) > new Date(dFim + "T23:59:59")
              )
                return false;
            }

            return true;
          })
          .forEach((n) => {
            const tr = document.createElement("tr");
            const dt = n.issued_at
              ? new Date(n.issued_at).toLocaleString("pt-BR")
              : "‚Äî";
            const origem = n.is_terminal_sale ? "Maquininha" : "Manual";
            const nfLink = n.nf_link
              ? `<a href="${n.nf_link}" target="_blank" rel="noopener noreferrer">Download</a>`
              : "‚Äî";
            const statusClass =
              n.status === "PAGA"
                ? "status-paga"
                : n.status === "CANCELADA"
                ? "status-cancelada"
                : "status-emitida";

            tr.innerHTML = `
              <td>${n.id}</td>
              <td>${dt}</td>
              <td>${n.Customer?.name || "‚Äî"}</td>
              <td>${n.Company?.name || "‚Äî"}</td>
              <td>${n.buyer_name || "‚Äî"}</td>
              <td>${n.buyer_cpf || "‚Äî"}</td>
              <td>${formatCurrencyBRL(n.total_amount)}</td>
              <td>${n.paid_amount ? formatCurrencyBRL(n.paid_amount) : "‚Äî"}</td>
              <td>${Number(n.fee_percent).toFixed(2)}%</td>
              <td>${formatCurrencyBRL(n.fee_value)}</td>
              <td>${origem}</td>
              <td>${n.terminal_id || "‚Äî"}</td>
              <td>${n.nsu || "‚Äî"}</td>
              <td>${nfLink}</td>
              <td><span class="status-pill ${statusClass}">${n.status}</span></td>
            `;
            tbody.appendChild(tr);
          });
      }

      function setupNotasInfiniteScroll() {
        const sentinel = document.getElementById("notasLoaderRow");
        if (!sentinel) return;

        if (notasState.observer) {
          notasState.observer.disconnect();
        }

        notasState.observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (
              entry.isIntersecting &&
              document
                .getElementById("page-notas")
                .classList.contains("active")
            ) {
              loadNotasPage(false);
            }
          });
        });

        notasState.observer.observe(sentinel);
      }

            // ==========================
      // MAQUININHAS (POS)
      // ==========================
let posCompanies = [];
      let posTerminals = [];
      let posVendasRecentes = [];
      let posClientes = [];
      let currentPosClienteId = null;
      let currentPosCompanyId = null;
      let currentPosTerminalId = null;
      let currentPosVendaId = null;

      async function loadPosCompanies() {
        try {
          posCompanies = await apiFetch("/api/pos/companies");
          renderPosCompanies();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar empresas POS:", err);
        }
      }

      function renderPosCompanies() {
        const tbody = document.getElementById("posCompaniesTableBody");
        if (!tbody) return;
        const termRaw = (document.getElementById("posCompanySearch")?.value || "").trim().toLowerCase();
        const term = termRaw.normalize("NFD").replace(/\p{Diacritic}/gu, "");
        const tclean = term.replace(/\D/g, "");
        const filtered = (posCompanies || []).filter((c) => {
          if (!term) return true;
          const nome = (c.name || "").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
          const cnpj = (c.cnpj || "").replace(/\D/g, "");
          return nome.includes(term) || (!!tclean && cnpj.includes(tclean));
        });
        tbody.innerHTML = filtered
          .map((c) => `
            <tr data-id="${c.id}">
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.cnpj}</td>
              <td>${c.is_active ? "Ativa" : "Inativa"}</td>
              <td>
                <button class="btn-secondary" data-edit-pos-company="${c.id}">Editar</button>
                <button class="btn-danger" data-del-pos-company="${c.id}">Excluir</button>
              </td>
            </tr>
          `)
          .join("");
      }

      function resetPosCompanyForm() {
        currentPosCompanyId = null;
        document.getElementById("posCompanyName").value = "";
        document.getElementById("posCompanyCnpj").value = "";
        document.getElementById("posCompanyAtiva").value = "true";
        const btn = document.getElementById("btnPosAddCompany");
        if (btn) btn.textContent = "Salvar empresa";
      }

      async function savePosCompany() {
        const name = document.getElementById("posCompanyName").value.trim();
        const cnpj = document.getElementById("posCompanyCnpj").value.trim();
        const is_active = document.getElementById("posCompanyAtiva").value === "true";
        if (!name || !cnpj) return alert("Informe nome e CNPJ");
        try {
          if (currentPosCompanyId) {
            await apiFetch(`/api/pos/companies/${currentPosCompanyId}`, {
              method: "PUT",
              body: JSON.stringify({ name, cnpj, is_active }),
            });
          } else {
            await apiFetch("/api/pos/companies", {
              method: "POST",
              body: JSON.stringify({ name, cnpj, is_active }),
            });
          }
          await loadPosCompanies();
          resetPosCompanyForm();
        } catch (err) {
          alert("Erro ao salvar empresa POS");
          console.error(err);
        }
      }

      async function deletePosCompany(id) {
        if (!confirm("Excluir empresa?")) return;
        try {
          await apiFetch(`/api/pos/companies/${id}`, { method: "DELETE" });
          await loadPosCompanies();
          fillPosSelects();
        } catch (err) {
          alert("Erro ao excluir empresa POS");
          console.error(err);
        }
      }

      async function loadPosTerminals() {
        try {
          posTerminals = await apiFetch("/api/pos/terminals");
          renderPosTerminals();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar terminais:", err);
        }
      }

      function renderPosTerminals() {
        const tbody = document.getElementById("posTerminalsTableBody");
        if (!tbody) return;
        const term = (document.getElementById("posTerminalSearch")?.value || "").toLowerCase();
        const filtered = (posTerminals || []).filter((t) => {
          if (!term) return true;
          const code = (t.terminal_code || "").toLowerCase();
          const emp = (t.PosCompany?.name || "").toLowerCase();
          const cli = (t.Customer?.name || "").toLowerCase();
          return code.includes(term) || emp.includes(term) || cli.includes(term);
        });
        tbody.innerHTML = filtered
          .map((t) => `
            <tr data-id="${t.id}">
              <td>${t.id}</td>
              <td>${t.terminal_code}</td>
              <td>${t.PosCompany?.name || "?"}</td>
              <td>${t.Customer?.name || "?"}</td>
              <td>${t.is_active ? "Ativo" : "Inativo"}</td>
              <td>
                <button class="btn-secondary" data-edit-pos-terminal="${t.id}">Editar</button>
                <button class="btn-danger" data-del-pos-terminal="${t.id}">Excluir</button>
              </td>
            </tr>
          `)
          .join("");
      }

      function resetPosTerminalForm() {
        currentPosTerminalId = null;
        document.getElementById("posTerminalEmpresa").value = "";
        document.getElementById("posTerminalCliente").value = "";
        document.getElementById("posTerminalCode").value = "";
        document.getElementById("posTerminalAtivo").value = "true";
        const btn = document.getElementById("btnPosAddTerminal");
        if (btn) btn.textContent = "Salvar terminal";
      }

      function populatePosTerminalForm(t) {
        currentPosTerminalId = t?.id || null;
        document.getElementById("posTerminalEmpresa").value = t?.pos_company_id || "";
        document.getElementById("posTerminalCliente").value = t?.customer_id || "";
        document.getElementById("posTerminalCode").value = t?.terminal_code || "";
        document.getElementById("posTerminalAtivo").value = t?.is_active === false ? "false" : "true";
        const btn = document.getElementById("btnPosAddTerminal");
        if (btn) btn.textContent = t ? "Atualizar terminal" : "Salvar terminal";
      }

      async function savePosTerminal() {
        const pos_company_id = document.getElementById("posTerminalEmpresa").value;
        const customer_id = document.getElementById("posTerminalCliente").value;
        const terminal_code = document.getElementById("posTerminalCode").value.trim();
        const is_active = document.getElementById("posTerminalAtivo").value === "true";
        if (!pos_company_id || !customer_id || !terminal_code) return alert("Preencha todos os campos");
        try {
          if (currentPosTerminalId) {
            await apiFetch(`/api/pos/terminals/${currentPosTerminalId}`, {
              method: "PUT",
              body: JSON.stringify({ pos_company_id, customer_id, terminal_code, is_active }),
            });
          } else {
            await apiFetch("/api/pos/terminals", {
              method: "POST",
              body: JSON.stringify({ pos_company_id, customer_id, terminal_code, is_active }),
            });
          }
          await loadPosTerminals();
          resetPosTerminalForm();
        } catch (err) {
          alert("Erro ao salvar terminal");
          console.error(err);
        }
      }

      async function deletePosTerminal(id) {
        if (!confirm("Excluir terminal?")) return;
        try {
          await apiFetch(`/api/pos/terminals/${id}`, { method: "DELETE" });
          await loadPosTerminals();
          fillPosSelects();
        } catch (err) {
          alert("Erro ao excluir terminal");
          console.error(err);
        }
      }

function fillPosSelects() {
        const selEmp = document.getElementById("posTerminalEmpresa");
        const selCli = document.getElementById("posTerminalCliente");
        const selRateCli = document.getElementById("posRateCliente");
        const selVendaTerm = document.getElementById("posVendaTerminal");
        if (selEmp) {
          selEmp.innerHTML =
            '<option value="">Selecione</option>' +
            (posCompanies || [])
              .map((c) => `<option value="${c.id}">${c.name}</option>`)
              .join("");
        }
        if (selCli) {
          selCli.innerHTML =
            '<option value="">Selecione</option>' +
            (posClientes || [])
              .filter((c) => c.uses_pos !== false && c.is_active !== false)
              .map((c) => `<option value="${c.id}">${c.name}</option>`)
              .join("");
        }
        if (selRateCli) selRateCli.innerHTML = selCli ? selCli.innerHTML : "";
        if (selVendaTerm) {
          selVendaTerm.innerHTML =
            '<option value="">Selecione</option>' +
            (posTerminals || [])
              .filter((t) => {
                const term = (document.getElementById("posVendaTerminalSearch")?.value || "").toLowerCase();
                if (!term) return true;
                const code = (t.terminal_code || "").toLowerCase();
                const cli = (t.Customer?.name || "").toLowerCase();
                return code.includes(term) || cli.includes(term);
              })
              .map(
                (t) => `<option value="${t.id}">${t.terminal_code} - ${t.Customer?.name || "Cliente"}</option>`
              )
              .join("");
        }
      }

      async function loadPosRateForSelected() {
        const cid = document.getElementById("posRateCliente").value;
        if (!cid) return;
        try {
          const rate = await apiFetch(`/api/pos/rates/${cid}`);
          document.getElementById("posRatePix").value = rate?.pix_key || "";
          document.getElementById("posRateDebito").value = rate?.debit_percent || "";
          document.getElementById("posRateCreditoAVista").value = rate?.credit_avista_percent || "";
          document.getElementById("posRateCredito2a6").value = rate?.credit_2a6_percent || "";
          document.getElementById("posRateCredito7a12").value = rate?.credit_7a12_percent || "";
        } catch (err) {
          console.error("Erro ao carregar taxa:", err);
        }
      }

      async function savePosRates() {
        const cid = document.getElementById("posRateCliente").value;
        if (!cid) return alert("Selecione um cliente");
        const payload = {
          pix_key: document.getElementById("posRatePix").value.trim(),
          debit_percent: Number(document.getElementById("posRateDebito").value || 0),
          credit_avista_percent: Number(document.getElementById("posRateCreditoAVista").value || 0),
          credit_2a6_percent: Number(document.getElementById("posRateCredito2a6").value || 0),
          credit_7a12_percent: Number(document.getElementById("posRateCredito7a12").value || 0),
        };
        try {
          await apiFetch(`/api/pos/rates/${cid}`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          alert("Taxas salvas");
        } catch (err) {
          alert("Erro ao salvar taxas");
          console.error(err);
        }
      }

      async function registrarVendaPos() {
        const pos_terminal_id = document.getElementById("posVendaTerminal").value;
        const sale_datetime = document.getElementById("posVendaData").value;
        const amount = document.getElementById("posVendaValor").value;
        const payment_type = document.getElementById("posVendaForma").value;
        const nsu = document.getElementById("posVendaNsu").value.trim();
        if (!pos_terminal_id || !sale_datetime || !amount || !nsu) return alert("Preencha todos os campos");
        const method = currentPosVendaId ? "PUT" : "POST";
        const url = currentPosVendaId ? `/api/pos/sales/${currentPosVendaId}` : "/api/pos/sales";
        try {
          await apiFetch(url, {
            method,
            body: JSON.stringify({ pos_terminal_id, sale_datetime, amount, payment_type, nsu }),
          });
          document.getElementById("posVendaMsg").textContent = "Venda salva";
          document.getElementById("posVendaMsg").style.display = "block";
          await loadPosVendasRecentes();
          await loadPosResumo();
          resetPosVendaForm();
        } catch (err) {
          alert("Erro ao registrar venda");
          console.error(err);
        }
      }

      function resetPosVendaForm() {
        currentPosVendaId = null;
        document.getElementById("posVendaTerminal").value = "";
        document.getElementById("posVendaTerminalSearch").value = "";
        document.getElementById("posVendaData").value = "";
        document.getElementById("posVendaValor").value = "";
        document.getElementById("posVendaForma").value = "DEBITO";
        document.getElementById("posVendaNsu").value = "";
        const btn = document.getElementById("btnPosRegistrarVenda");
        if (btn) btn.textContent = "Salvar venda";
        document.getElementById("posVendaMsg").style.display = "none";
        fillPosSelects();
      }

      function populatePosVendaForm(v) {
        currentPosVendaId = v?.id || null;
        const searchInput = document.getElementById("posVendaTerminalSearch");
        if (searchInput) searchInput.value = "";
        fillPosSelects();
        document.getElementById("posVendaTerminal").value = v?.pos_terminal_id || "";
        document.getElementById("posVendaData").value = v?.sale_datetime
          ? new Date(v.sale_datetime).toISOString().slice(0, 16)
          : "";
        document.getElementById("posVendaValor").value = v?.amount || "";
        document.getElementById("posVendaForma").value = v?.payment_type || "DEBITO";
        document.getElementById("posVendaNsu").value = v?.nsu || "";
        const btn = document.getElementById("btnPosRegistrarVenda");
        if (btn) btn.textContent = v ? "Atualizar venda" : "Salvar venda";
      }

      async function loadPosVendasRecentes() {
        try {
          const res = await apiFetch("/api/pos/sales?page=1&limit=50");
          posVendasRecentes = res.data || [];
          renderPosVendas();
        } catch (err) {
          console.error("Erro ao carregar vendas:", err);
        }
      }

      function renderPosVendas() {
        const tbody = document.getElementById("posVendasTableBody");
        if (!tbody) return;
        tbody.innerHTML = (posVendasRecentes || [])
          .map((v) => {
            const dt = v.sale_datetime ? new Date(v.sale_datetime).toLocaleString("pt-BR") : "?";
            return `
              <tr data-id="${v.id}">
                <td>${dt}</td>
                <td>${v.Customer?.name || "?"}</td>
                <td>${v.PosTerminal?.terminal_code || "?"}</td>
                <td>${v.payment_type}</td>
                <td>${formatCurrencyBRL(Number(v.amount || 0))}</td>
                <td>${formatCurrencyBRL(Number(v.fee_value || 0))}</td>
                <td>${formatCurrencyBRL(Number(v.net_amount || 0))}</td>
                <td>
                  <button class="btn-secondary" data-edit-pos-venda="${v.id}">Editar</button>
                  <button class="btn-danger" data-del-pos-venda="${v.id}">Excluir</button>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      async function loadPosResumo() {
        try {
          const start = document.getElementById("posResumoIni")?.value;
          const end = document.getElementById("posResumoFim")?.value;
          const params = new URLSearchParams();
          if (start) params.append("start", start);
          if (end) params.append("end", end);
          const res = await apiFetch(`/api/pos/reports/summary?${params.toString()}`);
          const bruto = Number(res?.totals?.bruto || 0);
          const taxas = Number(res?.totals?.taxas || 0);
          const liquido = Number(res?.totals?.liquido || 0);
          document.getElementById("posResumoBruto").textContent = formatCurrencyBRL(bruto);
          document.getElementById("posResumoTaxas").textContent = formatCurrencyBRL(taxas);
          document.getElementById("posResumoLiquido").textContent = formatCurrencyBRL(liquido);
          document.getElementById("posResumoTopCliente").textContent = res.topCliente?.Customer?.name || "?";
          document.getElementById("posResumoTopDia").textContent = res.topDia?.Customer?.name || "?";
          document.getElementById("posResumoMaiorVenda").textContent = res.maiorVenda
            ? `${formatCurrencyBRL(Number(res.maiorVenda.amount || 0))} - ${res.maiorVenda.Customer?.name || ""}`
            : "?";
        } catch (err) {
          console.error("Erro ao carregar resumo POS:", err);
        }
      }

document.getElementById("btnPosSalvarCliente")?.addEventListener("click", savePosCliente);
        document.getElementById("btnPosNovoCliente")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosClienteForm();
        });
        document.getElementById("posCliSearch")?.addEventListener("input", renderPosClientes);
        document.getElementById("posClientesTableBody")?.addEventListener("click", (e) => {
          const tr = e.target.closest("tr[data-id]");
          if (!tr) return;
          const id = Number(tr.getAttribute("data-id"));
          const c = posClientes.find((x) => x.id === id);
          if (c) populatePosClienteForm(c);
        });
        // (demais listeners de POS adicionados abaixo)

        // Clientes
        document
          .getElementById("btnAddCliente")
          .addEventListener("click", () => openClienteForm(null));
        document
          .getElementById("btnCancelCliente")
          .addEventListener("click", closeClienteForm);
        document
          .getElementById("btnSaveCliente")
          .addEventListener("click", saveCliente);

        document
          .getElementById("clienteSearch")
          .addEventListener("input", renderClientes);
        document
          .getElementById("clienteFeeMin")
          .addEventListener("input", renderClientes);
        document
          .getElementById("clienteFeeMax")
          .addEventListener("input", renderClientes);
        document
          .querySelectorAll(".chip-filter[data-cliente-ativo]")
          .forEach((el) => {
            el.addEventListener("click", () => {
              document
                .querySelectorAll(".chip-filter[data-cliente-ativo]")
                .forEach((c) => c.classList.remove("active"));
              el.classList.add("active");
              renderClientes();
            });
          });

        document
          .getElementById("clientesTableBody")
          .addEventListener("click", (e) => {
            const editId = e.target.getAttribute("data-edit-cliente");
            const delId = e.target.getAttribute("data-del-cliente");
            if (editId) {
              const c = clientes.find((x) => x.id == editId);
              if (c) openClienteForm(c);
            } else if (delId) {
              deleteCliente(delId);
            }
          });

        // Empresas
        document
          .getElementById("btnAddEmpresa")
          .addEventListener("click", () => openEmpresaForm(null));
        document
          .getElementById("btnCancelEmpresa")
          .addEventListener("click", closeEmpresaForm);
        document
          .getElementById("btnSaveEmpresa")
          .addEventListener("click", saveEmpresa);

        document
          .getElementById("empresaSearch")
          .addEventListener("input", renderEmpresas);
        document
          .getElementById("relClienteSearch")
          ?.addEventListener("input", () => populateRelatorioSelects());
        document
          .getElementById("relEmpresaSearch")
          ?.addEventListener("input", () => populateRelatorioSelects());
        document
          .getElementById("relEmpresaAtivo")
          ?.addEventListener("change", () => populateRelatorioSelects());
        document
          .querySelectorAll(".chip-filter[data-empresa-ativo]")
          .forEach((el) => {
            el.addEventListener("click", () => {
              document
                .querySelectorAll(".chip-filter[data-empresa-ativo]")
                .forEach((c) => c.classList.remove("active"));
              el.classList.add("active");
              renderEmpresas();
            });
          });

        document
          .getElementById("empresasTableBody")
          .addEventListener("click", (e) => {
            const editId = e.target.getAttribute("data-edit-empresa");
            const delId = e.target.getAttribute("data-del-empresa");
            if (editId) {
              const emp = empresas.find((x) => x.id == editId);
              if (emp) openEmpresaForm(emp);
            } else if (delId) {
              deleteEmpresa(delId);
            }
          });

        // POS (Maquininhas)
      async function deletePosVenda(id) {
        try {
          await apiFetch(`/api/pos/sales/${id}`, { method: "DELETE" });
          await loadPosVendasRecentes();
          await loadPosResumo();
        } catch (err) {
          alert("Erro ao excluir venda POS");
          console.error(err);
        }
      }
      async function loadPosClientes() {
        try {
          const all = await apiFetch("/api/customers");
          posClientes = await Promise.all(
            (all || []).map(async (c) => {
              let rate = null;
              try {
                rate = await apiFetch(`/api/pos/rates/${c.id}`);
              } catch (err) {
                // ignora erro de taxa individual
              }
              return { ...c, PosRate: rate || null };
            })
          );
          renderPosClientes();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar clientes POS:", err);
        }
      }

      function renderPosClientes() {
        const tbody = document.getElementById("posClientesTableBody");
        if (!tbody) return;
        const term = (document.getElementById("posCliSearch")?.value || "").toLowerCase();
        const filtered = (posClientes || []).filter((c) => {
          if (!term) return true;
          const name = (c.name || "").toLowerCase();
          const whats = (c.whatsapp_number || "").toLowerCase();
          const digits = whats.replace(/\D/g, "");
          const tclean = term.replace(/\D/g, "");
          return (
            name.includes(term) ||
            whats.includes(term) ||
            (tclean && digits.includes(tclean))
          );
        });

        tbody.innerHTML = filtered
          .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
          .map((c) => `
            <tr data-id="${c.id}">
              <td>${c.id}</td>
              <td>${c.name || ""}</td>
              <td>${c.whatsapp_number || ""}</td>
              <td>${c.uses_pos === false ? "N?o" : "Sim"}</td>
              <td>${c.uses_nf === false ? "N?o" : "Sim"}</td>
              <td>${Number(c.PosRate?.debit_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_avista_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_2a6_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_7a12_percent || 0).toFixed(2)}%</td>
              <td>${c.PosRate?.pix_key || "?"}</td>
            </tr>
          `)
          .join("");
      }

      function populatePosClienteForm(c) {
        currentPosClienteId = c?.id || null;
        document.getElementById("posCliNome").value = c?.name || "";
        document.getElementById("posCliWhats").value = c?.whatsapp_number || "";
        document.getElementById("posCliPix").value = c?.PosRate?.pix_key || "";
        document.getElementById("posCliDeb").value = c?.PosRate?.debit_percent || "";
        document.getElementById("posCliCredAv").value = c?.PosRate?.credit_avista_percent || "";
        document.getElementById("posCliCred2a6").value = c?.PosRate?.credit_2a6_percent || "";
        document.getElementById("posCliCred7a12").value = c?.PosRate?.credit_7a12_percent || "";
        document.getElementById("posCliAtivo").checked = c?.is_active !== false && c?.uses_pos !== false;
        document.getElementById("posCliUsaNF").checked = c?.uses_nf !== false;
      }

      function resetPosClienteForm() {
        currentPosClienteId = null;
        document.getElementById("posCliNome").value = "";
        document.getElementById("posCliWhats").value = "";
        document.getElementById("posCliPix").value = "";
        document.getElementById("posCliDeb").value = "";
        document.getElementById("posCliCredAv").value = "";
        document.getElementById("posCliCred2a6").value = "";
        document.getElementById("posCliCred7a12").value = "";
        document.getElementById("posCliAtivo").checked = true;
        document.getElementById("posCliUsaNF").checked = false;
      }

      async function savePosCliente() {
        const name = document.getElementById("posCliNome").value.trim();
        const whatsapp_number = document.getElementById("posCliWhats").value.trim();
        const pix_key = document.getElementById("posCliPix").value.trim();
        const debit_percent = Number(document.getElementById("posCliDeb").value || 0);
        const credit_avista_percent = Number(document.getElementById("posCliCredAv").value || 0);
        const credit_2a6_percent = Number(document.getElementById("posCliCred2a6").value || 0);
        const credit_7a12_percent = Number(document.getElementById("posCliCred7a12").value || 0);
        const ativo = document.getElementById("posCliAtivo").checked;
        const usaNF = document.getElementById("posCliUsaNF").checked;

        if (!name || !whatsapp_number) {
          alert("Informe nome e WhatsApp");
          return;
        }

        try {
          const isEdit = !!currentPosClienteId;
          let custId = currentPosClienteId;
          const base = posClientes.find((c) => c.id === custId) || {};
          const payload = {
            name,
            whatsapp_number,
            fee_percent: base.fee_percent ?? 0,
            is_active: ativo,
            uses_pos: ativo,
            uses_nf: usaNF,
          };

          if (isEdit) {
            await apiFetch(`/api/customers/${custId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            const created = await apiFetch("/api/customers", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            custId = created.id;
          }

          await apiFetch(`/api/pos/rates/${custId}`, {
            method: "POST",
            body: JSON.stringify({
              pix_key,
              debit_percent,
              credit_avista_percent,
              credit_2a6_percent,
              credit_7a12_percent,
            }),
          });

          await loadPosClientes();
          resetPosClienteForm();
          alert("Cliente POS salvo");
        } catch (err) {
          alert("Erro ao salvar cliente POS (WhatsApp deve ser unico)");
          console.error(err);
        }
      }
        document.getElementById("btnPosAddCompany")?.addEventListener("click", savePosCompany);
        document.getElementById("btnPosLimparCompany")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosCompanyForm();
        });
        document.getElementById("posCompanySearch")?.addEventListener("input", renderPosCompanies);
        document.getElementById("posCompaniesTableBody")?.addEventListener("click", (e) => {
          const edit = e.target.getAttribute("data-edit-pos-company");
          const del = e.target.getAttribute("data-del-pos-company");
          if (edit) {
            const c = posCompanies.find((x) => x.id == edit);
            if (c) {
              currentPosCompanyId = c.id;
              document.getElementById("posCompanyName").value = c.name;
              document.getElementById("posCompanyCnpj").value = c.cnpj;
              document.getElementById("posCompanyAtiva").value = c.is_active ? "true" : "false";
              const btn = document.getElementById("btnPosAddCompany");
              if (btn) btn.textContent = "Atualizar empresa";
            }
          } else if (del) {
            deletePosCompany(del);
          }
        });

        document.getElementById("btnPosAddTerminal")?.addEventListener("click", savePosTerminal);
        document.getElementById("btnPosLimparTerminal")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosTerminalForm();
        });
        document.getElementById("posTerminalSearch")?.addEventListener("input", renderPosTerminals);
        document.getElementById("posTerminalsTableBody")?.addEventListener("click", (e) => {
          const edit = e.target.getAttribute("data-edit-pos-terminal");
          const del = e.target.getAttribute("data-del-pos-terminal");
          if (edit) {
            const t = posTerminals.find((x) => x.id == edit);
            if (t) {
              populatePosTerminalForm(t);
            }
          } else if (del) {
            deletePosTerminal(del);
          }
        });

        document.getElementById("btnPosSalvarTaxas")?.addEventListener("click", savePosRates);
        document.getElementById("posRateCliente")?.addEventListener("change", loadPosRateForSelected);
        document.getElementById("btnPosRegistrarVenda")?.addEventListener("click", registrarVendaPos);
        document.getElementById("btnPosLimparVenda")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosVendaForm();
        });
        document.getElementById("posVendaTerminalSearch")?.addEventListener("input", () => {
          fillPosSelects();
        });
        document.getElementById("posVendasTableBody")?.addEventListener("click", (e) => {
          const edit = e.target.getAttribute("data-edit-pos-venda");
          const del = e.target.getAttribute("data-del-pos-venda");
          if (edit) {
            const v = posVendasRecentes.find((x) => x.id == edit);
            if (v) populatePosVendaForm(v);
          } else if (del) {
            if (confirm("Excluir venda?")) deletePosVenda(del);
          }
        });
        document.getElementById("btnPosCarregarResumo")?.addEventListener("click", loadPosResumo);

        // Notas
        setupNotasInfiniteScroll();
        document
          .getElementById("notasSearch")
          .addEventListener("input", () => renderNotas());
        document
          .getElementById("notasStatusFilter")
          .addEventListener("change", () => renderNotas());
        document
          .getElementById("notasOrigemFilter")
          .addEventListener("change", () => renderNotas());
        document
          .getElementById("notasApplyFilters")
          .addEventListener("click", () => {
            resetNotasInfiniteScroll();
            notasState.lastFiltersKey = getNotasFiltersKey();
            loadNotasPage(false);
          });
        document
          .getElementById("notasClearFilters")
          .addEventListener("click", () => {
            document.getElementById("notasSearch").value = "";
            document.getElementById("notasStatusFilter").value = "";
            document.getElementById("notasOrigemFilter").value = "";
            document.getElementById("notasDataIni").value = "";
            document.getElementById("notasDataFim").value = "";
            document.querySelectorAll(".chip-filter[data-cliente-ativo], .chip-filter[data-empresa-ativo]").forEach((c) => c.classList.remove("active"));
            resetNotasInfiniteScroll();
            notasState.lastFiltersKey = getNotasFiltersKey();
            renderNotas();
            loadNotasPage(false);
          });

        // Relat√≥rios - tabs
        function setRelTab(tab) {
          document
            .querySelectorAll(".tab-button")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".rel-subsection")
            .forEach((s) => s.classList.add("hidden"));

          if (tab === "geral") {
            document.getElementById("tabRelGeral").classList.add("active");
            document.getElementById("relGeralSection").classList.remove("hidden");
            loadRelatorios();
          } else if (tab === "cliente") {
            document.getElementById("tabRelCliente").classList.add("active");
            document
              .getElementById("relClienteSection")
              .classList.remove("hidden");
            if (!clientes || clientes.length === 0) {
              loadClientes().then(populateRelatorioSelects);
            } else {
              populateRelatorioSelects();
            }
          } else if (tab === "empresa") {
            document.getElementById("tabRelEmpresa").classList.add("active");
            document
              .getElementById("relEmpresaSection")
              .classList.remove("hidden");
            if (!empresas || empresas.length === 0) {
              loadEmpresas().then(populateRelatorioSelects);
            } else {
              populateRelatorioSelects();
            }
          }
        }

        document
          .getElementById("tabRelGeral")
          .addEventListener("click", () => setRelTab("geral"));
        document
          .getElementById("tabRelCliente")
          .addEventListener("click", () => setRelTab("cliente"));
        document
          .getElementById("tabRelEmpresa")
          .addEventListener("click", () => setRelTab("empresa"));

        document
          .getElementById("btnReloadReports")
          .addEventListener("click", loadRelatorios);
        document
          .getElementById("btnRelClienteGerar")
          .addEventListener("click", () => loadRelatorioPorCliente(true));
        document
          .getElementById("btnRelEmpresaGerar")
          .addEventListener("click", () => loadRelatorioPorEmpresa(true));


        // Se j√° tiver token salvo, tenta usar
        if (authToken) {
          showApp();
          const userEmail = localStorage.getItem("nf_user_email") || "Administrador";
          document.getElementById("currentUserEmail").textContent = userEmail;
          selectPage("dashboard");
          loadDashboard();
          loadClientes();
          loadEmpresas();
        } else {
          showLogin();
        }
      }

      // listeners de login
      document.getElementById("btnLogin")?.addEventListener("click", (e) => {
        e.preventDefault();
        doLogin();
      });
      document.getElementById("loginPassword")?.addEventListener("keyup", (e) => {
        if (e.key === "Enter") doLogin();
      });
    });
</script>
  </body>
</html>
      });
      });
    });
    });
      }
      });
