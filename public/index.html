<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>NF Sistema - Painel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js (local para evitar falhas de CDN em ambiente isolado) -->
    <script src="/chart.umd.min.js"></script>

    <style>
      :root {
        --bg: #f5f5f7;
        --bg-elevated: #ffffff;
        --bg-sidebar: #111827;
        --bg-sidebar-hover: #1f2937;
        --bg-input: #f9fafb;

        --text: #111827;
        --text-muted: #6b7280;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.08);
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #16a34a;
        --warning: #f59e0b;

        --radius: 12px;
        --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      body[data-theme="dark"] {
        --bg: #020617;
        --bg-elevated: #020617;
        --bg-sidebar: #020617;
        --bg-sidebar-hover: #0f172a;
        --bg-input: #020617;

        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --primary: #3b82f6;
        --primary-soft: rgba(59, 130, 246, 0.16);
        --border: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button {
        cursor: pointer;
      }

      .app-shell {
        display: flex;
        min-height: 100vh;
      }

      /* SIDEBAR */

      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        color: #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 16px 12px;
        border-right: 1px solid #1f2937;
        box-shadow: 6px 0 18px rgba(0, 0, 0, 0.22);
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
        padding: 8px 10px;
      }

      .sidebar-logo {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }

      .sidebar-title {
        display: flex;
        flex-direction: column;
      }

      .sidebar-title span:first-child {
        font-size: 14px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .sidebar-title span:last-child {
        font-weight: 600;
      }

      .sidebar-nav {
        flex: 1;
      }

      .sidebar-section-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #6b7280;
        padding: 0 10px;
        margin: 12px 0 6px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        margin: 2px 0;
        color: #cbd5e1;
        font-size: 14px;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        border: 1px solid transparent;
      }

      .nav-item span.icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 24px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        font-size: 12px;
        font-weight: 700;
        color: inherit;
        letter-spacing: 0.05em;
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.06);
        color: #f9fafb;
        border-color: rgba(255, 255, 255, 0.08);
      }

      .nav-item.active .icon {
        background: rgba(255, 255, 255, 0.12);
      }

      .nav-item:hover {
        background: var(--bg-sidebar-hover);
        color: #e5e7eb;
        border-color: rgba(255, 255, 255, 0.08);
      }

      .sidebar-footer {
        padding: 12px 10px 4px;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
        color: #6b7280;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(15, 23, 42, 0.8);
        padding: 8px 11px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .theme-toggle button {
        border: none;
        background: transparent;
        color: #e5e7eb;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .user-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .user-tag {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #6b7280;
      }

      .btn-logout {
        border-radius: 999px;
        border: 1px solid rgba(239, 68, 68, 0.5);
        background: rgba(127, 29, 29, 0.3);
        padding: 4px 9px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #fecaca;
      }

      /* TOPBAR & MAIN */

      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 100%;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(10px);
        background: color-mix(in srgb, var(--bg) 80%, transparent 20%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 18px;
        border-bottom: 1px solid var(--border);
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mobile-menu-btn {
        display: none;
        border: none;
        background: var(--bg-elevated);
        border-radius: 999px;
        padding: 6px 9px;
        box-shadow: var(--shadow-soft);
      }

      .topbar-title {
        font-weight: 600;
        font-size: 15px;
      }

      .topbar-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chip {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--primary-soft);
        color: var(--primary);
        font-size: 11px;
        border: 1px solid rgba(37, 99, 235, 0.24);
      }

      .content {
        padding: 16px 18px 24px;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      /* CARDS & PANELS */

      .card {
        background: var(--bg-elevated);
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        padding: 16px;
        border: 1px solid var(--border);
      }

      .card + .card {
        margin-top: 12px;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .card-title {
        font-weight: 600;
        font-size: 15px;
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .badge {
        border-radius: 999px;
        padding: 3px 7px;
        font-size: 11px;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }

      .grid {
        display: grid;
        gap: 12px;
      }

      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      /* Para quando mostrar um Ãºnico bloco POS ocupar largura total */
      .pos-single {
        grid-column: 1 / -1;
      }

      @media (max-width: 900px) {
        .grid-3,
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .metric-card {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, var(--primary-soft), transparent 55%);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .metric-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-value {
        font-size: 20px;
        font-weight: 600;
      }

      .metric-detail {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* FORMS & INPUTS */

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 140px;
      }

      label {
        font-size: 11px;
        margin-bottom: 4px;
        color: var(--text-muted);
      }

      input,
      select {
        padding: 7px 9px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-input);
        color: var(--text);
        font-size: 13px;
      }

      input:focus,
      select:focus {
        outline: 2px solid var(--primary-soft);
        border-color: var(--primary);
      }

      /* Ajusta o Ã­cone do calendar picker para ficar visÃ­vel em fundo escuro/claro */
      input[type="date"]::-webkit-calendar-picker-indicator,
      input[type="datetime-local"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        opacity: 0.8;
      }

      .btn-primary {
        border-radius: 8px;
        border: none;
        background: var(--primary);
        color: white;
        padding: 8px 14px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-secondary {
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        padding: 7px 12px;
        font-size: 13px;
      }

      .btn-danger {
        border-radius: 8px;
        border: none;
        background: var(--danger);
        color: white;
        padding: 6px 10px;
        font-size: 12px;
      }

      .btn-ghost {
        border-radius: 8px;
        border: none;
        background: transparent;
        padding: 6px 8px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .toolbar-left,
      .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chip-filter {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        cursor: pointer;
      }

      .chip-filter.active {
        background: var(--primary-soft);
        color: var(--primary);
        border-color: rgba(37, 99, 235, 0.5);
      }

      /* TABLES */

      .table-wrapper {
        margin-top: 8px;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: auto;
        max-height: 480px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: color-mix(in srgb, var(--bg-elevated) 80%, var(--border) 20%);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }

      tbody tr:hover {
        background: color-mix(in srgb, var(--bg-elevated) 80%, var(--primary-soft) 20%);
      }

      .status-pill {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .status-emitida {
        background: rgba(59, 130, 246, 0.08);
        color: #1d4ed8;
      }

      .status-paga {
        background: rgba(22, 163, 74, 0.09);
        color: #15803d;
      }

      .status-cancelada {
        background: rgba(239, 68, 68, 0.09);
        color: #b91c1c;
      }

      .tag {
        font-size: 11px;
        padding: 3px 7px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }

      .tag-success {
        background: rgba(22, 163, 74, 0.08);
        color: #16a34a;
        border-color: rgba(22, 163, 74, 0.5);
      }
      .tag-danger {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.5);
      }

      .tag-muted {
        color: var(--text-muted);
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 12px;
      }
      .modal-card {
        background: var(--bg-elevated);
        color: var(--text);
        border-radius: 14px;
        padding: 16px;
        width: 100%;
        max-width: 540px;
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border);
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .modal-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .modal-field {
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: color-mix(in srgb, var(--bg-elevated) 85%, var(--border) 15%);
      }
      .modal-field label {
        display: block;
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }
      .modal-field .value {
        font-weight: 600;
        font-size: 13px;
      }

      /* INFINITE SCROLL STATE */

      .loader-row {
        text-align: center;
        padding: 10px;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* LOGIN OVERLAY */

      .overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.2), transparent 50%),
          radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.18), transparent 50%),
          var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .login-card {
        width: 100%;
        max-width: 380px;
        background: var(--bg-elevated);
        border-radius: 18px;
        padding: 20px 18px 18px;
        box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
        border: 1px solid var(--border);
      }

      .login-title {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 4px;
      }

      .login-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 14px;
      }

      .login-footer {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: var(--text-muted);
      }

      .link {
        color: var(--primary);
        cursor: pointer;
      }

      .error-text {
        font-size: 12px;
        color: var(--danger);
        margin-top: 6px;
      }

      .success-text {
        font-size: 12px;
        color: var(--success);
        margin-top: 6px;
      }

      /* SECTIONS VISIBILITY */

      .page-section {
        display: none;
      }

      .page-section.active {
        display: block;
      }

      /* RELATÃ“RIOS TABS */

      .tabs {
        display: inline-flex;
        border-radius: 999px;
        padding: 3px;
        background: color-mix(in srgb, var(--bg-elevated) 70%, var(--border) 30%);
        border: 1px solid var(--border);
        gap: 3px;
      }

      .tab-button {
        border: none;
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 12px;
        background: transparent;
        color: var(--text-muted);
      }

      .tab-button.active {
        background: var(--bg-elevated);
        color: var(--primary);
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      }

      .rel-subsection {
        margin-top: 14px;
      }

      .rel-subsection.hidden {
        display: none;
      }

      /* MOBILE SIDEBAR */

      @media (max-width: 900px) {
        .sidebar {
          position: fixed;
          inset: 0 auto 0 0;
          transform: translateX(-100%);
          transition: transform 0.2s ease;
          z-index: 50;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .sidebar-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(4px);
          z-index: 40;
          display: none;
        }

        .sidebar-backdrop.show {
          display: block;
        }

        .mobile-menu-btn {
          display: inline-flex;
        }
      }
    </style>
  </head>
  <body data-theme="light">
    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="overlay">
      <div class="login-card">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px">
          <div
            style="
              width: 32px;
              height: 32px;
              border-radius: 999px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: linear-gradient(135deg, #2563eb, #6366f1);
              color: white;
              font-weight: 700;
            "
          >
            NF
          </div>
          <div>
            <div class="login-title">NF Sistema</div>
            <div class="login-subtitle">Acesso ao painel administrativo</div>
          </div>
        </div>

        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="loginEmail" placeholder="admin@exemplo.com" />
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" id="loginPassword" placeholder="Sua senha" />
        </div>
        <div id="loginError" class="error-text" style="display: none"></div>

        <button id="btnLogin" class="btn-primary" style="width: 100%; margin-top: 10px">
          Entrar
        </button>

        <div class="login-footer">
          <span class="link" id="forgotPasswordLink">Esqueci minha senha</span>
          <span>Â© NF Sistema</span>
        </div>

        <div id="forgotInfo" class="success-text" style="display: none"></div>
      </div>
    </div>

    <!-- APP SHELL -->
    <div class="app-shell" id="appShell" style="display: none">
      <!-- SIDEBAR -->
      <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">NF</div>
          <div class="sidebar-title">
            <span>Painel</span>
            <span>NF Sistema</span>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="sidebar-section-label">Visao Geral</div>
          <div class="nav-item" data-page="dashboard">
            <span class="icon">D</span>
            <span>Dashboard</span>
          </div>

          <div class="sidebar-section-label">Cadastros</div>
          <div class="nav-item" data-page="clientes">
            <span class="icon">CL</span>
            <span>Cadastro de Clientes</span>
          </div>

          <div class="sidebar-section-label">Nota Fiscal</div>
          <div class="nav-item" data-page="empresas">
            <span class="icon">E</span>
            <span>Empresas</span>
          </div>
          <div class="nav-item" data-page="notas">
            <span class="icon">NF</span>
            <span>Notas Fiscais</span>
          </div>
          <div class="nav-item" data-page="relatorios">
            <span class="icon">R</span>
            <span>Relatorios</span>
          </div>

          <div class="sidebar-section-label">Maquininhas</div>
          <div class="nav-item" data-page="pos-empresas">
            <span class="icon">PE</span>
            <span>Empresas POS</span>
          </div>
          <div class="nav-item" data-page="pos-terminais">
            <span class="icon">PT</span>
            <span>Terminais</span>
          </div>
          <div class="nav-item" data-page="pos-vendas">
            <span class="icon">PV</span>
            <span>Vendas</span>
          </div>
          <div class="nav-item" data-page="pos-resumo">
            <span class="icon">PR</span>
            <span>Resumo POS</span>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="theme-toggle">
            <div style="display: flex; flex-direction: column; gap: 2px">
              <span style="font-size: 11px; color: #9ca3af">Tema</span>
              <span style="font-size: 12px">Claro / Escuro</span>
            </div>
            <button id="btnThemeToggle">ðŸŒ“</button>
          </div>

          <div class="user-info">
            <div>
              <div class="user-tag">UsuÃ¡rio logado</div>
              <div id="currentUserEmail" style="font-size: 12px">â€”</div>
            </div>
            <button class="btn-logout" id="btnLogout">Sair</button>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main" id="main">
        <header class="topbar">
          <div class="topbar-left">
            <button class="mobile-menu-btn" id="btnMobileMenu">â˜°</button>
            <div>
              <div class="topbar-title" id="topbarTitle">Dashboard</div>
              <div class="topbar-subtitle" id="topbarSubtitle">
                VisÃ£o geral das notas fiscais, clientes e empresas
              </div>
            </div>
          </div>
          <div class="topbar-right">
            <div class="chip">ProduÃ§Ã£o</div>
          </div>
        </header>

        <section class="content">
          <!-- DASHBOARD -->
          <section id="page-dashboard" class="page-section active">
            <div class="form-row" style="gap:10px; align-items:flex-end; margin-bottom:10px">
              <div class="form-group" style="max-width:160px">
                <label>MÃªs</label>
                <select id="dashMesSelect">
                  <option value="0">Janeiro</option>
                  <option value="1">Fevereiro</option>
                  <option value="2">MarÃ§o</option>
                  <option value="3">Abril</option>
                  <option value="4">Maio</option>
                  <option value="5">Junho</option>
                  <option value="6">Julho</option>
                  <option value="7">Agosto</option>
                  <option value="8">Setembro</option>
                  <option value="9">Outubro</option>
                  <option value="10">Novembro</option>
                  <option value="11">Dezembro</option>
                </select>
              </div>
              <div class="form-group" style="max-width:120px">
                <label>Ano</label>
                <input type="number" id="dashAnoInput" min="2000" />
              </div>
              <div class="form-group" style="max-width:200px; display:flex; gap:6px">
                <button class="btn-secondary" id="dashAplicarMes" style="flex:1">Aplicar</button>
                <button class="btn-secondary" id="dashMesAtual" style="flex:1">MÃªs atual</button>
              </div>
            </div>
            <div class="grid grid-3">
              <div class="card metric-card">
                <div class="metric-label">Total de notas</div>
                <div class="metric-value" id="dashTotalNotas">-</div>
                <div class="metric-detail">
                  Soma de todas as notas emitidas no perÃ­odo selecionado
                </div>
              </div>
              <div class="card metric-card">
                <div class="metric-label">Valor total</div>
                <div class="metric-value" id="dashValorTotal">â€”</div>
                <div class="metric-detail">
                  Considerando notas emitidas (EMITIDA + PAGA)
                </div>
              </div>
              <div class="card metric-card">
                <div class="metric-label">Total taxas</div>
                <div class="metric-value" id="dashTaxas">â€”</div>
                <div class="metric-detail">Com base na comissÃ£o configurada dos clientes</div>
              </div>
            </div>

            <div class="grid grid-2" style="margin-top: 14px">
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Notas por dia (Ãºltimos 30 dias)</div>
                    <div class="card-subtitle">Volume diÃ¡rio de emissÃµes</div>
                  </div>
                  <span class="badge">Linhas</span>
                </div>
                <canvas id="chartNotasDia"></canvas>
              </div>

              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Status das notas</div>
                    <div class="card-subtitle">DistribuiÃ§Ã£o por status atual</div>
                  </div>
                  <span class="badge">Pizza</span>
                </div>
                <canvas id="chartStatus"></canvas>
              </div>
            </div>
          </section>

          <!-- CLIENTES -->
          <section id="page-clientes" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cadastro de Clientes</div>
                  <div class="card-subtitle">
                    Clientes unicos para Nota Fiscal e Maquininhas, com taxas condicionais por servico
                  </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button id="btnAddCliente" class="btn-secondary">Novo / limpar</button>
                  <button id="btnSaveCliente" class="btn-primary">Salvar cliente</button>
                </div>
              </div>

              <div class="toolbar">
                <div class="toolbar-left">
                  <div class="form-group" style="min-width: 180px">
                    <label>Buscar por nome ou WhatsApp</label>
                    <input
                      type="text"
                      id="clienteSearch"
                      placeholder="Digite para filtrar..."
                    />
                  </div>
                </div>
                <div class="toolbar-right">
                  <span class="chip-filter active" data-cliente-ativo="all">Todos</span>
                  <span class="chip-filter" data-cliente-ativo="true">Ativos</span>
                  <span class="chip-filter" data-cliente-ativo="false">Inativos</span>
                </div>
              </div>

              <!-- FORM CLIENTE -->
              <div id="clienteFormWrapper" style="margin-bottom: 10px">
                <div
                  style="
                    padding: 10px;
                    border-radius: 12px;
                    border: 1px dashed var(--border);
                    background: color-mix(
                      in srgb,
                      var(--primary-soft) 25%,
                      var(--bg-elevated) 75%
                    );
                  "
                >
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nome do cliente</label>
                      <input type="text" id="clienteNome" />
                    </div>
                    <div class="form-group">
                      <label>WhatsApp (unico)</label>
                      <input type="text" id="clienteWhats" placeholder="+55..." />
                    </div>
                    <div class="form-group">
                      <label>Chave PIX</label>
                      <input type="text" id="clientePix" placeholder="Opcional" />
                    </div>
                    <div class="form-group" style="max-width: 120px">
                      <label>Status geral</label>
                      <select id="clienteAtivo">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group checkbox">
                      <label><input type="checkbox" id="clienteUsaPOS" /> Ativo POS</label>
                    </div>
                    <div class="form-group checkbox">
                      <label><input type="checkbox" id="clienteUsaNF" checked /> Ativo Nota Fiscal</label>
                    </div>
                  </div>
                  <div class="form-row" id="clienteNfFields" style="display:none">
                    <div class="form-group" style="max-width: 140px">
                      <label>Taxa Nota Fiscal (%)</label>
                      <input type="number" id="clienteTaxa" step="0.01" />
                    </div>
                  </div>
                  <div class="form-row" id="clientePosFields" style="display:none">
                    <div class="form-group">
                      <label>Debito (%)</label>
                      <input id="clienteDeb" type="number" step="0.01" />
                    </div>
                    <div class="form-group">
                      <label>Credito a vista (%)</label>
                      <input id="clienteCredAv" type="number" step="0.01" />
                    </div>
                  </div>
                  <div class="form-row" id="clientePosFields2" style="display:none">
                    <div class="form-group">
                      <label>Credito 2 a 6x (%)</label>
                      <input id="clienteCred2a6" type="number" step="0.01" />
                    </div>
                    <div class="form-group">
                      <label>Credito 7 a 12x (%)</label>
                      <input id="clienteCred7a12" type="number" step="0.01" />
                    </div>
                  </div>
                  <div id="clienteFormError" class="error-text" style="display: none"></div>
                </div>
              </div>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome</th>
                      <th>WhatsApp</th>
                      <th>NF</th>
                      <th>Taxa NF (%)</th>
                      <th>POS</th>
                      <th>Debito</th>
                      <th>Cr av</th>
                      <th>2-6x</th>
                      <th>7-12x</th>
                      <th>PIX</th>
                      <th>Status</th>
                      <th>Criado em</th>
                      <th>Acoes</th>
                    </tr>
                  </thead>
                  <tbody id="clientesTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>
          <!-- EMPRESAS -->
          <section id="page-empresas" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Empresas emissoras</div>
                  <div class="card-subtitle">
                    Cadastro das empresas autorizadas a emitir notas fiscais
                  </div>
                </div>
                <button id="btnAddEmpresa" class="btn-primary">+ Adicionar empresa</button>
              </div>

              <div class="toolbar">
                <div class="toolbar-left">
                  <div class="form-group" style="min-width: 180px">
                    <label>Nome / CNPJ</label>
                    <input
                      type="text"
                      id="empresaSearch"
                      placeholder="Digite parte do nome ou CNPJ..."
                    />
                  </div>
                </div>
                <div class="toolbar-right">
                  <span class="chip-filter active" data-empresa-ativo="all">Todas</span>
                  <span class="chip-filter" data-empresa-ativo="true">Ativas</span>
                  <span class="chip-filter" data-empresa-ativo="false">Inativas</span>
                </div>
              </div>

              <!-- FORM EMPRESA -->
              <div id="empresaFormWrapper" style="display: none; margin-bottom: 10px">
                <div
                  style="
                    padding: 10px;
                    border-radius: 12px;
                    border: 1px dashed var(--border);
                    background: color-mix(
                      in srgb,
                      var(--primary-soft) 25%,
                      var(--bg-elevated) 75%
                    );
                  "
                >
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nome da empresa</label>
                      <input type="text" id="empresaNome" />
                    </div>
                    <div class="form-group">
                      <label>CNPJ</label>
                      <input type="text" id="empresaCnpj" />
                    </div>
                    <div class="form-group">
                      <label>Chave de acesso</label>
                      <input type="text" id="empresaChave" />
                    </div>
                    <div class="form-group" style="max-width: 120px">
                      <label>Status</label>
                      <select id="empresaAtiva">
                        <option value="true">Ativa</option>
                        <option value="false">Inativa</option>
                      </select>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: flex-end; gap: 8px">
                    <button id="btnCancelEmpresa" class="btn-secondary">Cancelar</button>
                    <button id="btnSaveEmpresa" class="btn-primary">Salvar</button>
                  </div>
                  <div id="empresaFormError" class="error-text" style="display: none"></div>
                </div>
              </div>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome</th>
                      <th>CNPJ</th>
                      <th>Status</th>
                      <th>Criada em</th>
                      <th>AÃ§Ãµes</th>
                    </tr>
                  </thead>
                  <tbody id="empresasTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- NOTAS -->
          <section id="page-notas" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Notas fiscais</div>
                  <div class="card-subtitle">
                    Listagem com carregamento automÃ¡tico (scroll infinito)
                  </div>
                </div>
              </div>

              <div class="form-row" style="gap:10px; align-items:flex-end">
                <div class="form-group" style="flex:2; min-width:220px">
                  <label>Buscar por cliente / empresa / comprador / CPF</label>
                  <input
                    type="text"
                    id="notasSearch"
                    placeholder="Nome, empresa ou CPF do comprador"
                  />
                </div>
                <div class="form-group" style="max-width: 150px">
                  <label>Status</label>
                  <select id="notasStatusFilter">
                    <option value="all">Todos</option>
                    <option value="EMITIDA">Emitida</option>
                    <option value="PAGA">Paga</option>
                    <option value="CANCELADA">Cancelada</option>
                  </select>
                </div>
                <div class="form-group" style="max-width: 150px">
                  <label>Origem</label>
                  <select id="notasOrigemFilter">
                    <option value="all">Todas</option>
                    <option value="terminal">Maquininha</option>
                    <option value="manual">Manual</option>
                  </select>
                </div>
                <div class="form-group" style="max-width: 160px">
                  <label>Data inicial</label>
                  <input type="date" id="notasDataIni" />
                </div>
                <div class="form-group" style="max-width: 160px">
                  <label>Data final</label>
                  <input type="date" id="notasDataFim" />
                </div>
                <div class="form-group" style="max-width: 220px; display:flex; gap:6px">
                  <button id="notasApplyFilters" class="btn-secondary" style="flex:1">Aplicar filtros</button>
                  <button id="notasClearFilters" class="btn-secondary" style="flex:1">Limpar filtros</button>
                </div>
              </div>

              <div class="table-wrapper" id="notasTableWrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Data emissÃ£o</th>
                      <th>Cliente</th>
                      <th>Empresa</th>
                      <th>Comprador</th>
                      <th>CPF comprador</th>
                      <th>Valor total</th>
                      <th>Valor pago</th>
                      <th>Taxa (%)</th>
                      <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal</th>
                      <th>NSU</th>
                      <th>NF-e</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="notasTableBody"></tbody>
                </table>
                <div id="notasLoaderRow" class="loader-row">
                  <span id="notasLoaderText">Rolando para carregar maisâ€¦</span>
                </div>
              </div>
            </div>
          </section>          <!-- MAQUININHAS -->
          <section id="page-pos-empresas" class="page-section">
            <div class="card pos-block">
              <div class="card-header">
                <div>
                  <div class="card-title">Empresas POS</div>
                  <div class="card-subtitle">Adquirentes da maquininha</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Nome</label><input id="posCompanyName" /></div>
                <div class="form-group"><label>CNPJ</label><input id="posCompanyCnpj" /></div>
                <div class="form-group" style="max-width:140px"><label>Status</label><select id="posCompanyAtiva"><option value="true">Ativa</option><option value="false">Inativa</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Buscar (nome/CNPJ)</label><input id="posCompanySearch" placeholder="Filtrar" /></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparCompany" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosAddCompany">Salvar empresa</button>
              <div class="table-wrapper" style="max-height:200px; margin-top:10px">
                <table><thead><tr><th>ID</th><th>Nome</th><th>CNPJ</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="posCompaniesTableBody"></tbody></table>
              </div>
            </div>
          </section>

          <section id="page-pos-terminais" class="page-section">
            <div class="card pos-block">
              <div class="card-header">
                <div>
                  <div class="card-title">Terminais</div>
                  <div class="card-subtitle">Vincule empresa e cliente</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Empresa</label><select id="posTerminalEmpresa"></select></div>
                <div class="form-group"><label>Cliente</label><select id="posTerminalCliente"></select></div>
                <div class="form-group"><label>Codigo</label><input id="posTerminalCode" /></div>
                <div class="form-group" style="max-width:140px"><label>Status</label><select id="posTerminalAtivo"><option value="true">Ativo</option><option value="false">Inativo</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Buscar terminal / empresa / cliente</label><input id="posTerminalSearch" placeholder="Filtrar" /></div>
                <div class="form-group" style="max-width:140px"><label>Filtro status</label><select id="posTerminalStatusFilter"><option value="all">Todos</option><option value="true">Ativos</option><option value="false">Inativos</option></select></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparTerminal" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosAddTerminal">Salvar terminal</button>
              <div class="table-wrapper" style="max-height:320px; margin-top:10px">
                <table><thead><tr><th>ID</th><th>Terminal</th><th>Empresa</th><th>Cliente</th><th>Status</th><th>DÃ©b</th><th>Cr av</th><th>2-6x</th><th>7-12x</th><th>PIX</th><th>AÃ§Ãµes</th></tr></thead><tbody id="posTerminalsTableBody"></tbody></table>
              </div>
            </div>
          </section>

          <section id="page-pos-clientes" class="page-section">
            <div class="card pos-block">
              <div class="card-header"><div><div class="card-title">Clientes POS</div><div class="card-subtitle">Cadastro rapido com taxas e PIX</div></div></div>
              <div class="form-row">
                <div class="form-group"><label>Busca cliente (nome/Whats)</label><input id="posCliSearch" placeholder="Buscar" /></div>
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosNovoCliente" style="width:100%">Novo / limpar</button></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Nome</label><input id="posCliNome" /></div>
                <div class="form-group"><label>WhatsApp (unico)</label><input id="posCliWhats" /></div>
                <div class="form-group"><label>PIX</label><input id="posCliPix" /></div>
              </div>
              <div class="form-row">
                <div class="form-group checkbox"><label><input type="checkbox" id="posCliAtivo" checked /> Ativo no POS</label></div>
                <div class="form-group checkbox"><label><input type="checkbox" id="posCliUsaNF" /> Ativo para Nota Fiscal</label></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Debito (%)</label><input id="posCliDeb" type="number" step="0.01" /></div>
                <div class="form-group"><label>Credito a vista (%)</label><input id="posCliCredAv" type="number" step="0.01" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Credito 2 a 6x (%)</label><input id="posCliCred2a6" type="number" step="0.01" /></div>
                <div class="form-group"><label>Credito 7 a 12x (%)</label><input id="posCliCred7a12" type="number" step="0.01" /></div>
              </div>
              <button class="btn-primary" id="btnPosSalvarCliente">Salvar cliente</button>
              <div class="table-wrapper" style="max-height: 220px; margin-top:10px">
                <table>
                  <thead>
                    <tr><th>ID</th><th>Nome</th><th>Whats</th><th>POS</th><th>NF</th><th>Deb</th><th>Cred av</th><th>2-6x</th><th>7-12x</th><th>PIX</th><th>Acoes</th></tr>
                  </thead>
                  <tbody id="posClientesTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="page-pos-vendas" class="page-section">
              <div class="card pos-block">
              <div class="card-header"><div><div class="card-title">Registrar venda</div><div class="card-subtitle">Terminal, data/hora, valor, forma, NSU</div></div></div>
              <div class="form-row">
                <div class="form-group"><label>Buscar terminal/cliente</label><input id="posVendaTerminalSearch" placeholder="Filtrar" /></div>
                <div class="form-group"><label>Terminal</label><select id="posVendaTerminal"></select></div>
                <div class="form-group"><label>Data/hora</label><input id="posVendaData" type="datetime-local" /></div>
                <div class="form-group" style="max-width:180px"><label>Status</label><select id="posVendaStatusFilter"><option value="all">Todos</option><option value="paid">Pagos</option><option value="unpaid">A pagar</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Valor</label><input id="posVendaValor" type="number" step="0.01" /></div>
                <div class="form-group"><label>Forma</label><select id="posVendaForma"><option value="DEBITO">Debito</option><option value="CREDITO_AVISTA">Credito a vista</option><option value="CREDITO_2A6">Credito 2 a 6x</option><option value="CREDITO_7A12">Credito 7 a 12x</option><option value="PIX">PIX</option></select></div>
                <div class="form-group"><label>NSU</label><input id="posVendaNsu" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>&nbsp;</label><button class="btn-secondary" id="btnPosLimparVenda" style="width:100%">Novo / limpar</button></div>
              </div>
              <button class="btn-primary" id="btnPosRegistrarVenda">Salvar venda</button>
              <div id="posVendaMsg" class="success-text" style="display:none; margin-top:8px"></div>
            </div>
              <div class="card pos-block" style="margin-top: 12px">
              <div class="card-header"><div><div class="card-title">Vendas recentes</div><div class="card-subtitle">Ultimas 50 vendas</div></div></div>
              <div class="table-wrapper" style="max-height: 360px">
                <table>
                  <thead><tr><th>Data</th><th>Cliente</th><th>Terminal</th><th>Forma</th><th>%</th><th>Bruto</th><th>Taxa</th><th>Liquido</th><th>Status</th><th>Acoes</th></tr></thead>
                  <tbody id="posVendasTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="page-pos-resumo" class="page-section">
            <div class="card pos-block">
              <div class="card-header">
                <div>
                  <div class="card-title">Fechamento POS</div>
                  <div class="card-subtitle">Filtre por perÃ­odo/terminal, marque como pago e evite duplicidade</div>
                </div>
                <div style="display:flex; gap:6px; align-items:center">
                  <button class="btn-ghost" id="btnPosLimparResumo" style="padding:6px 10px">Limpar</button>
                  <button class="btn-secondary" id="btnPosCarregarResumo" style="padding:6px 10px">Atualizar</button>
                </div>
              </div>
              <div class="form-row" style="margin-bottom:8px">
                <div class="form-group"><label>Data inicial</label><input id="posResumoIni" type="date" /></div>
                <div class="form-group"><label>Data final</label><input id="posResumoFim" type="date" /></div>
                <div class="form-group"><label>Terminal</label><select id="posResumoTerminal"><option value="">Todos</option></select></div>
                <div class="form-group checkbox" style="align-self:flex-end"><label><input type="checkbox" id="posResumoOnlyUnpaid" /> Somente a pagar</label></div>
              </div>
              <div class="grid grid-3">
                <div class="metric-card"><div class="metric-label">Bruto perÃ­odo</div><div class="metric-value" id="posResumoBruto">?</div></div>
                <div class="metric-card"><div class="metric-label">Taxas perÃ­odo</div><div class="metric-value" id="posResumoTaxas">?</div></div>
                <div class="metric-card"><div class="metric-label">LÃ­quido perÃ­odo</div><div class="metric-value" id="posResumoLiquido">?</div></div>
              </div>
              <div class="grid grid-2" style="margin-top:8px">
                <div class="metric-card"><div class="metric-label">A pagar</div><div class="metric-value" id="posResumoAPagar">?</div></div>
                <div class="metric-card"><div class="metric-label">Pago</div><div class="metric-value" id="posResumoPago">?</div></div>
              </div>
              <div class="grid grid-2" style="margin-top:10px">
                <div class="metric-card"><div class="metric-label">Top terminal perÃ­odo</div><div class="metric-value" id="posResumoTopTerminal">?</div><div class="metric-detail" id="posResumoTopTerminalOwner"></div></div>
                <div class="metric-card"><div class="metric-label">Maior venda perÃ­odo</div><div class="metric-value" id="posResumoMaiorVenda">?</div><div class="metric-detail" id="posResumoMaiorVendaInfo"></div></div>
              </div>
              <div class="table-wrapper" style="margin-top:12px; max-height:320px">
                <table>
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="posResumoSelectAll" /></th>
                      <th>Data</th>
                      <th>Terminal</th>
                      <th>Cliente</th>
                      <th>Bruto</th>
                      <th>Taxa</th>
                      <th>Liquido</th>
                      <th>Status</th>
                      <th>Ver</th>
                    </tr>
                  </thead>
                  <tbody id="posResumoTabela"></tbody>
                </table>
              </div>
              <div class="grid grid-3" style="margin-top:10px">
                <div class="metric-card"><div class="metric-label">Total selecionado a pagar</div><div class="metric-value" id="posResumoTotalSelecionado">R$ 0,00</div></div>
                <div class="metric-card"><div class="metric-label">PIX do cliente</div><div class="metric-value" id="posResumoPix">â€”</div></div>
                <div class="metric-card"><div class="metric-label">Avisos</div><div class="metric-value" style="font-size:13px" id="posResumoSelectMsg"></div></div>
              </div>
              <div class="form-row" style="margin-top:10px">
                <div class="form-group" style="flex:1">
                  <input id="posResumoBatch" placeholder="Identificador do pagamento (opcional)" />
                </div>
                <div class="form-group" style="max-width:200px">
                  <button class="btn-primary" id="btnPosMarcarPago" style="width:100%">Marcar selecionados como pagos</button>
                </div>
              </div>
            </div>
          </section>

          <section id="page-relatorios" class="page-section">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">RelatÃ³rios</div>
                  <div class="card-subtitle">
                    VisÃ£o consolidada por perÃ­odo, cliente e empresa
                  </div>
                </div>
                <div class="tabs">
                  <button
                    class="tab-button active"
                    data-rel-tab="geral"
                    id="tabRelGeral"
                  >
                    VisÃ£o geral
                  </button>
                  <button class="tab-button" data-rel-tab="cliente" id="tabRelCliente">
                    Por cliente
                  </button>
                  <button class="tab-button" data-rel-tab="empresa" id="tabRelEmpresa">
                    Por empresa
                  </button>
                </div>
              </div>

              <!-- VISÃƒO GERAL -->
              <div
                class="rel-subsection"
                id="relGeralSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relDataFim" />
                    </div>
                    <div class="form-group">
                      <label>Agrupar por</label>
                      <select id="relGroupBy">
                        <option value="day">Dia</option>
                        <option value="month">MÃªs</option>
                      </select>
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnReloadReports" class="btn-secondary">
                      Atualizar relatÃ³rios
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Notas no perÃ­odo</div>
                    <div class="metric-value" id="relTotalNotas">â€”</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Valor total (R$)</div>
                    <div class="metric-value" id="relValorTotal">â€”</div>
                    <div class="metric-detail">Soma do valor total das notas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Taxas totais (R$)</div>
                    <div class="metric-value" id="relTaxasTotal">â€”</div>
                    <div class="metric-detail">
                      SomatÃ³rio das taxas cobradas dos clientes
                    </div>
                  </div>
                </div>

                <div class="grid grid-2" style="margin-top: 14px">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas por perÃ­odo</div>
                        <div class="card-subtitle">Agrupado por dia ou mÃªs</div>
                      </div>
                    </div>
                    <canvas id="chartRelPeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Top cliente / empresa</div>
                        <div class="card-subtitle">
                          Maior nÃºmero de notas e maior volume financeiro
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px">
                      <div>
                        <span class="tag tag-muted">Cliente com mais notas</span>
                        <div id="relTopCliente" style="margin-top: 4px">â€”</div>
                      </div>
                      <div>
                        <span class="tag tag-muted">Empresa com maior volume</span>
                        <div id="relTopEmpresa" style="margin-top: 4px">â€”</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- POR CLIENTE -->
              <div
                class="rel-subsection hidden"
                id="relClienteSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Buscar cliente</label>
                      <input
                        type="text"
                        id="relClienteSearch"
                        placeholder="Nome ou WhatsApp"
                      />
                    </div>
                    <div class="form-group">
                      <label>Cliente</label>
                      <select id="relClienteSelect">
                        <option value="">Selecione um cliente</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relClienteDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relClienteDataFim" />
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnRelClienteGerar" class="btn-secondary">
                      Gerar relatÃ³rio por cliente
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Cliente</div>
                    <div class="metric-value" id="relClienteNome">â€”</div>
                    <div class="metric-detail" id="relClienteWhats">WhatsApp: â€”</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Notas no perÃ­odo</div>
                    <div class="metric-value" id="relClienteTotalNotas">â€”</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Total faturado / Taxas</div>
                    <div class="metric-detail">
                      Faturamento: <span id="relClienteValorTotal">â€”</span>
                    </div>
                    <div class="metric-detail">
                      Taxas: <span id="relClienteTaxasTotal">â€”</span>
                    </div>
                  </div>
                </div>

                <div class="grid grid-2 rel-subsection">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas do cliente por perÃ­odo</div>
                        <div class="card-subtitle">Volume diÃ¡rio/mensal</div>
                      </div>
                    </div>
                    <canvas id="chartRelClientePeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas por empresa</div>
                        <div class="card-subtitle">
                          Empresas que mais emitiram para este cliente
                        </div>
                      </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 260px">
                      <table>
                        <thead>
                          <tr>
                            <th>Empresa</th>
                            <th>Notas</th>
                            <th>Valor total</th>
                          </tr>
                        </thead>
                        <tbody id="relClienteEmpresasBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="card rel-subsection">
                  <div class="card-header">
                    <div>
                      <div class="card-title">Notas do cliente</div>
                      <div class="card-subtitle">
                        Lista completa das notas dentro do perÃ­odo
                      </div>
                    </div>
                  </div>
                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>EmissÃ£o</th>
                          <th>Empresa</th>
                          <th>Valor total</th>
                          <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal / NSU</th>
                      <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="relClienteNotasBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- POR EMPRESA -->
              <div
                class="rel-subsection hidden"
                id="relEmpresaSection"
              >
                <div class="toolbar">
                  <div class="toolbar-left">
                    <div class="form-group">
                      <label>Buscar empresa</label>
                      <input
                        type="text"
                        id="relEmpresaSearch"
                        placeholder="Nome ou CNPJ"
                      />
                    </div>
                    <div class="form-group">
                      <label>Empresa</label>
                      <select id="relEmpresaSelect">
                        <option value="">Selecione uma empresa</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Status</label>
                      <select id="relEmpresaAtivo">
                        <option value="all">Todas</option>
                        <option value="true">Ativas</option>
                        <option value="false">Inativas</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Data inicial</label>
                      <input type="date" id="relEmpresaDataIni" />
                    </div>
                    <div class="form-group">
                      <label>Data final</label>
                      <input type="date" id="relEmpresaDataFim" />
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button id="btnRelEmpresaGerar" class="btn-secondary">
                      Gerar relatÃ³rio por empresa
                    </button>
                  </div>
                </div>

                <div class="grid grid-3">
                  <div class="metric-card">
                    <div class="metric-label">Empresa</div>
                    <div class="metric-value" id="relEmpresaNome">â€”</div>
                    <div class="metric-detail" id="relEmpresaCnpj">CNPJ: â€”</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Notas no perÃ­odo</div>
                    <div class="metric-value" id="relEmpresaTotalNotas">â€”</div>
                    <div class="metric-detail">Quantidade de notas emitidas</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">Total faturado</div>
                    <div class="metric-value" id="relEmpresaValorTotal">â€”</div>
                    <div class="metric-detail">SomatÃ³rio das notas da empresa</div>
                  </div>
                </div>

                <div class="grid grid-2 rel-subsection">
                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Notas da empresa por perÃ­odo</div>
                        <div class="card-subtitle">Volume diÃ¡rio/mensal</div>
                      </div>
                    </div>
                    <canvas id="chartRelEmpresaPeriodo"></canvas>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <div>
                        <div class="card-title">Clientes desta empresa</div>
                        <div class="card-subtitle">
                          Clientes que mais emitiram por esta empresa
                        </div>
                      </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 260px">
                      <table>
                        <thead>
                          <tr>
                            <th>Cliente</th>
                            <th>Notas</th>
                            <th>Valor total</th>
                          </tr>
                        </thead>
                        <tbody id="relEmpresaClientesBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="card rel-subsection">
                  <div class="card-header">
                    <div>
                      <div class="card-title">Notas da empresa</div>
                      <div class="card-subtitle">
                        Lista completa das notas dentro do perÃ­odo
                      </div>
                    </div>
                  </div>
                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>EmissÃ£o</th>
                          <th>Cliente</th>
                          <th>Valor total</th>
                          <th>Taxa (R$)</th>
                      <th>Origem</th>
                      <th>Terminal / NSU</th>
                      <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="relEmpresaNotasBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </section>
      </main>
    </div>

    <script>

      // ==========================
      // THEME
      // ==========================
      function applyTheme(theme) {
        document.body.setAttribute("data-theme", theme);
        localStorage.setItem("nf_theme", theme);
      }

      const savedTheme = localStorage.getItem("nf_theme") || "light";
      applyTheme(savedTheme);

      function normalizeText(value) {
        const base = (value || "").toString().trim().toLowerCase();
        try {
          return base.normalize("NFD").replace(/\p{Diacritic}/gu, "");
        } catch (e) {
          return base.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
      }

      function onlyDigits(value) {
        return (value || "").toString().replace(/\D/g, "");
      }

      // ==========================
      // AUTH / API
      // ==========================
      let authToken = localStorage.getItem("nf_token") || null;
      let currentUser = null;

      async function apiFetch(path, options = {}) {
        const headers = options.headers || {};
        headers["Content-Type"] = "application/json";
        if (authToken) {
          headers["Authorization"] = "Bearer " + authToken;
        }

        const res = await fetch(path, {
          ...options,
          headers,
        });

        if (res.status === 401) {
          showLogin();
          throw new Error("NÃ£o autorizado");
        }

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Erro na API");
        }

        return res.json();
      }

      function showLogin() {
        document.getElementById("loginOverlay").style.display = "flex";
        document.getElementById("appShell").style.display = "none";
      }

      function showApp() {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("appShell").style.display = "flex";
      }

      async function doLogin() {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const errorEl = document.getElementById("loginError");
        errorEl.style.display = "none";

        try {
          const data = await apiFetch("/api/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
            headers: { "Content-Type": "application/json" },
          });

          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem("nf_token", authToken);
          localStorage.setItem("nf_user_email", currentUser.email);

          await startAppAfterAuth();
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Credenciais invÃ¡lidas.";
          errorEl.style.display = "block";
        }
      }

      async function startAppAfterAuth() {
        document.getElementById("currentUserEmail").textContent =
          currentUser?.email || localStorage.getItem("nf_user_email") || "Administrador";

        showApp();
        selectPage("dashboard");
        loadDashboard();
        const loadedClientes = await loadClientes();
        const loadedEmpresas = await loadEmpresas();
        if (typeof populateRelatorioSelects === "function") {
          populateRelatorioSelects(loadedClientes, loadedEmpresas);
        }
        await loadPosClientes();
        await loadPosCompanies();
        await loadPosTerminals();
        await loadPosVendasRecentes();
        await loadPosResumo();
        resetNotasInfiniteScroll();
        loadNotasPage(true);
        loadRelatorios();
      }

      function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem("nf_token");
        localStorage.removeItem("nf_user_email");
        showLogin();
      }

      async function tryRestoreSession() {
        if (!authToken) {
          showLogin();
          return;
        }
        try {
          currentUser = await apiFetch("/api/auth/me");
          localStorage.setItem(
            "nf_user_email",
            currentUser?.email || localStorage.getItem("nf_user_email") || "Administrador"
          );
          await startAppAfterAuth();
        } catch (err) {
          console.warn("Falha ao validar token; tentando continuar com cache:", err);
          currentUser = { email: localStorage.getItem("nf_user_email") || "Administrador" };
          try {
            await startAppAfterAuth();
          } catch {
            logout();
          }
        }
      }

      
      async function sendForgotPassword() {
        const email = document.getElementById("loginEmail").value.trim();
        const infoEl = document.getElementById("forgotInfo");
        const errorEl = document.getElementById("loginError");
        errorEl.style.display = "none";
        infoEl.style.display = "none";

        if (!email) {
          errorEl.textContent = "Informe seu e-mail para recuperar a senha.";
          errorEl.style.display = "block";
          return;
        }

        try {
          await fetch("/api/auth/forgot-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          infoEl.textContent =
            "Se o e-mail estiver cadastrado, um link de recuperaÃ§Ã£o foi enviado.";
          infoEl.style.display = "block";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Erro ao solicitar recuperaÃ§Ã£o de senha.";
          errorEl.style.display = "block";
        }
      }

      // ==========================
      // NAV / PAGES
      // ==========================
      function selectPage(page, anchor) {
        // mostra apenas a seÃ§Ã£o selecionada
        document.querySelectorAll(".page-section").forEach((sec) => sec.classList.remove("active"));
        const pageEl = document.getElementById("page-" + page);
        if (pageEl) pageEl.classList.add("active");

        // marca item ativo no menu
        document.querySelectorAll(".nav-item").forEach((item) => item.classList.remove("active"));
        document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add("active");

        // textos topbar
        const topbarTitle = document.getElementById("topbarTitle");
        const topbarSubtitle = document.getElementById("topbarSubtitle");

        if (page === "dashboard") {
          topbarTitle.textContent = "Dashboard";
          topbarSubtitle.textContent = "Visao geral das notas fiscais, clientes e empresas";
        } else if (page === "clientes") {
          topbarTitle.textContent = "Cadastro de Clientes";
          topbarSubtitle.textContent = "Clientes unicos para NF e POS com taxas condicionais";
        } else if (page === "empresas") {
          topbarTitle.textContent = "Empresas emissoras";
          topbarSubtitle.textContent = "Configuracao das empresas que podem emitir notas";
        } else if (page === "notas") {
          topbarTitle.textContent = "Notas fiscais";
          topbarSubtitle.textContent = "Listagem das notas emitidas com carregamento automatico";
        } else if (page.startsWith("pos")) {
          topbarTitle.textContent = "Maquininhas";
          topbarSubtitle.textContent = "Empresas, terminais, taxas e vendas de POS";
        } else if (page === "relatorios") {
          topbarTitle.textContent = "Relatorios";
          topbarSubtitle.textContent = "Analises consolidadas por periodo, cliente e empresa";
          populateRelatorioSelects?.();
          loadRelatorios?.();
        }

        // aÃ§Ãµes ao entrar em pÃ¡ginas
        if (page === "notas") {
          resetNotasInfiniteScroll();
          loadNotasPage(true);
        }
        if (page.startsWith("pos")) {
          // pÃ¡ginas POS independentes
          loadPosCompanies();
          loadPosTerminals();
          loadPosVendasRecentes();
          loadPosResumo();
        }
      }

      // ==========================
      // DASHBOARD / REPORTS
      // ==========================
      let chartNotasDia = null;
      let chartStatus = null;
      let chartRelPeriodo = null;
      let chartRelClientePeriodo = null;
      let chartRelEmpresaPeriodo = null;

      function formatCNPJ(cnpj) {
        const digits = (cnpj || "").replace(/\D/g, "");
        if (digits.length !== 14) return cnpj || "";
        return digits.replace(
          /(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,
          "$1.$2.$3/$4-$5"
        );
      }

      function populateRelatorioSelects(clis = clientes, emps = empresas) {
        const selCli = document.getElementById("relClienteSelect");
        const selEmp = document.getElementById("relEmpresaSelect");

        const searchCli = normalizeText(
          document.getElementById("relClienteSearch")?.value || ""
        );
        const searchCliDigits = onlyDigits(
          document.getElementById("relClienteSearch")?.value || ""
        );
        const searchEmp = normalizeText(
          document.getElementById("relEmpresaSearch")?.value || ""
        );
        const searchEmpDigits = onlyDigits(
          document.getElementById("relEmpresaSearch")?.value || ""
        );
        const empStatus = document.getElementById("relEmpresaAtivo")?.value || "all";

        const filteredClientes = (clis || [])
          .filter((c) => {
            if (!searchCli) return true;
            const term = searchCli;
            const name = normalizeText(c.name);
            const whats = normalizeText(c.whatsapp_number);
            const whatsDigits = onlyDigits(c.whatsapp_number);
            return (
              name.includes(term) ||
              whats.includes(term) ||
              (searchCliDigits && whatsDigits.includes(searchCliDigits))
            );
          });

        if (selCli) {
          selCli.innerHTML =
            '<option value="">Selecione um cliente</option>' +
            filteredClientes
              .map(
                (c) =>
                  `<option value="${c.id}">${c.name}${
                    c.whatsapp_number ? " (" + c.whatsapp_number + ")" : ""
                  }</option>`
              )
              .join("");
        }

        const filteredEmpresas = (emps || [])
          .filter((e) => {
            if (empStatus === "true") return e.is_active !== false;
            if (empStatus === "false") return e.is_active === false;
            return true;
          })
          .filter((e) => {
            if (!searchEmp) return true;
            const term = searchEmp;
            const name = normalizeText(e.name);
            const cnpj = (e.cnpj || "").replace(/\D/g, "");
            return (
              name.includes(term) ||
              (searchEmpDigits && cnpj.includes(searchEmpDigits))
            );
          });

        if (selEmp) {
          selEmp.innerHTML =
            '<option value="">Selecione uma empresa</option>' +
            filteredEmpresas
              .map(
                (e) =>
                  `<option value="${e.id}">${e.name} - ${formatCNPJ(e.cnpj)}</option>`
              )
              .join("");
        }
      }

      function formatCurrencyBRL(value) {
        return Number(value || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL"
        });
      }

      // Converte valores que podem vir como string com vÃ­rgula/ponto
      function toNumber(val) {
        if (!val) return 0;
        if (typeof val === "number") return val;
        const str = String(val).trim();
        const cleaned = str.replace(/[^\d.,-]/g, "");
        const hasComma = cleaned.includes(",");
        const hasDot = cleaned.includes(".");

        let normalized = cleaned;
        if (hasComma && hasDot) {
          // assume "." milhar e "," decimal
          normalized = cleaned.replace(/\./g, "").replace(",", ".");
        } else if (hasComma && !hasDot) {
          // apenas vÃ­rgula, usa como decimal
          normalized = cleaned.replace(",", ".");
        }
        // se sÃ³ tiver ponto, mantÃ©m
        return parseFloat(normalized) || 0;
      }

      async function loadDashboard() {
        try {
          const mesSel = Number(document.getElementById("dashMesSelect")?.value ?? new Date().getMonth());
          const anoSel = Number(document.getElementById("dashAnoInput")?.value || new Date().getFullYear());
          const start = `${anoSel}-${String(mesSel + 1).padStart(2, "0")}-01`;
          const lastDay = new Date(anoSel, mesSel + 1, 0).getDate();
          const end = `${anoSel}-${String(mesSel + 1).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;

          const params = new URLSearchParams();
          params.append("start", start);
          params.append("end", end);

          const data = await apiFetch("/api/reports/summary?" + params.toString());

          const totals = data.totals || {};
          document.getElementById("dashTotalNotas").textContent =
            totals.total_notas || 0;
          document.getElementById("dashValorTotal").textContent =
            formatCurrencyBRL(totals.soma_valor_total || 0);
          document.getElementById("dashTaxas").textContent = formatCurrencyBRL(
            totals.soma_taxas || 0
          );

          const porPeriodo = data.porPeriodo || [];
          const labelsDia = porPeriodo.map((d) => d.label);
          const valoresDia = porPeriodo.map((d) => d.total_notas);


          if (chartNotasDia) chartNotasDia.destroy();
          const ctxDia = document.getElementById("chartNotasDia").getContext("2d");
          chartNotasDia = new Chart(ctxDia, {
            type: "line",
            data: {
              labels: labelsDia,
              datasets: [
                {
                  label: "Notas",
                  data: valoresDia,
                  borderWidth: 2,
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          const porStatus = data.porStatus || [];
          if (chartStatus) chartStatus.destroy();
          const ctxStatus = document.getElementById("chartStatus").getContext("2d");
          chartStatus = new Chart(ctxStatus, {
            type: "doughnut",
            data: {
              labels: porStatus.map((s) => s.status),
              datasets: [
                {
                  data: porStatus.map((s) => s.total_notas),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "bottom" },
              },
            },
          });
        } catch (err) {
          console.error("Erro ao carregar dashboard:", err);
        }
      }

      async function loadRelatorios() {
        try {
          const start = document.getElementById("relDataIni").value;
          const end = document.getElementById("relDataFim").value;
          const group_by = document.getElementById("relGroupBy").value;

          const params = new URLSearchParams();
          if (start) params.append("start", start);
          if (end) params.append("end", end);
          params.append("group_by", group_by);

          const data = await apiFetch("/api/reports/summary?" + params.toString());

          // ------ TOTAL GERAL ------
          const porPeriodo = data.porPeriodo || [];
          const sumNotas = porPeriodo.reduce((acc, p) => acc + Number(p.total_notas || 0), 0);
          const sumValor = porPeriodo.reduce((acc, p) => acc + toNumber(p.soma_valor_total), 0);
          const sumTaxas = porPeriodo.reduce((acc, p) => acc + toNumber(p.soma_taxas), 0);

          document.getElementById("relTotalNotas").textContent = sumNotas;
          document.getElementById("relValorTotal").textContent = formatCurrencyBRL(sumValor);
          document.getElementById("relTaxasTotal").textContent = formatCurrencyBRL(sumTaxas);

          // ------ GRÃFICO POR PERÃODO ------
          if (chartRelPeriodo) chartRelPeriodo.destroy();
          const ctx = document.getElementById("chartRelPeriodo").getContext("2d");
          chartRelPeriodo = new Chart(ctx, {
            type: "bar",
            data: {
              labels: porPeriodo.map((p) => p.label),
              datasets: [
                {
                  label: "Notas",
                  data: porPeriodo.map((p) => Number(p.total_notas || 0)),
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          // ------ TOP CLIENTE ------
          const porCliente = data.porCliente || [];
          if (porCliente.length > 0) {
            const topCliente = [...porCliente].sort(
              (a, b) => Number(b.total_notas) - Number(a.total_notas)
            )[0];

            document.getElementById("relTopCliente").textContent =
              `${topCliente.name || "â€”"} â€” ${topCliente.total_notas} notas, ${formatCurrencyBRL(toNumber(topCliente.soma_valor_total))}`;
          } else {
            document.getElementById("relTopCliente").textContent = "â€”";
          }

          // ------ TOP EMPRESA ------
          const porEmpresa = data.porEmpresa || [];
          if (porEmpresa.length > 0) {
            const topEmpresa = [...porEmpresa].sort(
              (a, b) => toNumber(b.soma_valor_total) - toNumber(a.soma_valor_total)
            )[0];

            document.getElementById("relTopEmpresa").textContent =
              `${topEmpresa.name || "â€”"} â€” ${formatCurrencyBRL(toNumber(topEmpresa.soma_valor_total))} em notas`;
          } else {
            document.getElementById("relTopEmpresa").textContent = "â€”";
          }

        } catch (err) {
          console.error("Erro ao carregar relatÃ³rios:", err);
        }
      }

      // Helpers para agrupar notas por data no front
      function groupByDateForChart(notas) {
        const map = new Map();
        notas.forEach((n) => {
          if (!n.issued_at) return;
          const d = new Date(n.issued_at);
          const key = d.toISOString().slice(0, 10); // YYYY-MM-DD
          const current = map.get(key) || { total: 0, count: 0 };
          current.total += Number(n.total_amount || 0);
          current.count += 1;
          map.set(key, current);
        });
        const entries = Array.from(map.entries()).sort((a, b) =>
          a[0] < b[0] ? -1 : 1
        );
        const labels = entries.map(([k]) => {
          const d = new Date(k + "T00:00:00");
          return d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit" });
        });
        const counts = entries.map(([, v]) => v.count);
        return { labels, counts };
      }

      // RELATÃ“RIO POR CLIENTE
      // RELATÃ“RIO POR CLIENTE
      async function loadRelatorioPorCliente() {
        const select = document.getElementById("relClienteSelect");
        const id = select.value;

        // Se nÃ£o tiver cliente selecionado, apenas sai silenciosamente
        if (!id) return;

        const start = document.getElementById("relClienteDataIni").value;
        const end = document.getElementById("relClienteDataFim").value;

        const params = new URLSearchParams();
        if (start) params.append("start", start);
        if (end) params.append("end", end);

        try {
          const data = await apiFetch(`/api/reports/cliente/${id}?` + params.toString());

          const cliente = data.cliente;
          const totais = data.totais || {};
          const notas = data.notas || [];

          document.getElementById("relClienteNome").textContent =
            cliente?.name || "â€”";
          document.getElementById("relClienteWhats").textContent =
            `WhatsApp: ${cliente?.whatsapp_number || "â€”"}`;
          document.getElementById("relClienteTotalNotas").textContent =
            totais.total_notas || 0;
          document.getElementById("relClienteValorTotal").textContent =
            formatCurrencyBRL(totais.soma_valor_total || 0);
          document.getElementById("relClienteTaxasTotal").textContent =
            formatCurrencyBRL(totais.soma_taxas || 0);

          // grÃ¡fico
          const { labels, counts } = groupByDateForChart(notas);
          if (chartRelClientePeriodo) chartRelClientePeriodo.destroy();
          const ctx = document.getElementById("chartRelClientePeriodo").getContext("2d");
          chartRelClientePeriodo = new Chart(ctx, {
            type: "line",
            data: { labels, datasets: [{ label: "Notas", data: counts, tension: 0.25 }] },
            options: { responsive: true, plugins: { legend: { display: false } } },
          });

          // tabela empresas
          const empMap = new Map();
          notas.forEach((n) => {
            const nome = n.Company?.name || "â€”";
            const obj =
              empMap.get(nome) || { empresa: nome, total_notas: 0, soma_valor_total: 0 };
            obj.total_notas += 1;
            obj.soma_valor_total += Number(n.total_amount || 0);
            empMap.set(nome, obj);
          });

          const empBody = document.getElementById("relClienteEmpresasBody");
          const empRows = Array.from(empMap.values())
            .sort((a, b) => b.soma_valor_total - a.soma_valor_total)
            .map(
              (e) => `
                <tr>
                  <td>${e.empresa}</td>
                  <td>${e.total_notas}</td>
                  <td>${formatCurrencyBRL(e.soma_valor_total)}</td>
                </tr>`
            )
            .join("");
          empBody.innerHTML = empRows;

          // tabela notas
          const notasBody = document.getElementById("relClienteNotasBody");
          const notasRows = notas
            .map(
              (n) => `
              <tr>
                <td>${n.id}</td>
                <td>${n.issued_at ? new Date(n.issued_at).toLocaleString("pt-BR") : "â€”"}</td>
                <td>${n.Company?.name || "â€”"}</td>
                <td>${formatCurrencyBRL(n.total_amount)}</td>
                <td>${formatCurrencyBRL(n.fee_value)}</td>
                <td>${n.status}</td>
              </tr>`
            )
            .join("");
          notasBody.innerHTML = notasRows;

        } catch (err) {
          console.error("Erro relatÃ³rio por cliente:", err);
          // NÃƒO MOSTRA ALERTA â€” sÃ³ loga
        }
      }




      // RELATÃ“RIO POR EMPRESA
      // RELATÃ“RIO POR EMPRESA (versÃ£o corrigida)
      async function loadRelatorioPorEmpresa() {
        const select = document.getElementById("relEmpresaSelect");
        const id = select.value;

        // Se nenhuma empresa foi selecionada, apenas sai
        if (!id) return;

        const start = document.getElementById("relEmpresaDataIni").value;
        const end = document.getElementById("relEmpresaDataFim").value;

        const params = new URLSearchParams();
        if (start) params.append("start", start);
        if (end) params.append("end", end);

        try {
          const data = await apiFetch(`/api/reports/empresa/${id}?` + params.toString());

          const empresa = data.empresa;
          const totais = data.totais || {};
          const notas = data.notas || [];

          document.getElementById("relEmpresaNome").textContent =
            empresa?.name || "â€”";
          document.getElementById("relEmpresaCnpj").textContent =
            `CNPJ: ${empresa?.cnpj || "â€”"}`;

          document.getElementById("relEmpresaTotalNotas").textContent =
            totais.total_notas || 0;
          document.getElementById("relEmpresaValorTotal").textContent =
            formatCurrencyBRL(totais.soma_valor_total || 0);

          // GrÃ¡fico da empresa
          const { labels, counts } = groupByDateForChart(notas);
          if (chartRelEmpresaPeriodo) chartRelEmpresaPeriodo.destroy();

          const ctx = document
            .getElementById("chartRelEmpresaPeriodo")
            .getContext("2d");

          chartRelEmpresaPeriodo = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Notas",
                  data: counts,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          // Tabela de clientes atendidos pela empresa
          const cliMap = new Map();
          notas.forEach((n) => {
            const nome = n.Customer?.name || "â€”";
            const obj = cliMap.get(nome) || {
              cliente: nome,
              total_notas: 0,
              soma_valor_total: 0,
            };
            obj.total_notas += 1;
            obj.soma_valor_total += Number(n.total_amount || 0);
            cliMap.set(nome, obj);
          });

          const cliBody = document.getElementById("relEmpresaClientesBody");
          const cliRows = Array.from(cliMap.values())
            .sort((a, b) => b.soma_valor_total - a.soma_valor_total)
            .map(
              (c) => `
                <tr>
                  <td>${c.cliente}</td>
                  <td>${c.total_notas}</td>
                  <td>${formatCurrencyBRL(c.soma_valor_total)}</td>
                </tr>
              `
            )
            .join("");
          cliBody.innerHTML = cliRows;

          // Tabela de notas da empresa
          const notasBody = document.getElementById("relEmpresaNotasBody");
          const notasRows = notas
            .map(
              (n) => `
              <tr>
                <td>${n.id}</td>
                <td>${n.issued_at ? new Date(n.issued_at).toLocaleString("pt-BR") : "â€”"}</td>
                <td>${n.Customer?.name || "â€”"}</td>
                <td>${formatCurrencyBRL(n.total_amount)}</td>
                <td>${formatCurrencyBRL(n.fee_value)}</td>
                <td>${n.status}</td>
              </tr>
            `
            )
            .join("");
          notasBody.innerHTML = notasRows;

        } catch (err) {
          console.error("Erro relatÃ³rio por empresa:", err);
          // NÃ£o usamos alert(), para nÃ£o causar erro visual
        }
      }



      // ==========================
      // CLIENTES
      // ==========================
      let clientes = [];
      let editingClienteId = null;

      async function loadClientes() {
        try {
          const base = await apiFetch("/api/customers");
          const ratePairs = await Promise.all(
            (base || []).map(async (c) => {
              try {
                const rate = await apiFetch(`/api/pos/rates/${c.id}`);
                return [c.id, rate];
              } catch {
                return [c.id, null];
              }
            })
          );
          const rateMap = new Map(ratePairs);
          clientes = (base || []).map((c) => ({
            ...c,
            PosRate: rateMap.get(c.id) || null,
          }));
          renderClientes();
          return clientes;
        } catch (err) {
          console.error("Erro ao carregar clientes:", err);
          return [];
        }
      }

      function renderClientes() {
        const tbody = document.getElementById("clientesTableBody");
        if (!tbody) return;

        const searchRaw = document
          .getElementById("clienteSearch")
          ?.value || "";
        const search = normalizeText(searchRaw);
        const searchDigits = onlyDigits(searchRaw);
        const ativoChip = document.querySelector(
          '.chip-filter[data-cliente-ativo].active'
        );
        const ativoFilter = ativoChip ? ativoChip.dataset.clienteAtivo : "all";

        tbody.innerHTML = "";

        clientes
          .filter((c) => {
            if (
              search &&
              !(
                normalizeText(c.name).includes(search) ||
                normalizeText(c.whatsapp_number).includes(search) ||
                (searchDigits && onlyDigits(c.whatsapp_number).includes(searchDigits))
              )
            )
              return false;

            if (ativoFilter === "true" && !c.is_active) return false;
            if (ativoFilter === "false" && c.is_active) return false;

            return true;
          })
          .forEach((c) => {
            const usesNF = c.uses_nf !== false;
            const usesPOS = c.uses_pos !== false;
            const rate = c.PosRate || {};
            const nfFee = usesNF ? `${Number(c.fee_percent || 0).toFixed(2)}%` : "-";
            const deb = usesPOS ? `${Number(rate.debit_percent || 0).toFixed(2)}%` : "-";
            const credAv = usesPOS ? `${Number(rate.credit_avista_percent || 0).toFixed(2)}%` : "-";
            const cred2a6 = usesPOS ? `${Number(rate.credit_2a6_percent || 0).toFixed(2)}%` : "-";
            const cred7a12 = usesPOS ? `${Number(rate.credit_7a12_percent || 0).toFixed(2)}%` : "-";
            const pix = usesPOS ? rate.pix_key || "-" : "-";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.whatsapp_number}</td>
              <td>${usesNF ? "Sim" : "Nao"}</td>
              <td>${nfFee}</td>
              <td>${usesPOS ? "Sim" : "Nao"}</td>
              <td>${deb}</td>
              <td>${credAv}</td>
              <td>${cred2a6}</td>
              <td>${cred7a12}</td>
              <td>${pix}</td>
              <td><span class="tag ${c.is_active ? "tag-success" : "tag-muted"}">${c.is_active ? "Ativo" : "Inativo"}</span></td>
              <td>${c.created_at ? new Date(c.created_at).toLocaleString("pt-BR") : "-"}</td>
              <td>
                <button class="btn-ghost" data-edit-cliente="${c.id}">Editar</button>
                <button class="btn-danger" data-del-cliente="${c.id}">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
      }

      function updateClienteSections() {
        const geralSelect = document.getElementById("clienteAtivo");
        const nfRow = document.getElementById("clienteNfFields");
        const posRow1 = document.getElementById("clientePosFields");
        const posRow2 = document.getElementById("clientePosFields2");
        const geralAtivo = geralSelect ? geralSelect.value === "true" : true;

        // Se geral inativo, desativa NF e POS
        if (!geralAtivo) {
          if (document.getElementById("clienteUsaNF")) document.getElementById("clienteUsaNF").checked = false;
          if (document.getElementById("clienteUsaPOS")) document.getElementById("clienteUsaPOS").checked = false;
        }
        // Releitura apos possiveis ajustes
        const nfChecked = document.getElementById("clienteUsaNF")?.checked || false;
        const posChecked = document.getElementById("clienteUsaPOS")?.checked || false;

        // Se geral ativo mas nenhum serviÃ§o marcado, liga NF por padrÃ£o para permitir ativaÃ§Ã£o
        if (geralSelect && geralSelect.value === "true" && !nfChecked && !posChecked) {
          const nfToggle = document.getElementById("clienteUsaNF");
          if (nfToggle) nfToggle.checked = true;
        }
        // Se nenhum serviÃ§o estiver ativo, forÃ§a geral para inativo
        const afterNf = document.getElementById("clienteUsaNF")?.checked || false;
        const afterPos = document.getElementById("clienteUsaPOS")?.checked || false;
        if (geralSelect && !afterNf && !afterPos) {
          geralSelect.value = "false";
        }

        const showNF = document.getElementById("clienteUsaNF")?.checked;
        const showPOS = document.getElementById("clienteUsaPOS")?.checked;
        if (nfRow) nfRow.style.display = showNF ? "flex" : "none";
        if (posRow1) posRow1.style.display = showPOS ? "flex" : "none";
        if (posRow2) posRow2.style.display = showPOS ? "flex" : "none";
      }

      function resetClienteForm() {
        editingClienteId = null;
        document.getElementById("clienteNome").value = "";
        document.getElementById("clienteWhats").value = "";
        document.getElementById("clientePix").value = "";
        document.getElementById("clienteTaxa").value = "";
        document.getElementById("clienteDeb").value = "";
        document.getElementById("clienteCredAv").value = "";
        document.getElementById("clienteCred2a6").value = "";
        document.getElementById("clienteCred7a12").value = "";
        document.getElementById("clienteAtivo").value = "true";
        document.getElementById("clienteUsaNF").checked = true;
        document.getElementById("clienteUsaPOS").checked = false;
        document.getElementById("btnSaveCliente").textContent = "Salvar cliente";
        const errEl = document.getElementById("clienteFormError");
        if (errEl) errEl.style.display = "none";
        updateClienteSections();
      }

      function openClienteForm(cliente) {
        document.getElementById("clienteFormWrapper").style.display = "block";
        document.getElementById("clienteFormError").style.display = "none";

        if (cliente) {
          editingClienteId = cliente.id;
          document.getElementById("clienteNome").value = cliente.name || "";
          document.getElementById("clienteWhats").value = cliente.whatsapp_number || "";
          document.getElementById("clienteTaxa").value = cliente.fee_percent ?? "";
          document.getElementById("clienteAtivo").value = cliente.is_active
            ? "true"
            : "false";
          document.getElementById("clienteUsaNF").checked = cliente.uses_nf !== false;
          document.getElementById("clienteUsaPOS").checked = cliente.uses_pos !== false;
          document.getElementById("clientePix").value = cliente.PosRate?.pix_key || "";
          document.getElementById("clienteDeb").value = cliente.PosRate?.debit_percent ?? "";
          document.getElementById("clienteCredAv").value = cliente.PosRate?.credit_avista_percent ?? "";
          document.getElementById("clienteCred2a6").value = cliente.PosRate?.credit_2a6_percent ?? "";
          document.getElementById("clienteCred7a12").value = cliente.PosRate?.credit_7a12_percent ?? "";
          document.getElementById("btnSaveCliente").textContent = "Atualizar cliente";
          updateClienteSections();
        } else {
          resetClienteForm();
        }
      }

      function closeClienteForm() {
        resetClienteForm();
      }

      async function saveCliente() {
        const wasEditing = !!editingClienteId;
        const nome = document.getElementById("clienteNome").value.trim();
        const whats = document.getElementById("clienteWhats").value.trim();
        const taxa = document.getElementById("clienteTaxa").value.trim();
        let ativo = document.getElementById("clienteAtivo").value === "true";
        let usaNF = document.getElementById("clienteUsaNF").checked;
        let usaPOS = document.getElementById("clienteUsaPOS").checked;
        const pix = document.getElementById("clientePix").value.trim();
        const deb = document.getElementById("clienteDeb").value.trim();
        const credAv = document.getElementById("clienteCredAv").value.trim();
        const cred2a6 = document.getElementById("clienteCred2a6").value.trim();
        const cred7a12 = document.getElementById("clienteCred7a12").value.trim();
        const errEl = document.getElementById("clienteFormError");

        if (errEl) errEl.style.display = "none";

        if (!ativo) {
          usaNF = false;
          usaPOS = false;
        }
        if (ativo && !usaNF && !usaPOS) {
          ativo = false;
          const geralSel = document.getElementById("clienteAtivo");
          if (geralSel) geralSel.value = "false";
        }

        const missing = [];
        if (!nome) missing.push("nome");
        if (!whats) missing.push("WhatsApp");
        if (usaNF && taxa === "") missing.push("taxa da Nota Fiscal");
        if (usaPOS) {
          if (deb === "") missing.push("percentual de debito");
          if (credAv === "") missing.push("credito a vista");
          if (cred2a6 === "") missing.push("credito 2 a 6x");
          if (cred7a12 === "") missing.push("credito 7 a 12x");
        }

        if (missing.length) {
          const message = `Preencha os campos obrigatorios: ${missing.join(", ")}.`;
          if (errEl) {
            errEl.textContent = message;
            errEl.style.display = "block";
          }
          alert(message);
          return;
        }

        const nfFee = usaNF ? parseFloat(taxa || "0") : 0;

        const payload = {
          name: nome,
          whatsapp_number: whats,
          fee_percent: nfFee,
          is_active: ativo,
          uses_nf: usaNF,
          uses_pos: usaPOS,
        };

        try {
          if (editingClienteId) {
            await apiFetch("/api/customers/" + editingClienteId, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            const created = await apiFetch("/api/customers", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            editingClienteId = created.id;
          }

          if (usaPOS && editingClienteId) {
            await apiFetch(`/api/pos/rates/${editingClienteId}`, {
              method: "POST",
              body: JSON.stringify({
                pix_key: pix,
                debit_percent: Number(deb || 0),
                credit_avista_percent: Number(credAv || 0),
                credit_2a6_percent: Number(cred2a6 || 0),
                credit_7a12_percent: Number(cred7a12 || 0),
              }),
            });
          }
          closeClienteForm();
          const list = await loadClientes();
          await loadPosClientes();
          populateRelatorioSelects(list, empresas);
          const successMsg = wasEditing
            ? "Cliente atualizado com sucesso."
            : "Cliente criado com sucesso.";
          alert(successMsg);
        } catch (err) {
          console.error(err);
          if (errEl) {
            errEl.textContent = "Erro ao salvar cliente.";
            if (String(err.message).includes("WhatsApp")) {
              errEl.textContent =
                "Ja existe um cliente com esse numero de WhatsApp.";
            }
            errEl.style.display = "block";
          }
          alert("Erro ao salvar cliente. Verifique os dados obrigatorios.");
        }
      }

      async function deleteCliente(id) {
        if (!confirm("Deseja realmente excluir este cliente?")) return;
        try {
          await apiFetch("/api/customers/" + id, { method: "DELETE" });
          const list = await loadClientes();
          await loadPosClientes();
          populateRelatorioSelects(list, empresas);
        } catch (err) {
          console.error(err);
          alert("Erro ao excluir cliente.");
        }
      }
      // ==========================
      // EMPRESAS
      // ==========================
      let empresas = [];
      let editingEmpresaId = null;

      async function loadEmpresas() {
        try {
          empresas = await apiFetch("/api/companies");
          renderEmpresas();
          return empresas;
        } catch (err) {
          console.error("Erro ao carregar empresas:", err);
          return [];
        }
      }

      function renderEmpresas() {
        const tbody = document.getElementById("empresasTableBody");
        tbody.innerHTML = "";

        const searchRaw = document.getElementById("empresaSearch").value;
        const search = normalizeText(searchRaw);
        const searchDigits = onlyDigits(searchRaw);
        const ativoChip = document.querySelector(
          '.chip-filter[data-empresa-ativo].active'
        );
        const ativoFilter = ativoChip ? ativoChip.dataset.empresaAtivo : "all";

        empresas
          .filter((e) => {
            if (
              search &&
              !(
                normalizeText(e.name).includes(search) ||
                (searchDigits && onlyDigits(e.cnpj).includes(searchDigits))
              )
            )
              return false;
            if (ativoFilter === "true" && !e.is_active) return false;
            if (ativoFilter === "false" && e.is_active) return false;
            return true;
          })
          .forEach((e) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${e.id}</td>
              <td>${e.name}</td>
              <td>${formatCNPJ(e.cnpj)}</td>
              <td>
                <span class="tag ${
                  e.is_active ? "tag-success" : "tag-muted"
                }">${e.is_active ? "Ativa" : "Inativa"}</span>
              </td>
              <td>${e.created_at ? new Date(e.created_at).toLocaleString("pt-BR") : "â€”"}</td>
              <td>
                <button class="btn-ghost" data-edit-empresa="${e.id}">Editar</button>
                <button class="btn-danger" data-del-empresa="${e.id}">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
      }

      function openEmpresaForm(empresa) {
        document.getElementById("empresaFormWrapper").style.display = "block";
        document.getElementById("empresaFormError").style.display = "none";

        if (empresa) {
          editingEmpresaId = empresa.id;
          document.getElementById("empresaNome").value = empresa.name;
          document.getElementById("empresaCnpj").value = empresa.cnpj;
          document.getElementById("empresaChave").value = empresa.access_key;
          document.getElementById("empresaAtiva").value = empresa.is_active
            ? "true"
            : "false";
        } else {
          editingEmpresaId = null;
          document.getElementById("empresaNome").value = "";
          document.getElementById("empresaCnpj").value = "";
          document.getElementById("empresaChave").value = "";
          document.getElementById("empresaAtiva").value = "true";
        }
      }

      function closeEmpresaForm() {
        document.getElementById("empresaFormWrapper").style.display = "none";
        editingEmpresaId = null;
      }

      async function saveEmpresa() {
        const nome = document.getElementById("empresaNome").value.trim();
        const cnpj = document.getElementById("empresaCnpj").value.trim();
        const chave = document.getElementById("empresaChave").value.trim();
        const ativa = document.getElementById("empresaAtiva").value === "true";
        const errEl = document.getElementById("empresaFormError");

        errEl.style.display = "none";

        if (!nome || !cnpj || !chave) {
          errEl.textContent = "Preencha todos os campos obrigatÃ³rios.";
          errEl.style.display = "block";
          return;
        }

        const payload = {
          name: nome,
          cnpj,
          access_key: chave,
          is_active: ativa,
        };

        try {
          if (editingEmpresaId) {
            await apiFetch("/api/companies/" + editingEmpresaId, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/companies", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          closeEmpresaForm();
          const list = await loadEmpresas();
          populateRelatorioSelects(clientes, list);
        } catch (err) {
          console.error(err);
          errEl.textContent = "Erro ao salvar empresa.";
          if (String(err.message).includes("CNPJ")) {
            errEl.textContent = "JÃ¡ existe uma empresa com esse CNPJ.";
          }
          errEl.style.display = "block";
        }
      }

      async function deleteEmpresa(id) {
        if (!confirm("Deseja realmente excluir esta empresa?")) return;
        try {
          await apiFetch("/api/companies/" + id, { method: "DELETE" });
          const list = await loadEmpresas();
          populateRelatorioSelects(clientes, list);
        } catch (err) {
          console.error(err);
          alert("Erro ao excluir empresa.");
        }
      }

      // ==========================
      // NOTAS - SCROLL INFINITO
      // ==========================
      const notasState = {
        page: 1,
        limit: 50,
        loading: false,
        hasMore: true,
        observer: null,
        lastFiltersKey: "",
        allLoaded: [],
      };

      function resetNotasInfiniteScroll() {
        notasState.page = 1;
        notasState.loading = false;
        notasState.hasMore = true;
        notasState.allLoaded = [];
        document.getElementById("notasTableBody").innerHTML = "";
        document.getElementById("notasLoaderText").textContent =
          "Rolando para carregar maisâ€¦";
      }

      function getNotasFiltersKey() {
        const search = document.getElementById("notasSearch").value.trim();
        const status = document.getElementById("notasStatusFilter").value;
        const origem = document.getElementById("notasOrigemFilter").value;
        const d1 = document.getElementById("notasDataIni").value;
        const d2 = document.getElementById("notasDataFim").value;
        return JSON.stringify({ search, status, origem, d1, d2 });
      }

      async function loadNotasPage(resetIfFiltersChanged) {
        if (notasState.loading || !notasState.hasMore) return;

        const currentKey = getNotasFiltersKey();
        if (resetIfFiltersChanged && notasState.lastFiltersKey !== currentKey) {
          resetNotasInfiniteScroll();
          notasState.lastFiltersKey = currentKey;
        }

        notasState.loading = true;
        document.getElementById("notasLoaderText").textContent =
          "Carregando notas...";

        try {
          const params = new URLSearchParams();
          params.append("page", notasState.page.toString());
          params.append("limit", notasState.limit.toString());

          const res = await apiFetch("/api/invoices?" + params.toString());
          const { data, pagination } = res;

          notasState.allLoaded = notasState.allLoaded.concat(data || []);
          renderNotas();

          notasState.page += 1;
          notasState.hasMore =
            pagination && notasState.page <= pagination.pages;

          if (!notasState.hasMore) {
            document.getElementById("notasLoaderText").textContent =
              "NÃ£o hÃ¡ mais notas para carregar.";
          } else {
            document.getElementById("notasLoaderText").textContent =
              "Rolando para carregar maisâ€¦";
          }
        } catch (err) {
          console.error("Erro ao carregar notas:", err);
          document.getElementById("notasLoaderText").textContent =
            "Erro ao carregar notas.";
        } finally {
          notasState.loading = false;
        }
      }

      function renderNotas() {
        const tbody = document.getElementById("notasTableBody");
        tbody.innerHTML = "";

        const searchRaw = document.getElementById("notasSearch").value;
        const search = searchRaw.toLowerCase();
        const searchDigits = searchRaw.replace(/\D/g, "");
        const statusFilter = document.getElementById("notasStatusFilter").value;
        const origemFilter = document.getElementById("notasOrigemFilter").value;
        const dIni = document.getElementById("notasDataIni").value;
        const dFim = document.getElementById("notasDataFim").value;

        notasState.allLoaded
          .filter((n) => {
            const cliente = n.Customer?.name?.toLowerCase() || "";
            const empresa = n.Company?.name?.toLowerCase() || "";
            const comprador = n.buyer_name?.toLowerCase() || "";
            const cpfComprador = n.buyer_cpf?.toLowerCase() || "";
            const cpfDigits = (n.buyer_cpf || "").replace(/\D/g, "");

            if (
              search &&
              !(
                cliente.includes(search) ||
                empresa.includes(search) ||
                comprador.includes(search) ||
                cpfComprador.includes(search) ||
                (searchDigits && cpfDigits.includes(searchDigits))
              )
            )
              return false;

            if (statusFilter !== "all" && n.status !== statusFilter)
              return false;

            if (origemFilter === "terminal" && !n.is_terminal_sale) return false;
            if (origemFilter === "manual" && n.is_terminal_sale) return false;

            if (dIni) {
              if (
                !n.issued_at ||
                new Date(n.issued_at) < new Date(dIni + "T00:00:00")
              )
                return false;
            }

            if (dFim) {
              if (
                !n.issued_at ||
                new Date(n.issued_at) > new Date(dFim + "T23:59:59")
              )
                return false;
            }

            return true;
          })
          .forEach((n) => {
            const tr = document.createElement("tr");
            const dt = n.issued_at
              ? new Date(n.issued_at).toLocaleString("pt-BR")
              : "â€”";
            const origem = n.is_terminal_sale ? "Maquininha" : "Manual";
            const nfLink = n.nf_link
              ? `<a href="${n.nf_link}" target="_blank" rel="noopener noreferrer">Download</a>`
              : "â€”";
            const statusClass =
              n.status === "PAGA"
                ? "status-paga"
                : n.status === "CANCELADA"
                ? "status-cancelada"
                : "status-emitida";

            tr.innerHTML = `
              <td>${n.id}</td>
              <td>${dt}</td>
              <td>${n.Customer?.name || "â€”"}</td>
              <td>${n.Company?.name || "â€”"}</td>
              <td>${n.buyer_name || "â€”"}</td>
              <td>${n.buyer_cpf || "â€”"}</td>
              <td>${formatCurrencyBRL(n.total_amount)}</td>
              <td>${n.paid_amount ? formatCurrencyBRL(n.paid_amount) : "â€”"}</td>
              <td>${Number(n.fee_percent).toFixed(2)}%</td>
              <td>${formatCurrencyBRL(n.fee_value)}</td>
              <td>${origem}</td>
              <td>${n.terminal_id || "â€”"}</td>
              <td>${n.nsu || "â€”"}</td>
              <td>${nfLink}</td>
              <td><span class="status-pill ${statusClass}">${n.status}</span></td>
            `;
            tbody.appendChild(tr);
          });
      }

      function setupNotasInfiniteScroll() {
        const sentinel = document.getElementById("notasLoaderRow");
        if (!sentinel) return;

        if (notasState.observer) {
          notasState.observer.disconnect();
        }

        notasState.observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (
              entry.isIntersecting &&
              document
                .getElementById("page-notas")
                .classList.contains("active")
            ) {
              loadNotasPage(false);
            }
          });
        });

        notasState.observer.observe(sentinel);
      }

      // ==========================
      // MAQUININHAS (POS)
      // ==========================
  let posCompanies = [];
  let posTerminals = [];
  let posVendasRecentes = [];
  let posClientes = [];
  let editingPosCompanyId = null;
      let editingPosTerminalId = null;
      let editingPosClienteId = null;
      let editingPosVendaId = null;
      let posResumoList = [];
  let posResumoTotals = {
    bruto: 0,
    taxas: 0,
    liquido: 0,
    bruto_pago: 0,
    liquido_pago: 0,
    bruto_a_pagar: 0,
    liquido_a_pagar: 0,
  };
  let posSaleModalData = null;

      async function loadPosCompanies() {
        try {
          posCompanies = await apiFetch("/api/pos/companies");
          renderPosCompanies();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar empresas POS:", err);
        }
      }

      async function addPosCompany() {
        const name = document.getElementById("posCompanyName").value.trim();
        const cnpj = document.getElementById("posCompanyCnpj").value.trim();
        const is_active = document.getElementById("posCompanyAtiva").value === "true";
        if (!name || !cnpj) return alert("Informe nome e CNPJ");
        try {
          const payload = { name, cnpj, is_active };
          if (editingPosCompanyId) {
            await apiFetch(`/api/pos/companies/${editingPosCompanyId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/pos/companies", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          await loadPosCompanies();
          resetPosCompanyForm();
        } catch (err) {
          alert("Erro ao cadastrar empresa POS");
          console.error(err);
        }
      }

      function resetPosCompanyForm() {
        editingPosCompanyId = null;
        const nameInput = document.getElementById("posCompanyName");
        const cnpjInput = document.getElementById("posCompanyCnpj");
        const ativoSel = document.getElementById("posCompanyAtiva");
        if (nameInput) nameInput.value = "";
        if (cnpjInput) cnpjInput.value = "";
        if (ativoSel) ativoSel.value = "true";
        document.getElementById("btnPosAddCompany").textContent = "Salvar empresa";
      }

      function startEditPosCompany(id) {
        const company = posCompanies.find((c) => c.id == id);
        if (!company) return;
        editingPosCompanyId = company.id;
        document.getElementById("posCompanyName").value = company.name || "";
        document.getElementById("posCompanyCnpj").value = company.cnpj || "";
        document.getElementById("posCompanyAtiva").value = company.is_active ? "true" : "false";
        document.getElementById("btnPosAddCompany").textContent = "Atualizar empresa";
      }

      async function deletePosCompany(id) {
        if (!confirm("Excluir esta empresa de POS?")) return;
        try {
          await apiFetch(`/api/pos/companies/${id}`, { method: "DELETE" });
          await loadPosCompanies();
          resetPosCompanyForm();
        } catch (err) {
          alert("Erro ao excluir empresa POS");
          console.error(err);
        }
      }

      function renderPosCompanies() {
        const tbody = document.getElementById("posCompaniesTableBody");
        if (!tbody) return;
        const searchRaw = document.getElementById("posCompanySearch")?.value || "";
        const term = normalizeText(searchRaw);
        const digits = onlyDigits(searchRaw);
        const list = (posCompanies || []).filter((c) => {
          if (!term && !digits) return true;
          const name = normalizeText(c.name);
          const cnpjDigits = onlyDigits(c.cnpj);
          return name.includes(term) || (digits && cnpjDigits.includes(digits));
        });

        tbody.innerHTML = list
          .map((c) => `
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${formatCNPJ(c.cnpj)}</td>
              <td>${c.is_active ? "Ativa" : "Inativa"}</td>
              <td>
                <button class="btn-ghost" data-edit-pos-company="${c.id}">Editar</button>
                <button class="btn-danger" data-del-pos-company="${c.id}">Excluir</button>
              </td>
            </tr>
          `)
          .join("");
      }

      async function loadPosTerminals() {
        try {
          posTerminals = await apiFetch("/api/pos/terminals");
          renderPosTerminals();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar terminais:", err);
        }
      }

      async function addPosTerminal() {
        const pos_company_id = document.getElementById("posTerminalEmpresa").value;
        const customer_id = document.getElementById("posTerminalCliente").value;
        const terminal_code = document.getElementById("posTerminalCode").value.trim();
        const is_active = document.getElementById("posTerminalAtivo").value === "true";
        if (!pos_company_id || !customer_id || !terminal_code) return alert("Preencha empresa, cliente e cÃ³digo");
        try {
          const payload = { pos_company_id, customer_id, terminal_code, is_active };
          if (editingPosTerminalId) {
            await apiFetch(`/api/pos/terminals/${editingPosTerminalId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/pos/terminals", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          await loadPosTerminals();
          resetPosTerminalForm();
        } catch (err) {
          alert("Erro ao cadastrar terminal");
          console.error(err);
        }
      }

      function resetPosTerminalForm() {
        editingPosTerminalId = null;
        document.getElementById("posTerminalEmpresa").value = "";
        document.getElementById("posTerminalCliente").value = "";
        document.getElementById("posTerminalCode").value = "";
        document.getElementById("posTerminalAtivo").value = "true";
        document.getElementById("btnPosAddTerminal").textContent = "Salvar terminal";
      }

      function startEditPosTerminal(id) {
        const t = posTerminals.find((x) => x.id == id);
        if (!t) return;
        editingPosTerminalId = t.id;
        document.getElementById("posTerminalEmpresa").value = t.pos_company_id || "";
        document.getElementById("posTerminalCliente").value = t.customer_id || "";
        document.getElementById("posTerminalCode").value = t.terminal_code || "";
        document.getElementById("posTerminalAtivo").value = t.is_active ? "true" : "false";
        document.getElementById("btnPosAddTerminal").textContent = "Atualizar terminal";
      }

      async function deletePosTerminal(id) {
        if (!confirm("Excluir este terminal?")) return;
        try {
          await apiFetch(`/api/pos/terminals/${id}`, { method: "DELETE" });
          await loadPosTerminals();
          resetPosTerminalForm();
        } catch (err) {
          alert("Erro ao excluir terminal");
          console.error(err);
        }
      }

      function renderPosTerminals() {
        const tbody = document.getElementById("posTerminalsTableBody");
        if (!tbody) return;
        const searchRaw = document.getElementById("posTerminalSearch")?.value || "";
        const term = normalizeText(searchRaw);
        const digits = onlyDigits(searchRaw);
        const statusFilter = document.getElementById("posTerminalStatusFilter")?.value || "all";
        const list = (posTerminals || []).filter((t) => {
          if (!term && !digits && statusFilter === "all") return true;
          const terminalCode = normalizeText(t.terminal_code);
          const company = normalizeText(t.PosCompany?.name);
          const customer = normalizeText(t.Customer?.name);
          const cnpjDigits = onlyDigits(t.PosCompany?.cnpj);
          const matchesText =
            terminalCode.includes(term) ||
            company.includes(term) ||
            customer.includes(term) ||
            (digits && (cnpjDigits.includes(digits) || onlyDigits(t.terminal_code).includes(digits)));
          const matchesStatus =
            statusFilter === "all" ||
            (statusFilter === "true" && t.is_active) ||
            (statusFilter === "false" && !t.is_active);
          return matchesText && matchesStatus;
        });

        tbody.innerHTML = list
          .map((t) => {
            const rate = posClientes.find((c) => c.id === t.customer_id)?.PosRate || {};
            const statusTag = t.is_active
              ? '<span class="tag tag-success">Ativo</span>'
              : '<span class="tag tag-danger">Inativo</span>';
            return `
            <tr>
              <td>${t.id}</td>
              <td>${t.terminal_code}</td>
              <td>${t.PosCompany?.name || "-"}</td>
              <td>${t.Customer?.name || "-"}</td>
              <td>${statusTag}</td>
              <td>${Number(rate.debit_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_avista_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_2a6_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_7a12_percent || 0).toFixed(2)}%</td>
              <td>${rate.pix_key || "Æ’?"}</td>
              <td>
                <button class="btn-ghost" data-edit-pos-terminal="${t.id}">Editar</button>
                <button class="btn-danger" data-del-pos-terminal="${t.id}">Excluir</button>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      
        if (selCli) {
          selCli.innerHTML =
            '<option value="">Selecione</option>' +
            (posClientes || []).map((c) => `<option value="${c.id}">${c.name}${c.whatsapp_number ? " (" + c.whatsapp_number + ")" : ""}</option>`).join("");
        }
        if (selRateCli) {
          selRateCli.innerHTML =
            '<option value="">Selecione</option>' +
            (posClientes || [])
              .map((c) => `<option value="${c.id}">${c.name}</option>`)
              .join("");
        }
        if (selVendaTerm) {
          selVendaTerm.innerHTML =
            '<option value="">Selecione</option>' +
            (posTerminals || [])
              .map((t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`)
              .join("");
        }
        if (selResumoTerm) {
          selResumoTerm.innerHTML =
            '<option value="">Todos</option>' +
            (posTerminals || [])
              .map((t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`)
              .join("");
        }
      }

            terminalCode.includes(term) ||
            company.includes(term) ||
            customer.includes(term) ||
            (digits && (cnpjDigits.includes(digits) || onlyDigits(t.terminal_code).includes(digits)))
          );
        });

        tbody.innerHTML = list
          .map((t) => {
            const rate = posClientes.find((c) => c.id === t.customer_id)?.PosRate || {};
            return `
            <tr>
              <td>${t.id}</td>
              <td>${t.terminal_code}</td>
              <td>${t.PosCompany?.name || "-"}</td>
              <td>${t.Customer?.name || "-"}</td>
              <td>${t.is_active ? "Ativo" : "Inativo"}</td>
              <td>${Number(rate.debit_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_avista_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_2a6_percent || 0).toFixed(2)}%</td>
              <td>${Number(rate.credit_7a12_percent || 0).toFixed(2)}%</td>
              <td>${rate.pix_key || "â€”"}</td>
              <td>
                <button class="btn-ghost" data-edit-pos-terminal="${t.id}">Editar</button>
                <button class="btn-danger" data-del-pos-terminal="${t.id}">Excluir</button>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      function fillPosSelects() {
        const selEmp = document.getElementById("posTerminalEmpresa");
        const selCli = document.getElementById("posTerminalCliente");
        const selRateCli = document.getElementById("posRateCliente");
        const selVendaTerm = document.getElementById("posVendaTerminal");
        const selResumoTerm = document.getElementById("posResumoTerminal");
        if (selEmp) {
          selEmp.innerHTML =
            '<option value="">Selecione</option>' +
            (posCompanies || [])
              .map((c) => `<option value="${c.id}">${c.name}${c.cnpj ? " - " + formatCNPJ(c.cnpj) : ""}</option>`)
              .join("");
        }
        if (selCli) {
          selCli.innerHTML =
            '<option value="">Selecione</option>' +
            (posClientes || [])
              .map((c) => `<option value="${c.id}">${c.name}${c.whatsapp_number ? " (" + c.whatsapp_number + ")" : ""}</option>`)
              .join("");
        }
        if (selRateCli) selRateCli.innerHTML = selCli ? selCli.innerHTML : "";
        if (selVendaTerm) {
          selVendaTerm.innerHTML =
            '<option value="">Selecione</option>' +
            (posTerminals || [])
              .map(
                (t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`
              )
              .join("");
        }
        if (selResumoTerm) {
          selResumoTerm.innerHTML =
            '<option value="">Todos</option>' +
            (posTerminals || [])
              .map((t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`)
              .join("");
        }
      }

      async function loadPosRateForSelected() {
        const cid = document.getElementById("posRateCliente").value;
        if (!cid) return;
        try {
          const rate = await apiFetch(`/api/pos/rates/${cid}`);
          document.getElementById("posRatePix").value = rate?.pix_key || "";
          document.getElementById("posRateDebito").value = rate?.debit_percent || "";
          document.getElementById("posRateCreditoAVista").value = rate?.credit_avista_percent || "";
          document.getElementById("posRateCredito2a6").value = rate?.credit_2a6_percent || "";
          document.getElementById("posRateCredito7a12").value = rate?.credit_7a12_percent || "";
        } catch (err) {
          console.error("Erro ao carregar taxa:", err);
        }
      }

      async function savePosRates() {
        const cid = document.getElementById("posRateCliente").value;
        if (!cid) return alert("Selecione um cliente");
        const payload = {
          pix_key: document.getElementById("posRatePix").value.trim(),
          debit_percent: Number(document.getElementById("posRateDebito").value || 0),
          credit_avista_percent: Number(document.getElementById("posRateCreditoAVista").value || 0),
          credit_2a6_percent: Number(document.getElementById("posRateCredito2a6").value || 0),
          credit_7a12_percent: Number(document.getElementById("posRateCredito7a12").value || 0),
        };
        try {
          await apiFetch(`/api/pos/rates/${cid}`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          alert("Taxas salvas");
        } catch (err) {
          alert("Erro ao salvar taxas");
          console.error(err);
        }
      }

      async function registrarVendaPos() {
        const pos_terminal_id = document.getElementById("posVendaTerminal").value;
        const sale_datetime = document.getElementById("posVendaData").value;
        const amount = document.getElementById("posVendaValor").value;
        const payment_type = document.getElementById("posVendaForma").value;
        const nsu = document.getElementById("posVendaNsu").value.trim();
        if (!pos_terminal_id || !sale_datetime || !amount || !nsu) return alert("Preencha terminal, data, valor e NSU");
        try {
          const payload = { pos_terminal_id, sale_datetime, amount, payment_type, nsu };
          if (editingPosVendaId) {
            await apiFetch(`/api/pos/sales/${editingPosVendaId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch("/api/pos/sales", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          document.getElementById("posVendaMsg").textContent = editingPosVendaId ? "Venda atualizada" : "Venda registrada";
          document.getElementById("posVendaMsg").style.display = "block";
          await loadPosVendasRecentes();
          await loadPosResumo();
          resetPosVendaForm();
        } catch (err) {
          alert("Erro ao registrar venda");
          console.error(err);
        }
      }

      async function loadPosVendasRecentes() {
        try {
          const res = await apiFetch("/api/pos/sales?page=1&limit=50");
          posVendasRecentes = res.data || [];
          renderPosVendas();
        } catch (err) {
          console.error("Erro ao carregar vendas:", err);
        }
      }

  async function loadPosResumo() {
    try {
      const start = document.getElementById("posResumoIni").value;
      const end = document.getElementById("posResumoFim").value;
      const pos_terminal_id = document.getElementById("posResumoTerminal").value;
      const only_unpaid = document.getElementById("posResumoOnlyUnpaid").checked;

      const params = new URLSearchParams();
      if (start) params.append("start", start);
      if (end) params.append("end", end);
      if (pos_terminal_id) params.append("pos_terminal_id", pos_terminal_id);
      if (only_unpaid) params.append("only_unpaid", "true");

      const res = await apiFetch(`/api/pos/reports/payouts?${params.toString()}`);
      posResumoList = res.list || [];
      posResumoTotals = res.totals || posResumoTotals;

      document.getElementById("posResumoBruto").textContent = formatCurrencyBRL(posResumoTotals.bruto);
      document.getElementById("posResumoTaxas").textContent = formatCurrencyBRL(posResumoTotals.taxas);
      document.getElementById("posResumoLiquido").textContent = formatCurrencyBRL(posResumoTotals.liquido);
      document.getElementById("posResumoAPagar").textContent = formatCurrencyBRL(posResumoTotals.liquido_a_pagar);
      document.getElementById("posResumoPago").textContent = formatCurrencyBRL(posResumoTotals.liquido_pago);

      const top = res.topTerminal;
      const topSum = Number(top?.dataValues?.soma ?? top?.soma ?? 0);
      document.getElementById("posResumoTopTerminal").textContent = top
        ? `${top.PosTerminal?.terminal_code || "?"} - ${formatCurrencyBRL(topSum || 0)}`
        : "â€”";
      document.getElementById("posResumoTopTerminalOwner").textContent = top
        ? `ProprietÃ¡rio: ${top.PosTerminal?.Customer?.name || "â€”"}`
        : "";

      const mv = res.maiorVendaPeriodo;
      document.getElementById("posResumoMaiorVenda").textContent = mv
        ? formatCurrencyBRL(mv.amount)
        : "â€”";
      document.getElementById("posResumoMaiorVendaInfo").textContent = mv
        ? `${mv.PosTerminal?.terminal_code || "?"} - ${mv.Customer?.name || "?"}`
        : "";

      renderPosResumoTabela();

      const selResumoTerm = document.getElementById("posResumoTerminal");
      if (selResumoTerm) {
        const onlyUnpaid = document.getElementById("posResumoOnlyUnpaid").checked;
        const current = selResumoTerm.value;
        const idsSet = onlyUnpaid
          ? Array.from(new Set(posResumoList.filter((s) => !s.paid).map((s) => s.pos_terminal_id)))
          : posTerminals.map((t) => t.id);
        selResumoTerm.innerHTML =
          '<option value="">Todos</option>' +
          posTerminals
            .filter((t) => idsSet.includes(t.id))
            .map((t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`)
            .join("");
        if (idsSet.includes(Number(current))) {
          selResumoTerm.value = current;
        } else {
          selResumoTerm.value = "";
        }
      }
    } catch (err) {
      console.error("Erro ao carregar resumo POS:", err);
    }
  }

  function renderPosResumoTabela() {
    const tbody = document.getElementById("posResumoTabela");
    if (!tbody) return;
    const only_unpaid = document.getElementById("posResumoOnlyUnpaid").checked;
    const rows = posResumoList
      .filter((s) => (!only_unpaid ? true : !s.paid))
      .map(
        (s) => `
      <tr>
        <td><input type="checkbox" data-sale-id="${s.id}" class="posResumoCheck" ${s.paid ? "disabled" : ""}></td>
        <td>${s.sale_datetime ? new Date(s.sale_datetime).toLocaleString("pt-BR") : "â€”"}</td>
        <td>${s.PosTerminal?.terminal_code || "â€”"}</td>
        <td>${s.Customer?.name || "â€”"}</td>
        <td>${formatCurrencyBRL(s.amount)}</td>
        <td>${formatCurrencyBRL(s.fee_value)} (${Number(s.fee_percent || 0).toFixed(2)}%)</td>
        <td>${formatCurrencyBRL(s.net_amount)}</td>
        <td>
          <span class="tag ${s.paid ? "tag-success" : "tag-danger"}">
            ${s.paid ? "Pago" : "A pagar"}
          </span>
        </td>
        <td><button class="btn-ghost" data-view-sale="${s.id}">Ver</button></td>
      </tr>`
      )
      .join("");
    tbody.innerHTML = rows;
    const selectAll = document.getElementById("posResumoSelectAll");
    if (selectAll) selectAll.checked = false;
    updateResumoSelecionados();
  }

  function updateResumoSelecionados() {
    const checks = Array.from(document.querySelectorAll(".posResumoCheck:checked")).map((c) =>
      Number(c.getAttribute("data-sale-id"))
    );
    const selectedSales = posResumoList.filter((s) => checks.includes(s.id));
    const uniqueTerminals = new Set(selectedSales.map((s) => s.pos_terminal_id));
    const uniqueCustomers = new Set(selectedSales.map((s) => s.customer_id));
    const btn = document.getElementById("btnPosMarcarPago");
    const msg = document.getElementById("posResumoSelectMsg");
    const totalEl = document.getElementById("posResumoTotalSelecionado");
    const pixEl = document.getElementById("posResumoPix");

    const total = selectedSales.reduce((acc, s) => acc + Number(s.net_amount || 0), 0);
    if (totalEl) totalEl.textContent = formatCurrencyBRL(total);

    if (uniqueCustomers.size > 1) {
      if (btn) btn.disabled = false;
      if (msg) msg.textContent = "Clientes diferentes selecionados: confirme antes de pagar.";
    } else {
      if (btn) btn.disabled = false;
      if (msg) msg.textContent = "";
    }

    const first = selectedSales[0];
    if (first) {
      const cli = posClientes.find((c) => c.id === first.customer_id);
      if (pixEl) pixEl.textContent = cli?.PosRate?.pix_key || "â€”";
    } else {
      if (pixEl) pixEl.textContent = "â€”";
    }
  }

  async function marcarPosPagas() {
    const checks = Array.from(document.querySelectorAll(".posResumoCheck:checked"))
      .map((c) => c.getAttribute("data-sale-id"));
    if (!checks.length) {
      alert("Selecione pelo menos uma venda a pagar.");
      return;
    }
    const start = document.getElementById("posResumoIni").value;
    const end = document.getElementById("posResumoFim").value;
    const pos_terminal_id = document.getElementById("posResumoTerminal").value;
    const payment_batch =
      document.getElementById("posResumoBatch").value.trim() || `fechamento-${Date.now()}`;
    const selectedSales = posResumoList.filter((s) => checks.includes(String(s.id)));
    const uniqueCustomers = new Set(selectedSales.map((s) => s.customer_id));
    if (uniqueCustomers.size > 1) {
      const sure = confirm("Existem clientes diferentes selecionados. Confirmar pagamento assim mesmo?");
      if (!sure) return;
    }
    try {
      await apiFetch("/api/pos/reports/payouts/mark-paid", {
        method: "POST",
        body: JSON.stringify({
          sale_ids: checks,
          start,
          end,
          pos_terminal_id,
          payment_batch,
        }),
      });
      await loadPosResumo();
      alert(`Vendas marcadas como pagas. Lote: ${payment_batch}`);
    } catch (err) {
      alert("Erro ao marcar como pago");
      console.error(err);
    }
  }

  function renderPosVendas() {
    const tbody = document.getElementById("posVendasTableBody");
    if (!tbody) return;
    const searchRaw = document.getElementById("posVendaTerminalSearch")?.value || "";
    const term = normalizeText(searchRaw);
        const digits = onlyDigits(searchRaw);
    const list = (posVendasRecentes || []).filter((v) => {
      const statusFilter = document.getElementById("posVendaStatusFilter")?.value || "all";
      if (statusFilter === "paid" && !v.paid) return false;
      if (statusFilter === "unpaid" && v.paid) return false;

      if (!term && !digits) return true;
      const cliente = normalizeText(v.Customer?.name);
      const terminal = normalizeText(v.PosTerminal?.terminal_code);
      const nsu = normalizeText(v.nsu);
      const termDigits = onlyDigits(v.PosTerminal?.terminal_code);
          return (
        cliente.includes(term) ||
        terminal.includes(term) ||
        nsu.includes(term) ||
        (digits && (termDigits.includes(digits) || onlyDigits(v.nsu).includes(digits)))
      );
    });
    updateVendaTerminalOptions(searchRaw);

    tbody.innerHTML = list
      .map((v) => {
        const dt = v.sale_datetime ? new Date(v.sale_datetime).toLocaleString("pt-BR") : "â€”";
        return `
          <tr>
            <td>${dt}</td>
            <td>${v.Customer?.name || "â€”"}</td>
            <td>${v.PosTerminal?.terminal_code || "â€”"}</td>
            <td>${v.payment_type}</td>
            <td>${Number(v.fee_percent || 0).toFixed(2)}%</td>
            <td>${formatCurrencyBRL(v.amount)}</td>
            <td>${formatCurrencyBRL(v.fee_value)}</td>
            <td>${formatCurrencyBRL(v.net_amount)}</td>
            <td><span class="tag ${v.paid ? "tag-success" : "tag-danger"}">${v.paid ? "Pago" : "A pagar"}</span></td>
            <td>
              <button class="btn-ghost" data-view-sale="${v.id}">Ver</button>
              <button class="btn-ghost" data-edit-pos-sale="${v.id}">Editar</button>
              <button class="btn-danger" data-del-pos-sale="${v.id}">Excluir</button>
            </td>
          </tr>`;
      })
      .join("");
  }

  function updateVendaTerminalOptions(searchRaw = "") {
    const selVendaTerm = document.getElementById("posVendaTerminal");
    if (!selVendaTerm) return;
    const term = normalizeText(searchRaw);
    const digits = onlyDigits(searchRaw);
    const list = (posTerminals || []).filter((t) => {
      if (!term && !digits) return true;
      const name = normalizeText(t.Customer?.name);
      const code = normalizeText(t.terminal_code);
      return (
        name.includes(term) ||
        code.includes(term) ||
        (digits && onlyDigits(t.terminal_code).includes(digits))
      );
    });
    selVendaTerm.innerHTML =
      '<option value="">Selecione</option>' +
      list
        .map((t) => `<option value="${t.id}">${t.Customer?.name || "-"} - ${t.terminal_code}</option>`)
        .join("");
  }

  async function deletePosVenda(id) {
    try {
      await apiFetch(`/api/pos/sales/${id}`, { method: "DELETE" });
      await loadPosVendasRecentes();
      await loadPosResumo();
      if (editingPosVendaId === Number(id) || editingPosVendaId === id) {
        resetPosVendaForm();
      }
    } catch (err) {
      alert("Erro ao excluir venda POS");
      console.error(err);
    }
  }

  function startEditPosVenda(id) {
    const sale = posVendasRecentes.find((v) => v.id == id);
    if (!sale) return;
    editingPosVendaId = sale.id;
    document.getElementById("posVendaTerminal").value = sale.pos_terminal_id || "";
    if (sale.sale_datetime) {
      const d = new Date(sale.sale_datetime);
      const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      document.getElementById("posVendaData").value = local;
    }
    document.getElementById("posVendaValor").value = sale.amount || "";
    document.getElementById("posVendaForma").value = sale.payment_type || "DEBITO";
    document.getElementById("posVendaNsu").value = sale.nsu || "";
    document.getElementById("btnPosRegistrarVenda").textContent = "Atualizar venda";
  }

  function resetPosVendaForm() {
    editingPosVendaId = null;
    document.getElementById("posVendaTerminal").value = "";
    document.getElementById("posVendaData").value = "";
    document.getElementById("posVendaValor").value = "";
    document.getElementById("posVendaForma").value = "DEBITO";
    document.getElementById("posVendaNsu").value = "";
    document.getElementById("btnPosRegistrarVenda").textContent = "Salvar venda";
    const msg = document.getElementById("posVendaMsg");
    if (msg) {
      msg.textContent = "";
      msg.style.display = "none";
    }
  }

  function openPosSaleModal(id) {
    const sale =
      posResumoList.find((s) => s.id == id) || posVendasRecentes.find((s) => s.id == id);
    if (!sale) return;
    posSaleModalData = sale;
    const modal = document.getElementById("posSaleModal");
    const set = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };
    set("posSaleModalTitle", `Venda #${sale.id}`);
    const tag = document.getElementById("posSaleModalStatus");
    if (tag) {
      tag.className = `tag ${sale.paid ? "tag-success" : "tag-danger"}`;
      tag.textContent = sale.paid ? "Pago" : "A pagar";
    }
    set("posSaleModalData", sale.sale_datetime ? new Date(sale.sale_datetime).toLocaleString("pt-BR") : "â€”");
    set("posSaleModalTerminal", sale.PosTerminal?.terminal_code || "â€”");
    set("posSaleModalCliente", sale.Customer?.name || "â€”");
    set("posSaleModalEmpresa", sale.PosCompany?.name || "â€”");
    set("posSaleModalForma", sale.payment_type || "â€”");
    set("posSaleModalNsu", sale.nsu || "â€”");
    set("posSaleModalBruto", formatCurrencyBRL(sale.amount));
    set("posSaleModalTaxa", `${Number(sale.fee_percent || 0).toFixed(2)}% / ${formatCurrencyBRL(sale.fee_value)}`);
    set("posSaleModalLiquido", formatCurrencyBRL(sale.net_amount));
    set("posSaleModalPagoEm", sale.paid_at ? new Date(sale.paid_at).toLocaleString("pt-BR") : "â€”");
    set("posSaleModalLote", sale.payment_batch || "â€”");
    const cli = posClientes.find((c) => c.id === sale.customer_id);
    set("posSaleModalPix", cli?.PosRate?.pix_key || "â€”");
    if (modal) modal.style.display = "flex";
  }

  function closePosSaleModal() {
    const modal = document.getElementById("posSaleModal");
    if (modal) modal.style.display = "none";
    posSaleModalData = null;
  }

      async function loadPosClientes() {
        try {
          const all = await apiFetch("/api/customers");
          const onlyPos = (all || []).filter((c) => c.uses_pos !== false);
          // Busca taxas de cada cliente POS
          const rates = await Promise.all(
            onlyPos.map(async (c) => {
              try {
                const r = await apiFetch(`/api/pos/rates/${c.id}`);
                return [c.id, r];
              } catch {
                return [c.id, null];
              }
            })
          );
          const rateMap = new Map(rates);
          posClientes = onlyPos.map((c) => ({
            ...c,
            PosRate: rateMap.get(c.id) || {},
          }));
          renderPosClientes();
          fillPosSelects();
        } catch (err) {
          console.error("Erro ao carregar clientes POS:", err);
        }
      }

      function renderPosClientes() {
        const tbody = document.getElementById("posClientesTableBody");
        if (!tbody) return;
        const searchRaw = document.getElementById("posCliSearch")?.value || "";
        const term = normalizeText(searchRaw);
        const digits = onlyDigits(searchRaw);
        const list = posClientes.filter((c) => {
          if (!term && !digits) return true;
          const name = normalizeText(c.name);
          const whats = normalizeText(c.whatsapp_number);
          const whatsDigits = onlyDigits(c.whatsapp_number);
          return (
            name.includes(term) ||
            whats.includes(term) ||
            (digits && whatsDigits.includes(digits))
          );
        });

        tbody.innerHTML = list
          .map((c) => `
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.whatsapp_number}</td>
              <td>${c.uses_pos === false ? "NÃ£o" : "Sim"}</td>
              <td>${c.uses_nf ? "Sim" : "NÃ£o"}</td>
              <td>${Number(c.PosRate?.debit_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_avista_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_2a6_percent || 0).toFixed(2)}%</td>
              <td>${Number(c.PosRate?.credit_7a12_percent || 0).toFixed(2)}%</td>
              <td>${c.PosRate?.pix_key || "â€”"}</td>
              <td>
                <button class="btn-ghost" data-edit-pos-cliente="${c.id}">Editar</button>
                <button class="btn-danger" data-del-pos-cliente="${c.id}">Excluir</button>
              </td>
            </tr>`)
          .join("");
      }

      async function savePosCliente() {
        const name = document.getElementById("posCliNome").value.trim();
        const whatsapp_number = document.getElementById("posCliWhats").value.trim();
        const pix_key = document.getElementById("posCliPix").value.trim();
        const debit_percent = Number(document.getElementById("posCliDeb").value || 0);
        const credit_avista_percent = Number(document.getElementById("posCliCredAv").value || 0);
        const credit_2a6_percent = Number(document.getElementById("posCliCred2a6").value || 0);
        const credit_7a12_percent = Number(document.getElementById("posCliCred7a12").value || 0);
        const uses_pos = document.getElementById("posCliAtivo").checked;
        const uses_nf = document.getElementById("posCliUsaNF").checked;

        if (!name || !whatsapp_number) {
          alert("Informe nome e WhatsApp");
          return;
        }

        try {
          let customerId = editingPosClienteId;
          const payload = {
            name,
            whatsapp_number,
            fee_percent: 0,
            is_active: uses_pos,
            uses_nf,
            uses_pos,
          };

          if (editingPosClienteId) {
            await apiFetch(`/api/customers/${editingPosClienteId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            const created = await apiFetch("/api/customers", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            customerId = created.id;
          }

          await apiFetch(`/api/pos/rates/${customerId}`, {
            method: "POST",
            body: JSON.stringify({
              pix_key,
              debit_percent,
              credit_avista_percent,
              credit_2a6_percent,
              credit_7a12_percent,
            }),
          });

          await loadPosClientes();
          resetPosClienteForm();
          alert("Cliente POS salvo");
        } catch (err) {
          alert("Erro ao salvar cliente POS (WhatsApp deve ser unico)");
          console.error(err);
        }
      }

      function resetPosClienteForm() {
        editingPosClienteId = null;
        document.getElementById("posCliNome").value = "";
        document.getElementById("posCliWhats").value = "";
        document.getElementById("posCliPix").value = "";
        document.getElementById("posCliAtivo").checked = true;
        document.getElementById("posCliUsaNF").checked = false;
        document.getElementById("posCliDeb").value = "";
        document.getElementById("posCliCredAv").value = "";
        document.getElementById("posCliCred2a6").value = "";
        document.getElementById("posCliCred7a12").value = "";
        document.getElementById("btnPosSalvarCliente").textContent = "Salvar cliente";
      }

      function startEditPosCliente(id) {
        const cli = posClientes.find((c) => c.id == id);
        if (!cli) return;
        editingPosClienteId = cli.id;
        document.getElementById("posCliNome").value = cli.name || "";
        document.getElementById("posCliWhats").value = cli.whatsapp_number || "";
        document.getElementById("posCliPix").value = cli.PosRate?.pix_key || "";
        document.getElementById("posCliAtivo").checked = cli.uses_pos !== false;
        document.getElementById("posCliUsaNF").checked = !!cli.uses_nf;
        document.getElementById("posCliDeb").value = cli.PosRate?.debit_percent ?? "";
        document.getElementById("posCliCredAv").value = cli.PosRate?.credit_avista_percent ?? "";
        document.getElementById("posCliCred2a6").value = cli.PosRate?.credit_2a6_percent ?? "";
        document.getElementById("posCliCred7a12").value = cli.PosRate?.credit_7a12_percent ?? "";
        document.getElementById("btnPosSalvarCliente").textContent = "Atualizar cliente";
      }

      async function deletePosCliente(id) {
        if (!confirm("Excluir este cliente?")) return;
        try {
          await apiFetch(`/api/customers/${id}`, { method: "DELETE" });
          await loadPosClientes();
          resetPosClienteForm();
        } catch (err) {
          alert("Erro ao excluir cliente POS");
          console.error(err);
        }
      }

  // ==========================
  // EVENTOS GERAIS
  // ==========================
  document.addEventListener("DOMContentLoaded", () => {
        // Theme
        document
          .getElementById("btnThemeToggle")
          .addEventListener("click", () => {
            const current = document.body.getAttribute("data-theme");
            applyTheme(current === "dark" ? "light" : "dark");
          });
        // Dashboard perÃ­odo padrÃ£o (mÃªs atual)
        const now = new Date();
        const dashMesSel = document.getElementById("dashMesSelect");
        const dashAnoInput = document.getElementById("dashAnoInput");
        if (dashMesSel) dashMesSel.value = String(now.getMonth());
        if (dashAnoInput) dashAnoInput.value = String(now.getFullYear());
        document.getElementById("dashAplicarMes")?.addEventListener("click", (e) => {
          e.preventDefault();
          loadDashboard();
        });
        document.getElementById("dashMesAtual")?.addEventListener("click", (e) => {
          e.preventDefault();
          const n = new Date();
          if (dashMesSel) dashMesSel.value = String(n.getMonth());
          if (dashAnoInput) dashAnoInput.value = String(n.getFullYear());
          loadDashboard();
        });

        // Login
        document.getElementById("btnLogin").addEventListener("click", doLogin);
        document
          .getElementById("loginPassword")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter") doLogin();
          });
        document
          .getElementById("forgotPasswordLink")
          .addEventListener("click", sendForgotPassword);

        // Logout
        document
          .getElementById("btnLogout")
          .addEventListener("click", logout);

        // Sidebar nav
        document.querySelectorAll(".nav-item[data-page]").forEach((item) => {
          item.addEventListener("click", () => {
            const anchor = item.getAttribute("data-anchor");
            selectPage(item.dataset.page, anchor);
            if (window.innerWidth <= 900) {
              document.getElementById("sidebar").classList.remove("open");
              document
                .getElementById("sidebarBackdrop")
                .classList.remove("show");
            }
          });
        });

        // Mobile sidebar
        document
          .getElementById("btnMobileMenu")
          .addEventListener("click", () => {
            document.getElementById("sidebar").classList.add("open");
            document
              .getElementById("sidebarBackdrop")
              .classList.add("show");
          });
        document
          .getElementById("sidebarBackdrop")
          .addEventListener("click", () => {
            document.getElementById("sidebar").classList.remove("open");
            document
              .getElementById("sidebarBackdrop")
              .classList.remove("show");
          });

        // POS eventos
        document.getElementById("btnPosSalvarCliente")?.addEventListener("click", savePosCliente);
        document.getElementById("btnPosAddCompany")?.addEventListener("click", addPosCompany);
        document.getElementById("btnPosAddTerminal")?.addEventListener("click", addPosTerminal);
        document.getElementById("btnPosSalvarTaxas")?.addEventListener("click", savePosRates);
        document.getElementById("btnPosRegistrarVenda")?.addEventListener("click", registrarVendaPos);
        document.getElementById("btnPosCarregarResumo")?.addEventListener("click", loadPosResumo);
        document.getElementById("posRateCliente")?.addEventListener("change", loadPosRateForSelected);
        document.getElementById("posResumoTabela")?.addEventListener("change", (e) => {
          if (e.target.classList.contains("posResumoCheck")) updateResumoSelecionados();
        });
        document.getElementById("posResumoTabela")?.addEventListener("click", (e) => {
          const viewId = e.target.getAttribute("data-view-sale");
          if (viewId) {
            openPosSaleModal(viewId);
          }
        });
        document.getElementById("posResumoSelectAll")?.addEventListener("change", (e) => {
          const checked = e.target.checked;
          document.querySelectorAll(".posResumoCheck").forEach((c) => {
            if (!c.disabled) c.checked = checked;
          });
          updateResumoSelecionados();
        });
        document.getElementById("btnPosLimparResumo")?.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("posResumoIni").value = "";
          document.getElementById("posResumoFim").value = "";
          document.getElementById("posResumoTerminal").value = "";
          document.getElementById("posResumoOnlyUnpaid").checked = false;
          document.querySelectorAll(".posResumoCheck").forEach((c) => {
            if (!c.disabled) c.checked = false;
          });
          updateResumoSelecionados();
          loadPosResumo();
        });
        document.getElementById("btnPosLimparResumo")?.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("posResumoIni").value = "";
          document.getElementById("posResumoFim").value = "";
          document.getElementById("posResumoTerminal").value = "";
          document.getElementById("posResumoOnlyUnpaid").checked = false;
          document.querySelectorAll(".posResumoCheck").forEach((c) => {
            if (!c.disabled) c.checked = false;
          });
          updateResumoSelecionados();
          loadPosResumo();
        });
        document.getElementById("btnPosMarcarPago")?.addEventListener("click", (e) => {
          e.preventDefault();
          marcarPosPagas();
        });
        document.getElementById("posResumoOnlyUnpaid")?.addEventListener("change", loadPosResumo);
        document.getElementById("posResumoTerminal")?.addEventListener("change", loadPosResumo);
        document.getElementById("posCompanySearch")?.addEventListener("input", renderPosCompanies);
        document.getElementById("posTerminalSearch")?.addEventListener("input", renderPosTerminals);
        document.getElementById("posTerminalStatusFilter")?.addEventListener("change", renderPosTerminals);
        document.getElementById("posCliSearch")?.addEventListener("input", renderPosClientes);
        document.getElementById("posVendaTerminalSearch")?.addEventListener("input", renderPosVendas);
        document.getElementById("posVendaStatusFilter")?.addEventListener("change", renderPosVendas);
        document.getElementById("btnPosLimparCompany")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosCompanyForm();
        });
        document.getElementById("btnPosLimparTerminal")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosTerminalForm();
        });
        document.getElementById("btnPosNovoCliente")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosClienteForm();
        });
        document.getElementById("btnPosLimparVenda")?.addEventListener("click", (e) => {
          e.preventDefault();
          resetPosVendaForm();
        });
        document.getElementById("posCompaniesTableBody")?.addEventListener("click", (e) => {
          const editId = e.target.getAttribute("data-edit-pos-company");
          const delId = e.target.getAttribute("data-del-pos-company");
          if (editId) {
            startEditPosCompany(editId);
          } else if (delId && confirm("Excluir empresa?")) {
            deletePosCompany(delId);
          }
        });
        document.getElementById("posTerminalsTableBody")?.addEventListener("click", (e) => {
          const editId = e.target.getAttribute("data-edit-pos-terminal");
          const delId = e.target.getAttribute("data-del-pos-terminal");
          if (editId) {
            startEditPosTerminal(editId);
          } else if (delId && confirm("Excluir terminal?")) {
            deletePosTerminal(delId);
          }
        });
        document.getElementById("posClientesTableBody")?.addEventListener("click", (e) => {
          const editId = e.target.getAttribute("data-edit-pos-cliente");
          const delId = e.target.getAttribute("data-del-pos-cliente");
          if (editId) {
            startEditPosCliente(editId);
          } else if (delId && confirm("Excluir cliente?")) {
            deletePosCliente(delId);
          }
        });
        document.getElementById("posVendasTableBody")?.addEventListener("click", (e) => {
          const editId = e.target.getAttribute("data-edit-pos-sale");
          const delId = e.target.getAttribute("data-del-pos-sale");
          const viewId = e.target.getAttribute("data-view-sale");
          if (editId) {
            startEditPosVenda(editId);
          } else if (viewId) {
            openPosSaleModal(viewId);
          } else if (delId && confirm("Excluir venda?")) {
            deletePosVenda(delId);
          }
        });
        document.getElementById("posSaleModalClose")?.addEventListener("click", closePosSaleModal);
        document.getElementById("posSaleModal")?.addEventListener("click", (e) => {
          if (e.target.id === "posSaleModal") closePosSaleModal();
        });

        // Clientes
        document
          .getElementById("btnAddCliente")
          .addEventListener("click", () => resetClienteForm());
        document
          .getElementById("btnSaveCliente")
          .addEventListener("click", saveCliente);
        document.getElementById("clienteUsaNF")?.addEventListener("change", updateClienteSections);
        document.getElementById("clienteUsaPOS")?.addEventListener("change", updateClienteSections);
        document.getElementById("clienteAtivo")?.addEventListener("change", updateClienteSections);

        document
          .getElementById("clienteSearch")
          .addEventListener("input", renderClientes);
        document
          .querySelectorAll(".chip-filter[data-cliente-ativo]")
          .forEach((el) => {
            el.addEventListener("click", () => {
              document
                .querySelectorAll(".chip-filter[data-cliente-ativo]")
                .forEach((c) => c.classList.remove("active"));
              el.classList.add("active");
              renderClientes();
            });
          });

        updateClienteSections();

        document
          .getElementById("clientesTableBody")
          .addEventListener("click", (e) => {
            const editId = e.target.getAttribute("data-edit-cliente");
            const delId = e.target.getAttribute("data-del-cliente");
            if (editId) {
              const c = clientes.find((x) => x.id == editId);
              if (c) openClienteForm(c);
            } else if (delId) {
              deleteCliente(delId);
            }
          });

        // Empresas
        document
          .getElementById("btnAddEmpresa")
          .addEventListener("click", () => openEmpresaForm(null));
        document
          .getElementById("btnCancelEmpresa")
          .addEventListener("click", closeEmpresaForm);
        document
          .getElementById("btnSaveEmpresa")
          .addEventListener("click", saveEmpresa);

        document
          .getElementById("empresaSearch")
          .addEventListener("input", renderEmpresas);
        document
          .getElementById("relClienteSearch")
          ?.addEventListener("input", () => populateRelatorioSelects());
        document
          .getElementById("relEmpresaSearch")
          ?.addEventListener("input", () => populateRelatorioSelects());
        document
          .getElementById("relEmpresaAtivo")
          ?.addEventListener("change", () => populateRelatorioSelects());
        document
          .querySelectorAll(".chip-filter[data-empresa-ativo]")
          .forEach((el) => {
            el.addEventListener("click", () => {
              document
                .querySelectorAll(".chip-filter[data-empresa-ativo]")
                .forEach((c) => c.classList.remove("active"));
              el.classList.add("active");
              renderEmpresas();
            });
          });

        document
          .getElementById("empresasTableBody")
          .addEventListener("click", (e) => {
            const editId = e.target.getAttribute("data-edit-empresa");
            const delId = e.target.getAttribute("data-del-empresa");
            if (editId) {
              const emp = empresas.find((x) => x.id == editId);
              if (emp) openEmpresaForm(emp);
            } else if (delId) {
              deleteEmpresa(delId);
            }
          });

        // POS (Maquininhas)
        document.getElementById("btnPosAddCompany")?.addEventListener("click", addPosCompany);
        document.getElementById("btnPosAddTerminal")?.addEventListener("click", addPosTerminal);
        document.getElementById("btnPosSalvarTaxas")?.addEventListener("click", savePosRates);
        document.getElementById("posRateCliente")?.addEventListener("change", loadPosRateForSelected);
        document.getElementById("btnPosRegistrarVenda")?.addEventListener("click", registrarVendaPos);
        document.getElementById("btnPosCarregarResumo")?.addEventListener("click", loadPosResumo);

        // Notas
        setupNotasInfiniteScroll();
        document
          .getElementById("notasSearch")
          .addEventListener("input", () => renderNotas());
        document
          .getElementById("notasStatusFilter")
          .addEventListener("change", () => renderNotas());
        document
          .getElementById("notasOrigemFilter")
          .addEventListener("change", () => renderNotas());
        document
          .getElementById("notasApplyFilters")
          .addEventListener("click", () => {
            resetNotasInfiniteScroll();
            notasState.lastFiltersKey = getNotasFiltersKey();
            loadNotasPage(false);
          });

        // RelatÃ³rios - tabs
        function setRelTab(tab) {
          document
            .querySelectorAll(".tab-button")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".rel-subsection")
            .forEach((s) => s.classList.add("hidden"));

          if (tab === "geral") {
            document.getElementById("tabRelGeral").classList.add("active");
            document.getElementById("relGeralSection").classList.remove("hidden");
            loadRelatorios();
          } else if (tab === "cliente") {
            document.getElementById("tabRelCliente").classList.add("active");
            document
              .getElementById("relClienteSection")
              .classList.remove("hidden");
            populateRelatorioSelects();
          } else if (tab === "empresa") {
            document.getElementById("tabRelEmpresa").classList.add("active");
            document
              .getElementById("relEmpresaSection")
              .classList.remove("hidden");
            populateRelatorioSelects();
          }
        }

        document
          .getElementById("tabRelGeral")
          .addEventListener("click", () => setRelTab("geral"));
        document
          .getElementById("tabRelCliente")
          .addEventListener("click", () => setRelTab("cliente"));
        document
          .getElementById("tabRelEmpresa")
          .addEventListener("click", () => setRelTab("empresa"));

        document
          .getElementById("btnReloadReports")
          .addEventListener("click", loadRelatorios);
        document
          .getElementById("btnRelClienteGerar")
          .addEventListener("click", () => loadRelatorioPorCliente(true));
        document
          .getElementById("btnRelEmpresaGerar")
          .addEventListener("click", () => loadRelatorioPorEmpresa(true));

        // Se ja tiver token salvo, tenta restaurar a sessao
        tryRestoreSession();
      });



</script>
    <div id="posSaleModal" class="modal-overlay" style="display:none">
      <div class="modal-card">
        <div class="modal-header">
          <div>
            <div id="posSaleModalStatus" class="tag" style="margin-bottom:6px"></div>
            <h3 id="posSaleModalTitle" style="margin:0">Venda</h3>
          </div>
          <button class="btn-ghost" id="posSaleModalClose">Fechar</button>
        </div>
        <div class="modal-grid">
          <div class="modal-field"><label>Data</label><div class="value" id="posSaleModalData">â€”</div></div>
          <div class="modal-field"><label>Terminal</label><div class="value" id="posSaleModalTerminal">â€”</div></div>
          <div class="modal-field"><label>Cliente</label><div class="value" id="posSaleModalCliente">â€”</div></div>
          <div class="modal-field"><label>Empresa</label><div class="value" id="posSaleModalEmpresa">â€”</div></div>
          <div class="modal-field"><label>Forma</label><div class="value" id="posSaleModalForma">â€”</div></div>
          <div class="modal-field"><label>NSU</label><div class="value" id="posSaleModalNsu">â€”</div></div>
          <div class="modal-field"><label>Bruto</label><div class="value" id="posSaleModalBruto">â€”</div></div>
          <div class="modal-field"><label>Taxa (%/R$)</label><div class="value" id="posSaleModalTaxa">â€”</div></div>
          <div class="modal-field"><label>LÃ­quido</label><div class="value" id="posSaleModalLiquido">â€”</div></div>
          <div class="modal-field"><label>Pago em</label><div class="value" id="posSaleModalPagoEm">â€”</div></div>
          <div class="modal-field"><label>Lote pagamento</label><div class="value" id="posSaleModalLote">â€”</div></div>
          <div class="modal-field"><label>PIX do cliente</label><div class="value" id="posSaleModalPix">â€”</div></div>
        </div>
      </div>
    </div>
  </body>
</html>














